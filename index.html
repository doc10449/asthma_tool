<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ - ç©©å®šå„²å­˜ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f2f2f7;
            color: #1c1c1e;
            font-size: 15px;
        }
        .app-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            border: 1px solid #e5e5ea;
            overflow: hidden;
        }
        .list-row {
            padding: 12px 16px;
            border-bottom: 0.5px solid #e5e5ea;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .list-row:last-child { border-bottom: none; }
        .list-row input:not([type="checkbox"]), .list-row select, .list-row textarea {
            border: 1px solid #d1d1d6 !important;
            padding: 10px 12px !important;
            background-color: white !important;
            border-radius: 6px !important;
            font-size: 16px;
            color: #1c1c1e !important;
        }
        /* å¼·åŒ–æ¨™é¡Œ */
        .medication-label-strong { font-weight: 600; color: #1c1c1e; display: block; margin-bottom: 4px; }
        /* é¡è‰²å€åŸŸ */
        .zone-green { background-color: #34c759; color: white; border-radius: 8px; padding: 12px; }
        .zone-yellow { background-color: #ff9500; color: white; border-radius: 8px; padding: 12px; }
        .zone-red { background-color: #ff3b30; color: white; border-radius: 8px; padding: 12px; }
        /* é¡è‰²ç‹€æ…‹é¡ï¼šåƒ…å½±éŸ¿å­—é«”é¡è‰² */
        .input-field-loaded { color: #9ca3af !important; }
        .input-field-edited { color: #1c1c1e !important; }
        #chart-container { max-width: 100%; overflow-x: auto; min-height: 250px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .collapsible-content.expanded { max-height: 5000px; transition: max-height 0.6s ease-in; }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="app" class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ</h1>
        <h2 class="text-base text-gray-600 mb-6 border-b pb-2 font-medium">ä¸‰è»ç¸½é†«é™¢ èƒ¸è…”å…§ç§‘</h2>

        <div id="profile-section">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 ml-2">I. å€‹äººè³‡è¨Šèˆ‡é†«ç™‚è¯çµ¡æ–¹å¼</h2>
            <form id="profile-form">
                <div class="app-card list-container">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å§“å:</label>
                            <input type="text" id="profile-name" required class="block w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥:</label>
                            <input type="date" id="profile-dob" class="block w-full">
                        </div>
                    </div>
                    <div class="list-row bg-indigo-50 border-indigo-200">
                        <p class="font-medium">é ä¼°å¹´é½¡: <span id="calculated-age" class="font-semibold text-indigo-800">æœªè¼¸å…¥</span></p>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç—…æ­·è™Ÿ:</label>
                            <input type="text" id="medical-record-number" required placeholder="ä¾‹å¦‚: 1234567" class="block w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ä¸»æ²»é†«å¸«:</label>
                            <input type="text" id="attending-physician" placeholder="ä¾‹å¦‚: ç‹å°æ˜é†«å¸«" class="block w-full">
                        </div>
                    </div>
                    <div class="list-row">
                        <label class="block text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡é›»è©±:</label>
                        <input type="tel" id="emergency-phone" class="block w-full">
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg mt-2 shadow-md">å„²å­˜å€‹äººè³‡æ–™</button>
            </form>
        </div>

        <div id="setup-section" class="mt-8">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 ml-2">II. å€‹äººæœ€ä½³å°–å³°å‘¼æ°£æµé€Ÿå€¼ (Personal Best, PB)</h2>
            <div class="app-card list-container p-4">
                <p class="text-sm text-gray-700 mb-3">ç›®å‰åŸºæº– PEF: <span class="font-bold text-lg text-blue-600" id="pb-value">æœªè¨­å®š</span> L/min</p>
                <div class="flex items-center space-x-3">
                    <input type="number" id="pb-pef-input" placeholder="è¼¸å…¥ PB å€¼" class="flex-grow p-2 border rounded-lg h-12">
                    <button type="button" id="save-pb-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md whitespace-nowrap">å„²å­˜åŸºæº–</button>
                </div>
            </div>
        </div>

        <div id="action-plan-guide" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">III. æ°£å–˜æƒ¡åŒ–æ‡‰å°æŒ‡å— ğŸš¨</h2>
            <div class="app-card p-4 space-y-4">
                <div class="zone-green">
                    <h3 class="text-lg font-bold">ğŸŸ¢ ç¶ ç‡ˆå€ â€” æƒ…æ³è‰¯å¥½</h3>
                    <p class="text-sm">PEF è®€æ•¸: <span id="pef-green-range">PB çš„ 80% ~ 100%</span></p>
                </div>
                <div class="zone-yellow">
                    <h3 class="text-lg font-bold">ğŸŸ¡ é»ƒç‡ˆå€ â€” å°å¿ƒæƒ¡åŒ–</h3>
                    <p class="text-sm">PEF è®€æ•¸: <span id="pef-yellow-range">PB çš„ 50% ~ 80%</span></p>
                </div>
                <div class="zone-red">
                    <h3 class="text-lg font-bold">ğŸ”´ ç´…ç‡ˆå€ â€” åš´é‡ç™¼ä½œï¼</h3>
                    <p class="text-sm">PEF è®€æ•¸: <span id="pef-red-range">ä½æ–¼ PB çš„ 50%</span></p>
                    <p class="mt-2">ç·Šæ€¥è¯çµ¡: <span class="font-bold h-6" id="emergency-contact-display">æœªè¨˜éŒ„</span></p>
                </div>
            </div>
        </div>

        <div id="medication-section" class="mt-8">
            <h2 class="text-xl font-semibold text-purple-700 mb-3 ml-2">IV. è—¥ç‰©æ¸…å–®èˆ‡ä½¿ç”¨æ–¹å¼</h2>
            <form id="medication-form">
                <div class="app-card list-container">
                    <div class="list-row no-border-bottom">
                        <label class="medication-label-strong">é•·æœŸæ§åˆ¶è—¥ç‰© (ä¿é¤Šè—¥ç‰©)</label>
                        <input type="text" id="controller-meds" list="controller-meds-list" class="block w-full">
                        <datalist id="controller-meds-list">
                            <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER">
                            <option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">
                            <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER">
                            <option value="è‚ºèˆ’å¦ FOSTER NEXHALER">
                            <option value="æ½¤å¨ƒ RELVAR ELLIPTA">
                            <option value="ä¿è¡›åº· ALVESCO INHALER">
                            <option value="è‚ºæ¨‚å–œ TRELEGY ELLIPTA">
                        </datalist>
                        <select id="controller-freq" class="block w-full mt-2">
                            <option value="">é¸æ“‡é »ç‡</option>
                            <option value="åƒ…éœ€è¦æ™‚ä½¿ç”¨">åƒ…éœ€è¦æ™‚ä½¿ç”¨</option>
                            <option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option>
                            <option value="æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡">æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡</option>
                            <option value="æ¯æ—¥æ—©æ™šå„äºŒæ¬¡">æ¯æ—¥æ—©æ™šå„äºŒæ¬¡</option>
                        </select>
                    </div>
                    <div class="list-row no-border-bottom">
                        <label class="medication-label-strong">é¡å¤–ä¿é¤Šè—¥ç‰©</label>
                        <input type="text" id="extra-controller-meds" list="extra-controller-meds-list" class="block w-full">
                        <datalist id="extra-controller-meds-list">
                            <option value="é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)">
                            <option value="è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA">
                        </datalist>
                        <select id="extra-controller-freq" class="block w-full mt-2">
                            <option value="">é¸æ“‡é »ç‡</option>
                            <option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option>
                        </select>
                    </div>
                    <div class="list-row">
                        <label class="medication-label-strong">é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘è—¥)</label>
                        <input type="text" id="reliever-meds-input" list="reliever-meds-list" class="block w-full">
                        <datalist id="reliever-meds-list">
                            <option value="åŒä¿é¤Šè—¥ç‰©">
                            <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER">
                            <option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">
                            <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER">
                            <option value="è‚ºèˆ’å¦ FOSTER NEXHALER">
                            <option value="å‚™å–˜å…¨ BERODUAL N MDI">
                            <option value="å‚™å‹å–˜ BEROTECL N MDI">
                        </datalist>
                        <select id="reliever-freq-select" class="block w-full mt-2">
                            <option value="éœ€è¦æ™‚ä½¿ç”¨">éœ€è¦æ™‚ä½¿ç”¨</option>
                            <option value="ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º">ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow-md">å„²å­˜ç”¨è—¥è¨ˆç•«</button>
            </form>
        </div>

        <div id="log-section" class="hidden mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">VI. è‡ªæˆ‘ç›£æ¸¬ç´€éŒ„ (æ¯æ—¥è¨˜éŒ„)</h2>
            <form id="asthma-log-form" class="app-card p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">æ—©æ™¨ PEF:</label>
                        <input type="number" id="pef-morning" class="block w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">æ™šé–“ PEF:</label>
                        <input type="number" id="pef-evening" class="block w-full">
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md">å­˜æª”ä¸¦è©•ä¼°</button>
            </form>
        </div>

        <div class="mt-8 p-4 bg-white rounded-lg border text-xs text-gray-500 text-center">
            æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="last-updated-display">--</span>
        </div>
    </div>

    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 opacity-0" style="display: none; z-index: 9999;"></div>

    <script>
        // å…¨åŸŸé…ç½®
        const DEFAULT_EMERGENCY_PHONE = '0287923311#10121';
        const CONTROLLER_MEDS_FREQ = { "å¸å¿…æ“´ SYMBICORT TURBUHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "å¸å¿…æ“´ SYMBICORT RAPIHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "è‚ºèˆ’å¦ FOSTER MDI INHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "è‚ºèˆ’å¦ FOSTER NEXHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "æ½¤å¨ƒ RELVAR ELLIPTA": "æ¯æ—¥ä¸€æ¬¡", "ä¿è¡›åº· ALVESCO INHALER": "æ¯æ—¥ä¸€æ¬¡", "è‚ºæ¨‚å–œ TRELEGY ELLIPTA": "æ¯æ—¥ä¸€æ¬¡" };
        const EXTRA_CONTROLLER_MEDS_FREQ = { "é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)": "æ¯æ—¥ä¸€æ¬¡", "è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA": "æ¯æ—¥ä¸€æ¬¡" };

        let personalBestPEF = null;
        let medicationPlan = {};

        // è¨Šæ¯é¡¯ç¤º
        function showMessage(msg, type = 'info') {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.style.display = 'block';
            box.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            setTimeout(() => box.style.opacity = '1', 10);
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.style.display = 'none', 300);
            }, 3000);
        }

        // å„²å­˜è‡³ LocalStorage
        function saveLocal(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // è®€å– LocalStorage
        function loadLocal(key, defaultVal = {}) {
            const val = localStorage.getItem(key);
            return val ? JSON.parse(val) : defaultVal;
        }

        // æ ¸å¿ƒåŠŸèƒ½ï¼šå„²å­˜ PB åŸºç¤å€¼ (åŠ å¼·ç‰ˆ)
        function savePB(e) {
            if (e) e.preventDefault();
            const input = document.getElementById('pb-pef-input');
            const val = parseInt(input.value);

            if (isNaN(val) || val <= 0) {
                showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„ PEF æ•¸å€¼", "error");
                return;
            }

            personalBestPEF = val;
            saveLocal('asthma_pb', { personalBestPEF: val, updatedAt: Date.now() });
            
            document.getElementById('pb-value').textContent = val;
            document.getElementById('log-section').classList.remove('hidden');
            updateActionPlanRanges(val);
            showMessage("PB åŸºç¤å€¼å·²å„²å­˜", "success");
        }

        function updateActionPlanRanges(pb) {
            const green = Math.ceil(pb * 0.8);
            const yellow = Math.ceil(pb * 0.5);
            document.getElementById('pef-green-range').textContent = `${green} ~ ${pb} L/min`;
            document.getElementById('pef-yellow-range').textContent = `${yellow} ~ ${green - 1} L/min`;
            document.getElementById('pef-red-range').textContent = `ä½æ–¼ ${yellow} L/min`;
        }

        // è—¥ç‰©æ¬„ä½è‡ªå‹•å¸¶å…¥èˆ‡é¡è‰²é‚è¼¯
        function setupMedsLogic() {
            const cInput = document.getElementById('controller-meds');
            const cFreq = document.getElementById('controller-freq');
            const eInput = document.getElementById('extra-controller-meds');
            const eFreq = document.getElementById('extra-controller-freq');

            cInput.addEventListener('change', () => {
                const freq = CONTROLLER_MEDS_FREQ[cInput.value];
                if (freq) { cFreq.value = freq; cFreq.style.color = "#1c1c1e"; }
                cInput.style.color = "#1c1c1e";
            });

            eInput.addEventListener('change', () => {
                const freq = EXTRA_CONTROLLER_MEDS_FREQ[eInput.value];
                if (freq) { eFreq.value = freq; eFreq.style.color = "#1c1c1e"; }
                eInput.style.color = "#1c1c1e";
            });
        }

        // Backspace æ¸…é™¤é‚è¼¯
        function clearFieldOnBackspace(el) {
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && el.value.length > 0) {
                    el.value = '';
                    e.preventDefault();
                }
            });
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            // è®€å– PB
            const pbData = loadLocal('asthma_pb', null);
            if (pbData && pbData.personalBestPEF) {
                personalBestPEF = pbData.personalBestPEF;
                document.getElementById('pb-value').textContent = personalBestPEF;
                document.getElementById('pb-pef-input').value = personalBestPEF;
                document.getElementById('log-section').classList.remove('hidden');
                updateActionPlanRanges(personalBestPEF);
            }

            // è®€å–å€‹äººè³‡è¨Š (å¸¶å…¥é è¨­é›»è©±)
            const profile = loadLocal('asthma_profile', { emergencyPhone: DEFAULT_EMERGENCY_PHONE });
            document.getElementById('emergency-phone').value = profile.emergencyPhone;
            document.getElementById('emergency-contact-display').textContent = profile.emergencyPhone;

            // ç¶å®šå„²å­˜äº‹ä»¶
            document.getElementById('save-pb-btn').addEventListener('click', savePB);
            
            // è—¥ç‰©èˆ‡ Backspace é‚è¼¯
            setupMedsLogic();
            clearFieldOnBackspace(document.getElementById('controller-meds'));
            clearFieldOnBackspace(document.getElementById('extra-controller-meds'));
            clearFieldOnBackspace(document.getElementById('reliever-meds-input'));

            // æ›´æ–°æœ€å¾Œæ™‚é–“
            document.getElementById('last-updated-display').textContent = new Date().toLocaleString();
        };
    </script>
</body>
</html>