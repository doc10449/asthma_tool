<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ - æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        /* æ¨¡æ“¬ San Francisco/iOS å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: #f2f2f7; /* iOS è¨­ç½®èƒŒæ™¯è‰² */
            color: #1c1c1e; /* iOS é è¨­æ·±è‰²æ–‡å­— */
            font-size: 15px; /* åŸºåº•å­—é«”èª¿æ•´ç‚º 15px */
        }
        
        /* çµ±ä¸€å¡ç‰‡å®¹å™¨æ¨£å¼ */
        .app-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* è¼•å¾®é™°å½± */
            margin-bottom: 24px;
            border: 1px solid #e5e5ea; 
            overflow: hidden; /* ç¢ºä¿å…§å®¹åœ¨åœ“è§’å…§ */
        }

        /* å®šç¾©é¡è‰²å€åŸŸ (ä¿æŒæŸ”å’Œè‰²èª¿) */
        .zone-green { background-color: #34c759; color: white; border-radius: 8px; padding: 12px; } /* iOS ç¶ è‰² */
        .zone-yellow { background-color: #ff9500; color: white; border-radius: 8px; padding: 12px; } /* iOS æ©˜è‰² */
        .zone-red { background-color: #ff3b30; color: white; border-radius: 8px; padding: 12px; } /* iOS ç´…è‰² */
        
        /* åˆ—è¡¨å®¹å™¨ï¼šæ¨¡æ“¬ iOS è¨­ç½®é é¢çš„åˆ—è¡¨åˆ†çµ„ */
        .list-container {
            padding: 0;
        }
        /* åˆ—è¡¨è¡Œï¼šåº•ç·šåˆ†éš” */
        .list-row {
            padding: 12px 16px;
            border-bottom: 0.5px solid #e5e5ea;
            display: flex;
            flex-direction: column; /* æ‰‹æ©Ÿä¸Šé è¨­å‚ç›´å †ç–Š */
            gap: 4px;
        }
        .list-row:last-child {
            border-bottom: none;
        }

        /* ç§»é™¤å…©çµ„æ§åˆ¶è—¥ç‰©é–“çš„é‚Šç·š */
        .no-border-bottom {
             border-bottom: none !important;
        }

        /* å¼·åŒ–è—¥ç‰©å€å¡Šçš„æ¨™é¡Œå­—å‹ */
        .medication-label-strong {
            font-weight: 600; /* semi-bold */
            color: #1c1c1e; /* ç¢ºä¿æ·±è‰² */
            display: block; /* ç¢ºä¿ä½”æ“šä¸€è¡Œ */
            margin-bottom: 4px; /* èˆ‡ä¸‹æ–¹è¼¸å…¥æ¡†ä¿æŒè·é›¢ */
        }


        /* ç§»é™¤è¡¨å–®å…ƒç´ é‚Šæ¡†å’ŒèƒŒæ™¯ï¼Œèå…¥åˆ—è¡¨ */
        .list-row input:not([type="checkbox"]), 
        .list-row select, 
        .list-row textarea {
            border: 1px solid #d1d1d6 !important; /* æ·ºç°è‰²é‚Šæ¡† */
            padding: 8px 12px !important;
            background-color: white !important;
            box-shadow: none !important;
            border-radius: 6px !important;
            font-size: 16px; /* æé«˜è§¸æ§æ˜“ç”¨æ€§ */
        }

        /* é‡ç½® List Style å…§çš„è¼¸å…¥æ¡†ï¼Œä½¿å…¶æ›´ç°¡æ½”ï¼Œä¸¦è®“æ¨™ç±¤æ›´æ˜é¡¯ */
        #profile-section .list-row input, 
        #profile-section .list-row select {
            border: 1px solid #d1d1d6 !important;
            padding: 4px 8px !important;
        }

        /* è¼”åŠ©è—¥ç‰©ç´°é …è¼¸å…¥æ¡†å¾®èª¿ */
        #support-meds-container input[type="text"] {
             border: 1px solid #d1d1d6 !important;
             border-radius: 6px !important;
             padding: 4px 8px !important;
             background-color: #f9f9f9 !important;
             box-shadow: none !important;
             font-size: 14px;
             height: 32px;
             min-width: 0; /* ç¢ºä¿åœ¨ flex ä½ˆå±€ä¸­å¯ä»¥ç¸®å° */
        }
        
        /* ç¢ºä¿ Checkbox ä½ˆå±€åœ¨æ‰‹æ©Ÿä¸Šä¸æ“ å£“ */
        .support-item-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 0.5px solid #e5e5ea;
        }
        .support-item-row:last-child {
            border-bottom: none;
        }
        
        /* PEF è®€æ•¸æ¬„ä½å„ªåŒ– */
        #log-section input[type="number"] {
            border: 1px solid #d1d1d6 !important;
            padding: 10px !important;
        }

        /* ACT é‡è¡¨å„ªåŒ–: æ¯å€‹å•é¡Œç¨ç«‹æˆå¡ç‰‡ï¼Œå¢åŠ å±¤æ¬¡æ„Ÿ */
        .act-question-group {
            margin-bottom: 16px !important; 
            padding: 16px !important;
            background-color: white !important;
            border-radius: 10px;
            border: 1px solid #d1d1d6;
        }
        .act-question-group label.text-sm { /* å•é¡Œæ¨™é¡Œ */
            font-size: 16px; /* å•é¡Œæ¨™é¡Œæ”¾å¤§ */
            font-weight: 600; 
            margin-bottom: 8px;
            display: block;
        }
        .act-question-group div.flex { /* é¸é …å®¹å™¨ */
            flex-direction: column; 
            gap: 10px; /* å¢åŠ é¸é …é–“è· */
            margin-top: 8px;
        }
        .act-question-group label.inline-flex { /* å–®å€‹é¸é … */
            padding: 6px 0; /* å¢åŠ å‚ç›´é–“è·ä»¥åˆ©è§¸æ§ */
            cursor: pointer;
            width: 100%; 
            font-size: 14px; /* é¸é …æ–‡å­—é©ä¸­ */
        }


        /* è‡ªå®šç¾©é¡è‰²é¡ï¼šæ·ºç°è‰²ç”¨æ–¼é è¨­å€¼ï¼Œæ·±ç°è‰²ç”¨æ–¼è¼¸å…¥å€¼ */
        .input-field-loaded {
            color: #9ca3af !important; /* æ·ºç°è‰² */
            font-weight: 400; /* è¼‰å…¥æ•¸æ“šæ™‚ä½¿ç”¨æ·ºè‰²å’Œè¼•å­—é«” */
        }
        .input-field-edited {
            color: #1f2937 !important; /* æ·±é»‘è‰² */
            font-weight: 500; /* ç·¨è¼¯æ•¸æ“šæ™‚ä½¿ç”¨æ·±è‰²å’Œä¸­å­—é«” */
        }

        /* è¨­ç½®åœ–è¡¨å®¹å™¨ï¼Œå¯¦ç¾æ°´å¹³æ»¾å‹• */
        #chart-container {
            max-width: 100%;
            overflow-x: auto;
            min-height: 250px; 
        }
        #pef-chart { 
            height: 300px; /* å›ºå®šåœ–è¡¨é«˜åº¦ */
        } 
        /* éš±è—/é¡¯ç¤ºå…§å®¹ */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .collapsible-content.expanded {
            max-height: 5000px; 
            transition: max-height 0.6s ease-in;
        }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="app" class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ</h1>
        <h2 class="text-base text-gray-600 mb-6 border-b pb-2 font-medium">ä¸‰è»ç¸½é†«é™¢ èƒ¸è…”å…§ç§‘</h2>

        <div id="profile-section">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 ml-2">I. å€‹äººè³‡è¨Šèˆ‡é†«ç™‚è¯çµ¡æ–¹å¼</h2>
            <form id="profile-form">
                <div class="app-card list-container space-y-0">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                        <div>
                            <label for="profile-name" class="block text-sm font-medium text-gray-700">å§“å:</label>
                            <input type="text" id="profile-name" required class="block w-full">
                        </div>
                        <div>
                            <label for="profile-dob" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥:</label>
                            <input type="date" id="profile-dob" class="block w-full">
                        </div>
                    </div>
                    <div class="list-row bg-indigo-50 border-indigo-200">
                        <p class="font-medium">é ä¼°å¹´é½¡: <span id="calculated-age" class="font-semibold text-indigo-800">æœªè¼¸å…¥</span></p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                        <div>
                            <label for="medical-record-number" class="block text-sm font-medium text-gray-700">ç—…æ­·è™Ÿ:</label>
                            <input type="text" id="medical-record-number" required placeholder="ä¾‹å¦‚: 1234567" class="block w-full">
                        </div>
                        <div>
                            <label for="attending-physician" class="block text-sm font-medium text-gray-700">ä¸»æ²»é†«å¸«:</label>
                            <input type="text" id="attending-physician" placeholder="ä¾‹å¦‚: ç‹å°æ˜é†«å¸«" class="block w-full">
                        </div>
                    </div>

                    <div class="list-row border-t-0">
                        <p class="text-sm font-semibold text-indigo-800 mb-1">ç·Šæ€¥è¯çµ¡è³‡è¨Š</p>
                        <div>
                            <label for="emergency-phone" class="block text-sm font-medium text-gray-700">è¯çµ¡é›»è©±:</label>
                            <input type="tel" id="emergency-phone" class="block w-full">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg mt-4">
                    å„²å­˜å€‹äººè³‡æ–™
                </button>
            </form>
        </div>
        
        <div id="setup-section">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 ml-2">II. å€‹äººæœ€ä½³å°–å³°å‘¼æ°£æµé€Ÿå€¼ (Personal Best, PB)</h2>
            <div class="app-card list-container">
                <div class="list-row">
                    <p class="text-sm text-gray-700">è¨­å®šåŸºæº– PEF (L/min):</p>
                    <div class="flex items-center space-x-3 mt-1">
                        <input type="number" id="pb-pef-input" placeholder="è¼¸å…¥æ•¸å€¼" class="flex-grow p-2 border rounded-lg h-10">
                        <button id="save-pb-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-150 ease-in-out whitespace-nowrap">
                            å„²å­˜
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">ç›®å‰åŸºæº– PEF: <span class="font-bold text-base" id="pb-value">æœªè¨­å®š</span> L/min</p>
                </div>
            </div>
        </div>

        <div id="action-plan-guide">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">III. æ°£å–˜æƒ¡åŒ–æ‡‰å°æŒ‡å— ğŸš¨</h2>
            <div class="app-card p-4 space-y-4">

                <div class="zone-green">
                    <h3 class="text-lg font-bold mb-1">ğŸŸ¢ ç¶ ç‡ˆå€ â€” æƒ…æ³è‰¯å¥½</h3>
                    <p class="text-sm font-medium">PEF è®€æ•¸: <span id="pef-green-range">PB çš„ 80% ~ 100%</span></p>
                    <ul class="list-disc list-inside text-sm mt-2 font-semibold">
                        <li>æªæ–½: æ¯æ—¥ä½¿ç”¨**æ§åˆ¶è—¥ç‰©**ã€‚</li>
                    </ul>
                </div>

                <div class="zone-yellow">
                    <h3 class="text-lg font-bold mb-1">ğŸŸ¡ é»ƒç‡ˆå€ â€” å°å¿ƒæƒ¡åŒ–</h3>
                    <p class="text-sm font-medium">PEF è®€æ•¸: <span id="pef-yellow-range">PB çš„ 50% ~ 80%</span></p>
                    <ul class="list-disc list-inside text-sm mt-2 font-semibold">
                        <li>æªæ–½: ç«‹å³ä½¿ç”¨**æ€¥æ•‘è—¥**ã€‚ç—‡ç‹€ 24 å°æ™‚æœªæ”¹å–„ï¼Œè«‹å„˜é€Ÿå›è¨ºã€‚</li>
                    </ul>
                </div>

                <div class="zone-red">
                    <h3 class="text-lg font-bold mb-1">ğŸ”´ ç´…ç‡ˆå€ â€” åš´é‡ç™¼ä½œï¼</h3>
                    <p class="text-sm font-medium">PEF è®€æ•¸: <span id="pef-red-range">ä½æ–¼ PB çš„ 50%</span></p>
                    <ul class="list-disc list-inside text-sm mt-2 font-semibold">
                        <li>æªæ–½: ç«‹å³ä½¿ç”¨æ€¥æ•‘è—¥æœ€å¤§åŠ‘é‡ã€‚**ç«‹å³æ’¥æ‰“æ€¥æ•‘é›»è©±æˆ–å‰å¾€æ€¥è¨ºå®¤**ã€‚</li>
                        <li class="mt-2">ç·Šæ€¥è¯çµ¡é›»è©±: <span class="font-bold text-base" id="emergency-contact-phone-display">æœªè¨˜éŒ„</span></li>
                    </ul>
                </div>
            </div>
        </div>


        <div id="medication-section">
            <h2 class="text-xl font-semibold text-purple-700 mb-3 ml-2">IV. è—¥ç‰©æ¸…å–®èˆ‡ä½¿ç”¨æ–¹å¼</h2>
            <form id="medication-form">
                <div class="app-card list-container space-y-0">
                    
                    <div class="list-row grid grid-cols-1 sm:grid-cols-2 gap-3 no-border-bottom">
                        <div class="space-y-1">
                            <label class="medication-label-strong" for="controller-meds">é•·æœŸæ§åˆ¶è—¥ç‰© (ä¿é¤Šè—¥ç‰©)</label>
                            <input type="text" id="controller-meds" list="controller-meds-list" placeholder="è—¥ç‰©åç¨±, åŠ‘é‡" class="block w-full">
                            <datalist id="controller-meds-list">
                                <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER">å¸å¿…æ“´ SYMBICORT TURBUHALER</option>
                                <option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">å¸å¿…æ“´ SYMBICORT RAPIHALER</option>
                                <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER">è‚ºèˆ’å¦ FOSTER MDI INHALER</option>
                                <option value="è‚ºèˆ’å¦ FOSTER NEXHALER">è‚ºèˆ’å¦ FOSTER NEXHALER</option>
                                <option value="æ½¤å¨ƒ RELVAR ELLIPTA">æ½¤å¨ƒ RELVAR ELLIPTA</option>
                                <option value="ä¿è¡›åº· ALVESCO INHALER">ä¿è¡›åº· ALVESCO INHALER</option>
                                <option value="è‚ºæ¨‚å–œ TRELEGY ELLIPTA">è‚ºæ¨‚å–œ TRELEGY ELLIPTA</option>
                            </datalist>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700" for="controller-freq">å¸¸è¦ä½¿ç”¨é »ç‡</label>
                            <select id="controller-freq" class="block w-full bg-white">
                                <option value="">å¸¸è¦ä½¿ç”¨é »ç‡</option>
                                <option value="åƒ…éœ€è¦æ™‚ä½¿ç”¨">åƒ…éœ€è¦æ™‚ä½¿ç”¨</option>
                                <option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option>
                                <option value="æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡">æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡</option>
                                <option value="æ¯æ—¥æ—©æ™šå„äºŒæ¬¡">æ¯æ—¥æ—©æ™šå„äºŒæ¬¡</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="list-row grid grid-cols-1 sm:grid-cols-2 gap-3 no-border-bottom">
                        <div class="space-y-1">
                            <label class="medication-label-strong" for="extra-controller-meds">é¡å¤–ä¿é¤Šè—¥ç‰©</label>
                            <input type="text" id="extra-controller-meds" list="extra-controller-meds-list" placeholder="è—¥ç‰©åç¨±, åŠ‘é‡ (é¸å¡«)" class="block w-full">
                            <datalist id="extra-controller-meds-list">
                                <option value="é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)">é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)</option>
                                <option value="è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA">è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA</option>
                            </datalist>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700" for="extra-controller-freq">å¸¸è¦ä½¿ç”¨é »ç‡</label>
                            <select id="extra-controller-freq" class="block w-full bg-white">
                                <option value="">å¸¸è¦ä½¿ç”¨é »ç‡</option>
                                <option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option>
                            </select>
                        </div>
                    </div>

                    <div class="list-row grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="medication-label-strong" for="reliever-meds-input">é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘è—¥)</label>
                            <input type="text" id="reliever-meds-input" list="reliever-meds-list" placeholder="è—¥ç‰©åç¨±, åŠ‘é‡" class="block w-full">
                            <datalist id="reliever-meds-list">
                                <option value="åŒä¿é¤Šè—¥ç‰©">åŒä¿é¤Šè—¥ç‰©</option>
                                <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER">å¸å¿…æ“´ SYMBICORT TURBUHALER</option>
                                <option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">å¸å¿…æ“´ SYMBICORT RAPIHALER</option>
                                <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER">è‚ºèˆ’å¦ FOSTER MDI INHALER</option>
                                <option value="è‚ºèˆ’å¦ FOSTER NEXHALER">è‚ºèˆ’å¦ FOSTER NEXHALER</option>
                                <option value="å‚™å–˜å…¨ BERODUAL N MDI">å‚™å–˜å…¨ BERODUAL N MDI</option>
                                <option value="å‚™å‹å–˜ BEROTECL N MDI">å‚™å‹å–˜ BEROTECL N MDI</option>
                            </datalist>
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700" for="reliever-freq-select">ç·©è§£ä½¿ç”¨é »ç‡</label>
                            <select id="reliever-freq-select" class="block w-full bg-white">
                                <option value="éœ€è¦æ™‚ä½¿ç”¨">éœ€è¦æ™‚ä½¿ç”¨</option>
                                <option value="ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º">ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="list-row border-b-0">
                        <label class="medication-label-strong mb-2">è¼”åŠ©è—¥ç‰© (é•·æœŸä½¿ç”¨):</label>
                        <div id="support-meds-container" class="space-y-1 mt-1 bg-gray-50 p-3 rounded-lg">
                            
                            <div class="support-item-row bg-white rounded-lg px-2">
                                <input type="checkbox" id="support-oral-steroids" name="support-meds-checkbox" value="å£æœé¡å›ºé†‡" class="form-checkbox text-purple-600 rounded">
                                <label for="support-oral-steroids" class="text-sm font-medium text-gray-700 ml-2 whitespace-nowrap">å£æœé¡å›ºé†‡:</label>
                                <input type="text" id="support-oral-steroids-detail" placeholder="ç´°é …" class="flex-grow ml-2" disabled>
                            </div>
                            <div class="support-item-row bg-white rounded-lg px-2">
                                <input type="checkbox" id="support-theophylline" name="support-meds-checkbox" value="èŒ¶é¹¼" class="form-checkbox text-purple-600 rounded">
                                <label for="support-theophylline" class="text-sm font-medium text-gray-700 ml-2 whitespace-nowrap">èŒ¶é¹¼:</label>
                                <input type="text" id="support-theophylline-detail" placeholder="ç´°é …" class="flex-grow ml-2" disabled>
                            </div>
                            <div class="support-item-row bg-white rounded-lg px-2">
                                <input type="checkbox" id="support-leukotriene" name="support-meds-checkbox" value="ç™½ä¸‰çƒ¯å—é«”æ‹®æŠ—åŠ‘" class="form-checkbox text-purple-600 rounded">
                                <label for="support-leukotriene" class="text-sm font-medium text-gray-700 ml-2 whitespace-nowrap">ç™½ä¸‰çƒ¯å—é«”æ‹®æŠ—åŠ‘ (æ¬£æµ):</label>
                                <input type="text" id="support-leukotriene-detail" placeholder="ç´°é …" class="flex-grow ml-2" disabled>
                            </div>
                            <div class="support-item-row border-b-0 bg-white rounded-lg px-2">
                                <input type="checkbox" id="support-biologic" name="support-meds-checkbox" value="ç”Ÿç‰©è£½åŠ‘" class="form-checkbox text-purple-600 rounded">
                                <label for="support-biologic" class="text-sm font-medium text-gray-700 ml-2 whitespace-nowrap">ç”Ÿç‰©è£½åŠ‘:</label>
                                <input type="text" id="support-biologic-detail" placeholder="ç´°é …" class="flex-grow ml-2" disabled>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition duration-150 ease-in-out">
                    å„²å­˜ç”¨è—¥è¨ˆç•«
                </button>
            </form>
            <div class="mt-4 pt-3 border-t border-purple-200 space-y-1 p-4 bg-gray-50 rounded-b-lg">
                <p class="text-sm font-medium text-purple-600">ç•¶å‰æ§åˆ¶è—¥ç‰© (ä¿é¤Š): <span class="font-semibold" id="current-controller">æœªè¨˜éŒ„</span></p>
                <p class="text-sm font-medium text-purple-600">ä½¿ç”¨é »ç‡ (ä¿é¤Š): <span class="font-semibold" id="current-freq">æœªè¨˜éŒ„</span></p>
                <p class="text-sm font-medium text-purple-600">ç•¶å‰é¡å¤–è—¥ç‰©: <span class="font-semibold" id="current-extra-controller">æœªè¨˜éŒ„</span></p>
                <p class="text-sm font-medium text-purple-600">å¸¸è¦ä½¿ç”¨é »ç‡: <span class="font-semibold" id="current-extra-freq">æœªè¨˜éŒ„</span></p>
                <p class="text-sm font-medium text-purple-600">ç•¶å‰æ€¥æ•‘è—¥: <span class="font-semibold" id="current-reliever">æœªè¨˜éŒ„</span></p>
                <p class="text-sm font-medium text-purple-600">ç•¶å‰è¼”åŠ©è—¥ç‰©: <span class="font-semibold" id="current-support">æœªè¨˜éŒ„</span></p>
            </div>
        </div>
        
        <div id="trigger-section">
            <h2 class="text-xl font-semibold text-gray-700 mb-3 ml-2">V. èª˜ç™¼å› å­èˆ‡ç’°å¢ƒæ§åˆ¶</h2>
            <form id="trigger-form">
                <div class="app-card list-container space-y-0">
                    <div class="list-row">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å€‹äººå·²çŸ¥èª˜ç™¼å› å­æ¸…å–® (å¯è¤‡é¸):</label>
                        <div id="trigger-options" class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm p-2 bg-gray-50 rounded-lg">
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="å¡µèŸ" class="form-checkbox text-gray-600 rounded"><span class="ml-2">å¡µèŸ</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="èŠ±ç²‰" class="form-checkbox text-gray-600 rounded"><span class="ml-2">èŠ±ç²‰</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="å¯µç‰©æ¯›é«®" class="form-checkbox text-gray-600 rounded"><span class="ml-2">å¯µç‰©æ¯›é«®</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="äºŒæ‰‹è¸" class="form-checkbox text-gray-600 rounded"><span class="ml-2">äºŒæ‰‹è¸</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="æ„Ÿå†’/æ„ŸæŸ“" class="form-checkbox text-gray-600 rounded"><span class="ml-2">æ„Ÿå†’/æ„ŸæŸ“</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="é‹å‹•" class="form-checkbox text-gray-600 rounded"><span class="ml-2">é‹å‹•</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="å†·ç©ºæ°£" class="form-checkbox text-gray-600 rounded"><span class="ml-2">å†·ç©ºæ°£</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="æƒ…ç·’å£“åŠ›" class="form-checkbox text-gray-600 rounded"><span class="ml-2">æƒ…ç·’å£“åŠ›</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="åˆºæ¿€æ°£å‘³" class="form-checkbox text-gray-600 rounded"><span class="ml-2">åˆºæ¿€æ°£å‘³</span></label>
                            <label class="inline-flex items-center"><input type="checkbox" name="trigger" value="ç‰¹å®šé£Ÿç‰©" class="form-checkbox text-gray-600 rounded"><span class="ml-2">ç‰¹å®šé£Ÿç‰©</span></label>
                        </div>
                    </div>

                    <div class="list-row border-b-0">
                        <label for="control-advice" class="block text-sm font-medium text-gray-700">å…¶ä»–ç´€éŒ„äº‹é …:</label>
                        <textarea id="control-advice" rows="2" placeholder="ä¾‹å¦‚: éœ€åœ¨é‹å‹•å‰15åˆ†é˜å¸å…¥ç·©è§£è—¥ç‰©" class="block w-full border rounded-lg p-2 mt-1"></textarea>
                    </div>
                </div>
                <button type="submit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition duration-150 ease-in-out mt-4">
                    å„²å­˜èª˜ç™¼å› å­è³‡è¨Š
                </button>
            </form>
            <div class="mt-4 pt-3 border-t border-gray-200 space-y-1 p-4 bg-gray-50 rounded-b-lg">
                <p class="text-sm font-medium text-gray-600">ç•¶å‰èª˜ç™¼å› å­: <span class="font-semibold" id="current-triggers">æœªè¨˜éŒ„</span></p>
            </div>
        </div>

        <div id="log-section" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">VI. è‡ªæˆ‘ç›£æ¸¬ç´€éŒ„ (æ¯æ—¥è¨˜éŒ„)</h2>
            <form id="asthma-log-form" class="app-card list-container">
                <div class="list-row grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="pef-morning" class="block text-sm font-medium text-gray-700">æ—©æ™¨ PEF è®€æ•¸ (L/min):</label>
                        <input type="number" id="pef-morning" class="block w-full border rounded-lg" placeholder="é¸å¡«">
                    </div>
                    <div>
                        <label for="pef-evening" class="block text-sm font-medium text-gray-700">æ™šé–“ PEF è®€æ•¸ (L/min):</label>
                        <input type="number" id="pef-evening" class="block w-full border rounded-lg" placeholder="é¸å¡«">
                    </div>
                </div>
                
                <div class="list-row">
                    <label for="symptoms" class="block text-sm font-medium text-gray-700">ç—‡ç‹€æˆ–èª˜ç™¼å› ç´  (é¸å¡«):</label>
                    <textarea id="symptoms" rows="3" class="block w-full border rounded-lg p-2" placeholder="ä¾‹å¦‚: è¼•å¾®å’³å—½, é‹å‹•å¾Œ, èŠ±ç²‰å¤š"></textarea>
                </div>

                <div class="p-4 bg-gray-50">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">æ°£å–˜æ§åˆ¶æ¸¬è©¦ (ACT - éå» 4 é€±)</h3>
                    <p class="text-sm text-red-600 font-medium mb-4">â—ï¸è«‹èª å¯¦è©•ä¼°éå» 4 é€±çš„ç‹€æ³ï¼Œæ¯é¡Œ 5 åˆ†ï¼Œæ»¿åˆ† 25 åˆ†ã€‚</p>
                    
                    <div class="act-question-group">
                        <label class="text-sm font-medium text-gray-700 mb-2">1. æ°£å–˜å°å·¥ä½œ/ä¸Šå­¸/å®¶äº‹å½±éŸ¿ç¨‹åº¦ï¼Ÿ</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs">
                            <label class="inline-flex items-center"><input type="radio" name="act-q1" value="1" required class="form-radio text-red-500"><span class="ml-1">å®Œå…¨ä¸èƒ½å‹ä»» (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q1" value="2" required class="form-radio text-yellow-500"><span class="ml-1">ç¶“å¸¸ (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q1" value="3" required class="form-radio text-yellow-500"><span class="ml-1">æœ‰äº›æ™‚å€™ (3)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q1" value="4" required class="form-radio text-green-500"><span class="ml-1">å¾ˆå°‘ (4)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q1" value="5" required class="form-radio text-green-500"><span class="ml-1">å®Œå…¨ä¸å—å½±éŸ¿ (5)</span></label>
                        </div>
                    </div>
                    <div class="act-question-group">
                        <label class="text-sm font-medium text-gray-700 mb-2">2. æ°£å–˜ç™¼ä½œå‘¼å¸çŸ­ä¿ƒçš„é »ç‡ï¼Ÿ</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs">
                            <label class="inline-flex items-center"><input type="radio" name="act-q2" value="1" required class="form-radio text-red-500"><span class="ml-1">æ¯å¤© > 1æ¬¡ (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q2" value="2" required class="form-radio text-yellow-500"><span class="ml-1">æ¯å¤© 1æ¬¡ (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q2" value="3" required class="form-radio text-yellow-500"><span class="ml-1">æ¯é€± 3-6æ¬¡ (3)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q2" value="4" required class="form-radio text-green-500"><span class="ml-1">æ¯é€± 1-2æ¬¡ (4)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q2" value="5" required class="form-radio text-green-500"><span class="ml-1">å®Œå…¨æ²’æœ‰ (5)</span></label>
                        </div>
                    </div>
                    <div class="act-question-group">
                        <label class="text-sm font-medium text-gray-700 mb-2">3. æ°£å–˜ç™¼ä½œé€ æˆå¤œé–“é†’ä¾†çš„é »ç‡ï¼Ÿ</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs">
                            <label class="inline-flex items-center"><input type="radio" name="act-q3" value="1" required class="form-radio text-red-500"><span class="ml-1">æ¯é€± â‰¥ 4æ™š (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q3" value="2" required class="form-radio text-yellow-500"><span class="ml-1">æ¯é€± 2-3æ™š (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q3" value="3" required class="form-radio text-yellow-500"><span class="ml-1">æ¯é€± 1æ¬¡ (3)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q3" value="4" required class="form-radio text-green-500"><span class="ml-1">æ¯é€± < 1æ™š (4)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q3" value="5" required class="form-radio text-green-500"><span class="ml-1">å®Œå…¨æ²’æœ‰ (5)</span></label>
                        </div>
                    </div>
                    <div class="act-question-group">
                        <label class="text-sm font-medium text-gray-700 mb-2">4. ç·©è§£è—¥ç‰©ï¼ˆå¦‚æ”¯æ°£ç®¡æ“´å¼µåŠ‘ï¼‰çš„ä½¿ç”¨é »ç‡ï¼Ÿ</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs">
                            <label class="inline-flex items-center"><input type="radio" name="act-q4" value="1" required class="form-radio text-red-500"><span class="ml-1">æ¯å¤© â‰¥ 3æ¬¡ (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q4" value="2" required class="form-radio text-yellow-500"><span class="ml-1">æ¯å¤© 1-2æ¬¡ (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q4" value="3" required class="form-radio text-yellow-500"><span class="ml-1">æ¯é€± 2-3æ¬¡ (3)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q4" value="4" required class="form-radio text-green-500"><span class="ml-1">æ¯é€± â‰¤ 1æ¬¡ (4)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q4" value="5" required class="form-radio text-green-500"><span class="ml-1">å®Œå…¨æ²’æœ‰ (5)</span></label>
                        </div>
                    </div>
                    <div class="act-question-group">
                        <label class="text-sm font-medium text-gray-700 mb-2">5. æ‚¨èªç‚ºéå» 4 é€±å…§ï¼Œæ‚¨çš„æ°£å–˜æ§åˆ¶ç¨‹åº¦ç‚ºä½•ï¼Ÿ</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs">
                            <label class="inline-flex items-center"><input type="radio" name="act-q5" value="1" required class="form-radio text-red-500"><span class="ml-1">å®Œå…¨æœªæ§åˆ¶ (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q5" value="2" required class="form-radio text-yellow-500"><span class="ml-1">æ§åˆ¶ä¸ä½³ (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q5" value="3" required class="form-radio text-yellow-500"><span class="ml-1">ç¨å¾®æ§åˆ¶ (3)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q5" value="4" required class="form-radio text-green-500"><span class="ml-1">æ§åˆ¶è‰¯å¥½ (4)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="act-q5" value="5" required class="form-radio text-green-500"><span class="ml-1">å®Œå…¨æ§åˆ¶ (5)</span></label>
                        </div>
                    </div>
                    
                    <div id="act-score-display" class="p-3 bg-blue-100 rounded-lg text-sm font-medium text-blue-700 hidden">
                        æœ¬æ¬¡ ACT è©•åˆ†ï¼š<span id="act-score-value" class="font-bold text-base text-blue-800"></span> / 25
                    </div>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition duration-200 mt-4">
                    è¨˜éŒ„ä¸¦æª¢æŸ¥è¡Œå‹•å€åŸŸ
                </button>
            </form>

            <h2 class="text-xl font-semibold text-gray-800 mt-8 mb-3 ml-2">VII. PEF è¶¨å‹¢åœ–èˆ‡æ­·å²è¨˜éŒ„</h2>
            
            <div class="app-card p-4">
                <div id="chart-container">
                    <canvas id="pef-chart"></canvas>
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-800 mb-3 ml-2">æ­·å²è¨˜éŒ„æŸ¥é–±</h3>
            <div class="app-card list-container">
                <p class="text-center text-gray-500 p-4" id="empty-log-msg">å°šç„¡è¨˜éŒ„ã€‚è«‹æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹ PEF è®€æ•¸ã€‚</p>

                <div id="log-viewer-controls" class="space-y-3 hidden list-row">
                    <label for="log-selector" class="block text-sm font-medium text-gray-700">é¸æ“‡è¨˜éŒ„æ—¥æœŸï¼š</label>
                    <select id="log-selector" class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-800"></select>
                </div>
                
                <div id="detailed-log-view" class="p-4 bg-gray-50 hidden">
                     </div>
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-gray-600 mb-2 font-medium">è«‹å®šæœŸå°‡æ­¤æ•¸æ“šåŒ¯å‡ºçµ¦æ‚¨çš„é†«ç™‚åœ˜éšŠã€‚</p>
                <button id="export-btn" class="w-full sm:w-auto bg-pink-600 hover:bg-pink-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    åŒ¯å‡ºæ•¸æ“šåˆ° Google è¡¨å–® (éœ€è¨­å®š)
                </button>
            </div>
        </div>
        
        <div class="max-w-2xl mx-auto mt-4 mb-8">
            <button id="privacy-toggle" class="w-full text-left font-semibold text-sm text-gray-700 p-3 bg-gray-200 hover:bg-gray-300 rounded-lg flex justify-between items-center transition duration-150" aria-expanded="false">
                <span>éš±ç§æ¬ŠåŠæˆæ¬Šè²æ˜ (é»æ“Šå±•é–‹)</span>
                <span id="toggle-icon">â–¼</span>
            </button>
            <div id="privacy-content" class="collapsible-content bg-white p-4 rounded-b-lg border border-gray-200 border-t-0">
                <h3 class="text-base font-bold text-gray-800 mb-2">1. è³‡æ–™å„²å­˜èˆ‡éš±ç§æ¬Š</h3>
                <p class="text-sm text-gray-700 mb-2">æœ¬æ‡‰ç”¨ç¨‹å¼ç‚ºå–®æ©Ÿç‰ˆæœ¬ï¼Œæ‰€æœ‰è³‡æ–™çš†å„²å­˜æ–¼æ‚¨ç•¶å‰ä½¿ç”¨çš„**ç€è¦½å™¨å…§å»ºçš„æœ¬åœ°å„²å­˜ç©ºé–“ (LocalStorage)**ã€‚æœ¬é™¢ä¸æœƒè‡ªå‹•é€éæ­¤æ‡‰ç”¨ç¨‹å¼æ”¶é›†æˆ–å­˜å–æ‚¨çš„æœ¬åœ°æ•¸æ“šã€‚</p>
                <p class="text-sm text-red-700 font-bold mb-4">è­¦å‘Šï¼šè‹¥æ‚¨æ¸…é™¤ç€è¦½å™¨å¿«å–ã€æ›´æ›è£ç½®æˆ–ä½¿ç”¨ç„¡ç—•æ¨¡å¼ï¼Œæ‰€æœ‰æœ¬åœ°å„²å­˜çš„æ•¸æ“šå°‡æœƒéºå¤±ã€‚</p>
                
                <h3 class="text-base font-bold text-gray-800 mb-2">2. è³‡æ–™åŒ¯å‡º</h3>
                <p class="text-sm text-gray-700">ã€ŒåŒ¯å‡ºæ•¸æ“šåˆ°è¡¨å–®ã€åŠŸèƒ½æœƒå°‡æ‚¨æœ¬åœ°æ•¸æ“šç·¨ç¢¼å¾Œï¼Œå‚³è¼¸è‡³æœ¬é™¢æŒ‡å®šçš„ Google è¡¨å–®é€£çµã€‚**æ­¤æ“ä½œéœ€è¦åœ¨æ–°çš„ç€è¦½å™¨è¦–çª—ä¸­ï¼Œç”±æ‚¨æ‰‹å‹•é»æ“Šã€Œæäº¤ã€ï¼Œè³‡æ–™æ‰æœƒé€é”æœ¬é™¢ã€‚**</p>
                
            </div>
        </div>

    </div>
    
    <div class="max-w-2xl mx-auto text-right text-xs text-gray-500 pt-3 border-t mt-4">
        æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š<span id="last-updated-display"></span>
    </div>


    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-semibold transition-opacity duration-300 opacity-0" style="display: none;"></div>

    <script type="text/javascript">

        // *************** Google Form åŒ¯å‡ºé…ç½® (è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›è¡¨å–® ID) ***************
        const GOOGLE_FORM_CONFIG = {
            FORM_BASE_URL: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse?', 
            ENTRY_IDS: {
                USER_ID: 'entry.111111111',       
                NAME: 'entry.222222222',          
                AGE: 'entry.333333333',           
                DOB: 'entry.444444444',           
                RECORD_NO: 'entry.555555555',     
                PHYSICIAN: 'entry.666666666',     
                EMERGENCY_CONTACT: 'entry.777777777', 
                EMERGENCY_PHONE: 'entry.888888888', 
                PB_PEF: 'entry.999999999',         
                CONTROLLER_MEDS: 'entry.100000000', 
                CONTROLLER_FREQ: 'entry.150000000', 
                EXTRA_CONTROLLER_MEDS: 'entry.170000000',
                EXTRA_CONTROLLER_FREQ: 'entry.180000000',
                RELIEVER_MEDS: 'entry.110000000',   
                RELIEVER_TYPE: 'entry.160000000',  
                SUPPORT_MEDS: 'entry.140000000',  
                KNOWN_TRIGGERS: 'entry.120000000',  
                LOG_HISTORY: 'entry.130000000', 
            }
        };
        // *************************************************************************

        // å…¨åŸŸè®Šæ•¸
        let personalBestPEF = null;
        let pefChart = null; 
        let allLogs = []; 
        let userProfile = {};
        let medicationPlan = {};
        let triggerInfo = {}; 
        
        const DEFAULT_VALUE = 'æœªè¨˜éŒ„';
        const DEFAULT_EMERGENCY_PHONE = '0287923311#10121'; // é è¨­ç·Šæ€¥é›»è©±

        // è—¥ç‰©é è¨­é »ç‡é…ç½® (ç¬¬ä¸€çµ„)
        const CONTROLLER_MEDS_FREQ = {
            "å¸å¿…æ“´ SYMBICORT TURBUHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡",
            "å¸å¿…æ“´ SYMBICORT RAPIHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡",
            "è‚ºèˆ’å¦ FOSTER MDI INHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡",
            "è‚ºèˆ’å¦ FOSTER NEXHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡",
            "æ½¤å¨ƒ RELVAR ELLIPTA": "æ¯æ—¥ä¸€æ¬¡",
            "ä¿è¡›åº· ALVESCO INHALER": "æ¯æ—¥ä¸€æ¬¡", // æ ¹æ“šè¦æ±‚ä¿®æ”¹
            "è‚ºæ¨‚å–œ TRELEGY ELLIPTA": "æ¯æ—¥ä¸€æ¬¡"
        };
        // è—¥ç‰©é è¨­é »ç‡é…ç½® (ç¬¬äºŒçµ„)
        const EXTRA_CONTROLLER_MEDS_FREQ = {
            "é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)": "æ¯æ—¥ä¸€æ¬¡",
            "è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA": "æ¯æ—¥ä¸€æ¬¡"
        };
        // æ€¥æ•‘è—¥ç‰©é è¨­é »ç‡é…ç½® (å·¦æ¬„è®Šæ›´æ™‚ï¼Œå³æ¬„é è¨­ç‚ºã€Œéœ€è¦æ™‚ä½¿ç”¨ã€)
        const RELIEVER_MEDS_FREQ = {
            "åŒä¿é¤Šè—¥ç‰©": "éœ€è¦æ™‚ä½¿ç”¨",
            "å¸å¿…æ“´ SYMBICORT TURBUHALER": "éœ€è¦æ™‚ä½¿ç”¨",
            "å¸å¿…æ“´ SYMBICORT RAPIHALER": "éœ€è¦æ™‚ä½¿ç”¨",
            "è‚ºèˆ’å¦ FOSTER MDI INHALER": "éœ€è¦æ™‚ä½¿ç”¨",
            "è‚ºèˆ’å¦ FOSTER NEXHALER": "éœ€è¦æ™‚ä½¿ç”¨",
            "å‚™å–˜å…¨ BERODUAL N MDI": "éœ€è¦æ™‚ä½¿ç”¨",
            "å‚™å‹å–˜ BEROTECL N MDI": "éœ€è¦æ™‚ä½¿ç”¨",
        };

        
        // åœ–è¡¨é…ç½®å¸¸æ•¸
        const MAX_CHART_POINTS = 30;
        const PIXELS_PER_POINT = 40;

        const PB_VALUE_DISPLAY = document.getElementById('pb-value');
        const MESSAGE_BOX = document.getElementById('message-box');
        const MEDICATION_FORM = document.getElementById('medication-form');
        const CONTROLLER_MEDS_INPUT = document.getElementById('controller-meds');
        const CONTROLLER_FREQ_SELECT = document.getElementById('controller-freq');
        const EXTRA_CONTROLLER_MEDS_INPUT = document.getElementById('extra-controller-meds');
        const EXTRA_CONTROLLER_FREQ_SELECT = document.getElementById('extra-controller-freq');
        const RELIEVER_MEDS_INPUT = document.getElementById('reliever-meds-input');
        const RELIEVER_FREQ_SELECT = document.getElementById('reliever-freq-select');
        
        // è¼”åŠ©è—¥ç‰©ç›¸é—œçš„ DOM å…ƒç´ 
        const SUPPORT_MEDS_MAP = [
            { id: 'oral-steroids', label: 'å£æœé¡å›ºé†‡' },
            { id: 'theophylline', label: 'èŒ¶é¹¼' },
            { id: 'leukotriene', label: 'ç™½ä¸‰çƒ¯å—é«”æ‹®æŠ—åŠ‘' },
            { id: 'biologic', label: 'ç”Ÿç‰©è£½åŠ‘' }
        ];

        
        const CURRENT_CONTROLLER_DISPLAY = document.getElementById('current-controller');
        const CURRENT_FREQ_DISPLAY = document.getElementById('current-freq');
        const CURRENT_EXTRA_CONTROLLER_DISPLAY = document.getElementById('current-extra-controller');
        const CURRENT_EXTRA_FREQ_DISPLAY = document.getElementById('current-extra-freq');
        const CURRENT_RELIEVER_DISPLAY = document.getElementById('current-reliever');
        const CURRENT_SUPPORT_DISPLAY = document.getElementById('current-support'); 
        
        const PROFILE_FORM = document.getElementById('profile-form');
        const PROFILE_DOB_INPUT = document.getElementById('profile-dob');
        const EXPORT_BUTTON = document.getElementById('export-btn');
        const ACT_SCORE_VALUE_DISPLAY = document.getElementById('act-score-value');
        const ACT_SCORE_DISPLAY_BLOCK = document.getElementById('act-score-display');
        const TRIGGER_FORM = document.getElementById('trigger-form');
        const CONTROL_ADVICE_TEXTAREA = document.getElementById('control-advice');
        const CURRENT_TRIGGERS_DISPLAY = document.getElementById('current-triggers');
        const PEF_GREEN_RANGE_DISPLAY = document.getElementById('pef-green-range');
        const PEF_YELLOW_RANGE_DISPLAY = document.getElementById('pef-yellow-range');
        const PEF_RED_RANGE_DISPLAY = document.getElementById('pef-red-range');
        const EMERGENCY_PHONE_DISPLAY = document.getElementById('emergency-contact-phone-display');
        const LOG_SECTION = document.getElementById('log-section');
        const TRIGGER_OPTIONS_CONTAINER = document.getElementById('trigger-options');
        const LAST_UPDATED_DISPLAY = document.getElementById('last-updated-display');
        const PRIVACY_TOGGLE = document.getElementById('privacy-toggle');
        const PRIVACY_CONTENT = document.getElementById('privacy-content');
        const TOGGLE_ICON = document.getElementById('toggle-icon');
        const CHART_CONTAINER = document.getElementById('chart-container');
        const LOG_SELECTOR = document.getElementById('log-selector');
        const DETAILED_LOG_VIEW = document.getElementById('detailed-log-view');
        const LOG_VIEWER_CONTROLS = document.getElementById('log-viewer-controls');


        // --- é¡è‰²æ§åˆ¶å‡½æ•¸ (æ ¸å¿ƒä¿®å¾©) ---

        /**
         * è¨­ç½®è¼¸å…¥/é¸æ“‡å…ƒç´ çš„å­—é«”é¡è‰²å’Œé¡åˆ¥
         * @param {HTMLElement} element 
         * @param {string} value è¼‰å…¥çš„å€¼ (ç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºç©º)
         */
        function setElementColor(element, value) {
            const isLoaded = !!value && value !== DEFAULT_VALUE && value !== '';
            
            // ç§»é™¤æ‰€æœ‰é¡è‰²é¡
            element.classList.remove('input-field-loaded', 'input-field-edited');

            if (isLoaded) {
                // è¼‰å…¥æ™‚ä½¿ç”¨æ·ºç°è‰²
                element.classList.add('input-field-loaded');
            } else {
                 // ç©ºå€¼æˆ–æœªå„²å­˜æ™‚ä½¿ç”¨æ·±è‰²ï¼ˆè®“ Placeholder æ¸…æ¥šï¼‰
                element.classList.add('input-field-edited');
            }
        }
        
        /**
         * è™•ç†è¼¸å…¥äº‹ä»¶ï¼šç•¶ç”¨æˆ¶é–‹å§‹è¼¸å…¥/é¸æ“‡æ™‚ï¼Œå­—é«”è®Šæ·±
         * @param {Event} e 
         */
        function handleInputEdit(e) {
            const element = e.target;
            element.classList.remove('input-field-loaded');
            element.classList.add('input-field-edited');
        }

        /**
         * æ ¹æ“šè—¥ç‰©åç¨±ï¼Œè‡ªå‹•å¸¶å…¥å°æ‡‰çš„é »ç‡ (å„ªåŒ–ï¼šç¢ºä¿å¼·åˆ¶è¦†è“‹)
         */
        function autoFillFrequency(inputElement, freqSelectElement, freqMap) {
            const drugName = inputElement.value.trim();
            const defaultFreq = freqMap[drugName];
            
            if (defaultFreq) {
                // æ‰¾åˆ°åŒ¹é…é …ï¼Œå¼·åˆ¶è¨­ç½®é »ç‡
                freqSelectElement.value = defaultFreq;
                // è‡ªå‹•å¡«å……æ™‚ï¼Œæ¨™è¨˜ç‚ºå·²ç·¨è¼¯ (æ·±è‰²)
                handleInputEdit({ target: freqSelectElement }); 
            } else {
                // å¦‚æœæ²’æœ‰åŒ¹é…é …ï¼Œå‰‡ä¸æ”¹è®Šé »ç‡æ¬„ä½çš„å€¼
            }
            // æ¨™è¨˜è—¥ç‰©è¼¸å…¥æ¡†é¡è‰² (åç¨±)
            setElementColor(inputElement, drugName); 
        }

        /**
         * è—¥ç‰©è¼¸å…¥æ¬„ä½å¤±ç„¦æ™‚ï¼Œå˜—è©¦æ¢å¾©ä¸Šæ¬¡å„²å­˜çš„å€¼
         */
        function loadMedicationValue(element, keyName, freqMap, freqSelectElement) {
             const currentValue = element.value.trim();
             const storedValue = medicationPlan[keyName] || "";
             
             // å¦‚æœç•¶å‰å€¼èˆ‡ä¸Šæ¬¡å„²å­˜çš„å€¼ä¸åŒï¼Œæˆ–è€…æ¬„ä½ç‚ºç©ºï¼Œå‰‡æ›´æ–°
             if (currentValue !== storedValue) {
                 
                 if (!currentValue && storedValue !== DEFAULT_VALUE && storedValue !== "") {
                     // æƒ…æ³1: ç”¨æˆ¶æ¸…ç©ºäº†æ¬„ä½ï¼Œæ¢å¾©ä¸Šæ¬¡å„²å­˜çš„å€¼
                     element.value = storedValue;
                     
                 } else if (currentValue) {
                     // æƒ…æ³2: ç”¨æˆ¶è¼¸å…¥äº†æ–°çš„å€¼ï¼Œä¿ç•™æ–°å€¼
                     element.value = currentValue;
                 } else {
                     // æƒ…æ³3: æ¬„ä½ç‚ºç©ºï¼Œä¸”å„²å­˜å€¼ä¹Ÿæ˜¯ç©ºæˆ–é»˜èªå€¼
                     element.value = '';
                 }
             }
             
             // é‡æ–°è¨­å®šé¡è‰²ï¼Œå°‡æ±ºå®šæ˜¯æ·ºç° (å„²å­˜å€¼) é‚„æ˜¯æ·±è‰² (æœªå„²å­˜ä½†æ­£åœ¨ç·¨è¼¯)
             setElementColor(element, element.value);

             // è™•ç†é »ç‡æ¬„ä½çš„é¡è‰²å’Œé è¨­å€¼
             if (freqSelectElement) {
                 const currentStoredValue = element.value; // æ¢å¾©å¾Œçš„æˆ–æ–°çš„å€¼
                 const defaultFreq = freqMap[currentStoredValue];
                 const currentFreqStored = medicationPlan[freqSelectElement.id] || "";
                 
                 if (currentStoredValue === storedValue && currentFreqStored) {
                    // å¦‚æœè—¥ç‰©åç¨±æ¢å¾©ç‚ºå„²å­˜å€¼ï¼Œå‰‡é »ç‡ä¹Ÿæ¢å¾©å„²å­˜çš„é »ç‡
                     freqSelectElement.value = currentFreqStored;
                 } else if (defaultFreq && currentStoredValue === defaultFreq) {
                     // å¦‚æœè‡ªå‹•å¡«å……çš„é »ç‡å’Œå„²å­˜çš„ä¸€è‡´ï¼Œä¹Ÿæ¨™è¨˜ç‚ºæ·ºè‰²
                     freqSelectElement.value = defaultFreq;
                 } else if (defaultFreq) {
                    // å¦‚æœæœ‰æ–°çš„åŒ¹é…é …ï¼Œä½†ç”¨æˆ¶æœªå„²å­˜ï¼Œå‰‡è‡ªå‹•å¡«å……ä¸¦æ¨™è¨˜ç‚ºæ·±è‰²
                    freqSelectElement.value = defaultFreq;
                    handleInputEdit({ target: freqSelectElement });
                 }
             }

        }
        
        /**
         * Backspace ä¸€éµæ¸…é™¤é‚è¼¯
         */
        function clearFieldOnBackspace(element) {
            if (event.key === 'Backspace' || event.keyCode === 8) {
                if (element.value.trim().length > 0) {
                    // æ¸…ç©ºæ¬„ä½
                    element.value = '';
                    setElementColor(element, '');
                    
                    // é˜»æ­¢ Backspace çš„é è¨­è¡Œç‚º (ä¾‹å¦‚: è¿”å›ä¸Šä¸€é )
                    event.preventDefault();
                }
            }
        }

        /**
         * æ›´æ–°ç·©è§£è—¥ç‰©é »ç‡ (å°ˆé–€ç”¨æ–¼æ€¥æ•‘è—¥)
         */
        function updateRelieverFreq(drugName, freqSelectElement) {
            // æ€¥æ•‘è—¥çš„é è¨­é »ç‡ç¸½æ˜¯ã€Œéœ€è¦æ™‚ä½¿ç”¨ã€
            freqSelectElement.value = "éœ€è¦æ™‚ä½¿ç”¨";
            handleInputEdit({ target: freqSelectElement });
            
            // ç¢ºä¿æ€¥æ•‘è—¥è¼¸å…¥æ¡†çš„é¡è‰²å’Œå€¼è¢«æ›´æ–°
            handleInputEdit({ target: RELIEVER_MEDS_INPUT });
        }


        /**
         * ç‚ºæ‰€æœ‰ç›¸é—œè¼¸å…¥æ¬„ä½å’Œé¸æ“‡æ¡†æ·»åŠ é¡è‰²æ§åˆ¶åŠè‡ªå‹•å¡«å……é‚è¼¯
         */
        function initializeColorControl() {
            // é¸æ“‡æ‰€æœ‰è¦æ§åˆ¶é¡è‰²çš„ input å’Œ select å…ƒç´ 
            const fields = document.querySelectorAll(
                '#profile-form input, #setup-section input, #medication-form input:not([type="checkbox"]), #medication-form select, #trigger-form textarea, #trigger-form input[type="text"]'
            );

            fields.forEach(field => {
                // åˆå§‹è¼‰å…¥æ™‚ï¼Œå°‡æ‰€æœ‰è¼¸å…¥æ¬„ä½è¨­ç½®ç‚ºæ·ºè‰²
                setElementColor(field, field.value); 
                
                // ç›£è½è¼¸å…¥å’Œé¸æ“‡äº‹ä»¶
                field.addEventListener('input', handleInputEdit);
                field.addEventListener('change', handleInputEdit);
            });
            
            // è¼”åŠ©è—¥ç‰© Checkbox é‚è¼¯
            SUPPORT_MEDS_MAP.forEach(med => {
                const checkbox = document.getElementById(`support-${med.id}`);
                const detailInput = document.getElementById(`support-${med.id}-detail`);

                checkbox.addEventListener('change', () => {
                    const isChecked = checkbox.checked;
                    detailInput.disabled = !isChecked;
                    
                    if (isChecked) {
                        setElementColor(detailInput, detailInput.value); 
                    } else {
                        detailInput.value = '';
                        setElementColor(detailInput, '');
                    }
                });

                detailInput.addEventListener('input', handleInputEdit);
            });
            
            // --- è—¥ç‰©å½ˆæ€§é¸æ“‡èˆ‡é »ç‡å³æ™‚éŸ¿æ‡‰é‚è¼¯ ---

            // ä¸»è—¥ç‰©
            CONTROLLER_MEDS_INPUT.addEventListener('focus', function() { this.select(); });
            CONTROLLER_MEDS_INPUT.addEventListener('blur', function() { loadMedicationValue(this, 'controllerMeds', CONTROLLER_MEDS_FREQ, CONTROLLER_FREQ_SELECT); });
            CONTROLLER_MEDS_INPUT.addEventListener('change', (e) => {
                autoFillFrequency(CONTROLLER_MEDS_INPUT, CONTROLLER_FREQ_SELECT, CONTROLLER_MEDS_FREQ);
            });

            // é¡å¤–è—¥ç‰©
            EXTRA_CONTROLLER_MEDS_INPUT.addEventListener('focus', function() { this.select(); });
            EXTRA_CONTROLLER_MEDS_INPUT.addEventListener('blur', function() { loadMedicationValue(this, 'extraControllerMeds', EXTRA_CONTROLLER_MEDS_FREQ, EXTRA_CONTROLLER_FREQ_SELECT); });
            EXTRA_CONTROLLER_MEDS_INPUT.addEventListener('change', (e) => {
                autoFillFrequency(EXTRA_CONTROLLER_MEDS_INPUT, EXTRA_CONTROLLER_FREQ_SELECT, EXTRA_CONTROLLER_MEDS_FREQ);
            });
            
            // é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘è—¥)
            RELIEVER_MEDS_INPUT.addEventListener('focus', function() { this.select(); });
            RELIEVER_MEDS_INPUT.addEventListener('blur', function() { loadMedicationValue(this, 'relieverMeds', RELIEVER_MEDS_FREQ, RELIEVER_FREQ_SELECT); });
            RELIEVER_MEDS_INPUT.addEventListener('change', (e) => {
                // ç•¶è—¥ç‰©åç¨±æ”¹è®Šæ™‚ï¼Œæ›´æ–°é »ç‡
                updateRelieverFreq(RELIEVER_MEDS_INPUT.value, RELIEVER_FREQ_SELECT);
            });

            // é »ç‡é¸æ“‡æ¡†çš„ change äº‹ä»¶ï¼ˆç”¨æ–¼æ‰‹å‹•é¸æ“‡æ™‚æ›´æ–°é¡è‰²ï¼‰
            CONTROLLER_FREQ_SELECT.addEventListener('change', handleInputEdit);
            EXTRA_CONTROLLER_FREQ_SELECT.addEventListener('change', handleInputEdit);
            RELIEVER_FREQ_SELECT.addEventListener('change', handleInputEdit);
        }
        
        // --- localStorage è¼”åŠ©å‡½æ•¸ ---
        function saveDataToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Error saving ${key} to localStorage:`, error);
                showMessage('å„²å­˜è³‡æ–™å¤±æ•— (LocalStorage éŒ¯èª¤)', 'error');
            }
        }

        function loadDataFromLocalStorage(key, defaultValue = {}) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.warn(`Error loading ${key} from localStorage, returning default.`, error);
                return defaultValue;
            }
        }
        // ------------------------------

        /**
         * é¡¯ç¤ºè¨Šæ¯ box
         */
        function showMessage(message, type = 'info') {
            MESSAGE_BOX.textContent = message;
            MESSAGE_BOX.style.display = 'block';
            MESSAGE_BOX.classList.remove('opacity-0', 'bg-red-500', 'bg-green-500', 'bg-blue-500');

            switch (type) {
                case 'success':
                    MESSAGE_BOX.classList.add('bg-green-600');
                    break;
                case 'error':
                    MESSAGE_BOX.classList.add('bg-red-600');
                    break;
                case 'info':
                default:
                    MESSAGE_BOX.classList.add('bg-blue-600');
                    break;
            }

            setTimeout(() => {
                MESSAGE_BOX.classList.add('opacity-100');
            }, 10);

            setTimeout(() => {
                MESSAGE_BOX.classList.remove('opacity-100');
                setTimeout(() => {
                    MESSAGE_BOX.style.display = 'none';
                }, 300);
            }, 3000);
        }

        /**
         * æ ¹æ“š PEF è®€æ•¸å’Œå€‹äººæœ€ä½³ PEF è¨ˆç®—è¡Œå‹•æ–¹æ¡ˆå€åŸŸ
         */
        function calculateZone(reading, pb) {
            if (!pb || pb <= 0) {
                return { zone: 'æœªå®šç¾©', color: 'bg-gray-400', advice: 'è«‹å…ˆè¨­å®šå€‹äººæœ€ä½³ PEFã€‚' };
            }

            const percentage = (reading / pb) * 100;
            let zone, color, advice;

            if (reading === 0) {
                 zone = 'æœªè¨˜éŒ„PEF';
                 color = 'bg-gray-500';
                 advice = 'æœ¬æ¬¡æœªè¨˜éŒ„PEFï¼Œè«‹æ ¹æ“šACTå’Œç—‡ç‹€è©•ä¼°ã€‚';
            } else if (percentage > 80) {
                zone = 'ç¶ å€ (è‰¯å¥½)';
                color = 'zone-green';
                advice = 'æ°£å–˜æ§åˆ¶è‰¯å¥½ï¼Œç¹¼çºŒç›®å‰çš„æ²»ç™‚è¨ˆç•«ã€‚';
            } else if (percentage > 50) {
                zone = 'é»ƒå€ (æ³¨æ„)';
                color = 'zone-yellow';
                advice = 'å¯èƒ½æœ‰æ°£å–˜æƒ¡åŒ–è·¡è±¡ã€‚è«‹è«®è©¢æ‚¨çš„é†«ç”Ÿä»¥èª¿æ•´è—¥ç‰©åŠ‘é‡ï¼Œä¸¦å¯†åˆ‡æ³¨æ„ç—‡ç‹€ã€‚';
            } else {
                zone = 'ç´…å€ (å±éšª)';
                color = 'zone-red';
                advice = 'é€™æ˜¯é†«ç™‚ç·Šæ€¥æƒ…æ³ï¼ç«‹å³ä½¿ç”¨å¿«é€Ÿç·©è§£è—¥ç‰©ï¼Œä¸¦ç«‹å³å°‹æ±‚é†«ç™‚å”åŠ©æˆ–æ’¥æ‰“ç·Šæ€¥é›»è©±ã€‚';
            }

            return { zone, color, advice, percentage: percentage.toFixed(0) };
        }
        
        /**
         * æ ¹æ“šå‡ºç”Ÿå¹´æœˆæ—¥è¨ˆç®—å¹´é½¡ã€‚
         */
        function calculateAge(dobString) {
            if (!dobString) return null;
            const dob = new Date(dobString);
            if (isNaN(dob.getTime())) return null;

            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            return age >= 0 ? age : 0; 
        }

        /**
         * æ›´æ–°è¨ˆç®—å¹´é½¡çš„é¡¯ç¤ºã€‚
         */
        function updateCalculatedAgeDisplay(dobString) {
            const ageDisplay = document.getElementById('calculated-age');
            const age = calculateAge(dobString);
            
            if (age !== null) {
                ageDisplay.textContent = `${age} æ­²`;
            } else {
                ageDisplay.textContent = 'æœªè¼¸å…¥';
            }
        }
        
        /**
         * è¨ˆç®— ACT (Asthma Control Test) åˆ†æ•¸
         */
        function calculateACTScore() {
            let totalScore = 0;
            let questionsAnswered = 0;
            const form = document.getElementById('asthma-log-form');

            for (let i = 1; i <= 5; i++) {
                const selector = `input[name="act-q${i}"]:checked`;
                const checkedInput = form.querySelector(selector);
                
                if (!checkedInput) {
                    return null; 
                }
                totalScore += parseInt(checkedInput.value, 10);
                questionsAnswered++;
            }

            return questionsAnswered === 5 ? totalScore : null;
        }

        /**
         * æ›´æ–°è¡Œå‹•è¨ˆç•«æŒ‡å—ä¸­çš„ PEF ç¯„åœé¡¯ç¤ºã€‚
         */
        function updateActionPlanRanges(pb) {
            if (pb && pb > 0) {
                const greenMin = Math.ceil(pb * 0.8);
                const yellowMin = Math.ceil(pb * 0.5);

                PEF_GREEN_RANGE_DISPLAY.textContent = `${greenMin} ~ ${pb} L/min (PB çš„ 80% ~ 100%)`;
                PEF_YELLOW_RANGE_DISPLAY.textContent = `${yellowMin} ~ ${greenMin - 1} L/min (PB çš„ 50% ~ 80%)`;
                PEF_RED_RANGE_DISPLAY.textContent = `ä½æ–¼ ${yellowMin} L/min (ä½æ–¼ PB çš„ 50%)`;
            } else {
                 PEF_GREEN_RANGE_DISPLAY.textContent = 'PB çš„ 80% ~ 100%';
                 PEF_YELLOW_RANGE_DISPLAY.textContent = 'PB çš„ 50% ~ 80%';
                 PEF_RED_RANGE_DISPLAY.textContent = 'ä½æ–¼ PB çš„ 50%';
            }
        }


        /**
         * ç¹ªè£½ PEF è¶¨å‹¢åœ–
         */
        function renderPEFChart(logs, pb) {
            const ctx = document.getElementById('pef-chart');

            if (!ctx || !pb || logs.length === 0) {
                 if (pefChart) {
                    pefChart.destroy();
                    pefChart = null;
                 }
                 CHART_CONTAINER.style.display = 'none'; // éš±è—åœ–è¡¨å®¹å™¨
                 return;
            }
            CHART_CONTAINER.style.display = 'block';

            const pefDataForChart = {}; 
            
            logs.forEach(log => {
                const date = new Date(log.timestamp);
                // ä½¿ç”¨ toLocaleDateString ç¢ºä¿æ™‚å€èˆ‡æ—¥æœŸä¸€è‡´
                const dateStr = date.toLocaleDateString('zh-TW'); 
                
                // Process Morning PEF (AM)
                if (log.pefMorning !== null && log.pefMorning > 0) {
                    const key = `${dateStr}-AM`;
                    // åƒ…ä¿ç•™è©²æ—¥ AM å€é–“çš„æœ€é«˜å€¼
                    if (!pefDataForChart[key] || log.pefMorning > pefDataForChart[key].pef) {
                        pefDataForChart[key] = { pef: log.pefMorning, timestamp: log.timestamp, labelSuffix: ' AM' };
                    }
                }

                // Process Evening PEF (PM)
                if (log.pefEvening !== null && log.pefEvening > 0) {
                    const key = `${dateStr}-PM`;
                    // åƒ…ä¿ç•™è©²æ—¥ PM å€é–“çš„æœ€é«˜å€¼
                    if (!pefDataForChart[key] || log.pefEvening > pefDataForChart[key].pef) {
                        pefDataForChart[key] = { pef: log.pefEvening, timestamp: log.timestamp, labelSuffix: ' PM' };
                    }
                }
            });

            // è½‰æ›ç‚ºé™£åˆ—ä¸¦æŒ‰æ™‚é–“æ’åºï¼ˆç”±èˆŠåˆ°æ–°ï¼‰
            let finalChartData = Object.keys(pefDataForChart).map(key => pefDataForChart[key])
                .sort((a, b) => a.timestamp - b.timestamp);


            const dates = finalChartData.map(data => {
                const date = new Date(data.timestamp);
                const monthDay = date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                return `${monthDay}${data.labelSuffix}`;
            });
            const pefValues = finalChartData.map(data => data.pef);
            
            const greenZoneMin = pb * 0.8;
            const yellowZoneMin = pb * 0.5;

            // --- èª¿æ•´åœ–è¡¨å¯¬åº¦ä»¥å•Ÿç”¨æ»¾å‹• ---
            // æ¯å€‹é»çµ¦å®šæœ€å° PIXELS_PER_POINT å¯¬åº¦ï¼Œä¸¦ç¢ºä¿è‡³å°‘ç‚ºå®¹å™¨å¯¬åº¦
            const requiredWidth = Math.max(dates.length * PIXELS_PER_POINT, CHART_CONTAINER.offsetWidth);
            ctx.style.width = `${requiredWidth}px`;
            
            // éŠ·æ¯€èˆŠåœ–è¡¨å¯¦ä¾‹
            if (pefChart) {
                pefChart.destroy();
            }

            // ä½¿ç”¨ Chart.js ç¹ªåœ–è¡¨
            pefChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'PEF è®€æ•¸ (L/min)',
                        borderColor: '#34c759', /* iOS ç¶ è‰² */
                        backgroundColor: 'rgba(52, 199, 89, 0.2)',
                        data: pefValues,
                        tension: 0.2, 
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: pefValues.map(v => {
                            if (v > greenZoneMin) return '#34c759';
                            if (v > yellowZoneMin) return '#ff9500';
                            return '#ff3b30';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    // æ ¹æ“šæ‰€éœ€å¯¬åº¦èª¿æ•´ aspect ratio
                    aspectRatio: requiredWidth / 300, 
                    scales: {
                        y: {
                            min: Math.min(0, Math.min(...pefValues)) - 10,
                            max: pb * 1.1, 
                            title: {
                                display: true,
                                text: 'PEF è®€æ•¸ (L/min)'
                            },
                            ticks: {
                                color: '#4b5563',
                                callback: function(value) {
                                    if (value === pb) return `${value} (PB)`;
                                    if (value === greenZoneMin) return `${value} (80%)`;
                                    if (value === yellowZoneMin) return `${value} (50%)`;
                                    return value;
                                }
                            },
                            grid: {
                                color: function(context) {
                                    const value = context.tick.value;
                                    if (value === pb) return 'rgba(0, 0, 0, 0.7)';
                                    if (value === greenZoneMin) return 'rgba(255, 149, 0, 0.8)'; /* é»ƒå€ç·š */
                                    if (value === yellowZoneMin) return 'rgba(255, 59, 48, 0.8)'; /* ç´…å€ç·š */
                                    return 'rgba(0, 0, 0, 0.1)';
                                },
                                lineWidth: function(context) {
                                    const value = context.tick.value;
                                    if (value === pb || value === greenZoneMin || value === yellowZoneMin) return 2;
                                    return 1;
                                },
                                borderDash: function(context) {
                                    const value = context.tick.value;
                                    if (value === pb || value === greenZoneMin || value === yellowZoneMin) return [5, 5];
                                    return [];
                                },
                            },
                            afterBuildTicks: function(scale) {
                                const values = scale.ticks.map(t => t.value);
                                
                                if (!values.includes(pb)) scale.ticks.push({ value: pb, label: 'æœ€ä½³å€¼' });
                                if (!values.includes(greenZoneMin)) scale.ticks.push({ value: greenZoneMin, label: '80%' });
                                if (!values.includes(yellowZoneMin)) scale.ticks.push({ value: yellowZoneMin, label: '50%' });

                                scale.ticks.sort((a, b) => a.value - b.value);
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'æ—¥æœŸèˆ‡æ™‚æ®µ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: `PEF è¶¨å‹¢åœ– (åŸºæº–: ${pb} L/min)`
                        }
                    }
                }
            });
        }

        /**
         * é¡¯ç¤ºå–®ç­†é¸ä¸­çš„æ­·å²è¨˜éŒ„è©³æƒ…
         * @param {number} index - è¨˜éŒ„åœ¨ allLogs é™£åˆ—ä¸­çš„ç´¢å¼•
         */
        function displaySelectedLog(index) {
            const data = allLogs[index];
            if (!data) {
                DETAILED_LOG_VIEW.classList.add('hidden');
                return;
            }

            const date = new Date(data.timestamp).toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            const actStatus = data.actScore >= 20 ? 'æ§åˆ¶è‰¯å¥½ (Good Control)' :
                              data.actScore >= 16 ? 'éƒ¨åˆ†æ§åˆ¶ (Partial Control)' : 'æ§åˆ¶ä¸ä½³ (Poor Control)';

            DETAILED_LOG_VIEW.innerHTML = `
                <div class="space-y-3">
                    <p class="text-sm font-medium text-gray-700">è¨˜éŒ„æ™‚é–“: <span class="font-bold">${date}</span></p>
                    <div class="p-3 rounded-lg ${data.zoneColor}">
                        <p class="text-lg font-bold">æœ€é«˜ PEF è®€æ•¸: ${data.pefHighest} L/min (${data.zonePercentage}%)</p>
                        <p class="text-sm font-semibold mt-1">è¡Œå‹•å€åŸŸ: ${data.zone}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <p>æ—©æ™¨ PEF: ${data.pefMorning || 'æœªè¨˜éŒ„'}</p>
                        <p>æ™šé–“ PEF: ${data.pefEvening || 'æœªè¨˜éŒ„'}</p>
                        <p>åŸºæº–å€¼ (PB): ${data.personalBestPEF} L/min</p>
                    </div>
                    
                    <div class="border-t pt-3">
                        <p class="text-sm font-medium text-blue-700">ACT è©•åˆ†: <span class="font-bold text-base">${data.actScore} / 25</span></p>
                        <p class="text-xs text-gray-600">æ§åˆ¶è©•ç´š: ${actStatus}</p>
                    </div>
                    
                    <div class="border-t pt-3">
                        <p class="text-sm font-medium text-gray-700">ç—‡ç‹€æˆ–èª˜ç™¼å› ç´ :</p>
                        <p class="text-sm italic pl-2">${data.symptoms || 'ç„¡'}</p>
                    </div>
                </div>
            `;
            DETAILED_LOG_VIEW.classList.remove('hidden');
        }


        /**
         * å„²å­˜å€‹äººåŸºæœ¬è³‡æ–™
         */
        function saveUserProfile(e) {
            e.preventDefault();

            const name = document.getElementById('profile-name').value.trim();
            const dob = PROFILE_DOB_INPUT.value;
            const medicalRecordNumber = document.getElementById('medical-record-number').value.trim(); 
            const attendingPhysician = document.getElementById('attending-physician').value.trim();
            const emergencyPhone = document.getElementById('emergency-phone').value.trim();
            
            if (!name) {
                showMessage('éŒ¯èª¤ï¼šå§“åç‚ºå¿…å¡«æ¬„ä½ã€‚', 'error');
                return;
            }
            if (!medicalRecordNumber) {
                showMessage('éŒ¯èª¤ï¼šç—…æ­·è™Ÿç‚ºå¿…å¡«æ¬„ä½ã€‚', 'error');
                return;
            }

            const calculatedAge = calculateAge(dob);

            userProfile = {
                name,
                dob,
                calculatedAge, 
                medicalRecordNumber, 
                attendingPhysician, 
                emergencyName: DEFAULT_VALUE,
                emergencyPhone: emergencyPhone || DEFAULT_EMERGENCY_PHONE,
                updatedAt: Date.now()
            };

            saveDataToLocalStorage('asthma_profile', userProfile);
            loadUserProfile(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡è‰²
            showMessage('å€‹äººè³‡æ–™å·²æˆåŠŸå„²å­˜ï¼', 'success');
            updateLastUpdatedTime();
        }

        /**
         * è¼‰å…¥å€‹äººåŸºæœ¬è³‡æ–™ (ä¸¦å°‡å€¼å¡«å…¥è¼¸å…¥æ¡†)
         */
        function loadUserProfile() {
            userProfile = loadDataFromLocalStorage('asthma_profile');
            const data = userProfile;

            const dob = data.dob || '';
            const phone = data.emergencyPhone || DEFAULT_EMERGENCY_PHONE; // è¨­ç½®é è¨­é›»è©±
            const inputs = {
                'profile-name': data.name || '',
                'profile-dob': dob,
                'medical-record-number': data.medicalRecordNumber || '',
                'attending-physician': data.attendingPhysician || '',
                'emergency-phone': phone,
            };

            for (const id in inputs) {
                const element = document.getElementById(id);
                if (element) {
                    element.value = inputs[id];
                    setElementColor(element, inputs[id]);
                }
            }
            
            updateCalculatedAgeDisplay(dob);
            EMERGENCY_PHONE_DISPLAY.innerHTML = phone ? `<a href="tel:${phone}" class="font-bold text-lg underline hover:text-red-700">${phone}</a>` : DEFAULT_VALUE;
        }


        /**
         * å„²å­˜ç•¶å‰è—¥ç‰©è¨ˆç•«
         */
        function saveMedicationRecord(e) {
            e.preventDefault();

            const controllerMeds = CONTROLLER_MEDS_INPUT.value.trim();
            const controllerFreq = CONTROLLER_FREQ_SELECT.value;
            const extraControllerMeds = EXTRA_CONTROLLER_MEDS_INPUT.value.trim(); // ç¬¬äºŒçµ„è—¥ç‰©
            const extraControllerFreq = EXTRA_CONTROLLER_FREQ_SELECT.value; // ç¬¬äºŒçµ„é »ç‡
            const relieverMeds = RELIEVER_MEDS_INPUT.value.trim(); 
            const relieverFreq = RELIEVER_FREQ_SELECT.value;
            
            // æ”¶é›†è¼”åŠ©è—¥ç‰©ç´°ç¯€
            const supportDetails = {};
            SUPPORT_MEDS_MAP.forEach(med => {
                const checkbox = document.getElementById(`support-${med.id}`);
                const detailInput = document.getElementById(`support-${med.id}-detail`);
                
                if (checkbox.checked) {
                    const detail = detailInput.value.trim();
                    // å„²å­˜ç´°é …æˆ– "Checked"
                    supportDetails[med.id] = detail || "Checked"; 
                }
            });
            
            // æª¢æŸ¥ç¬¬ä¸€çµ„è—¥ç‰©é‚è¼¯
            if (!controllerMeds && controllerFreq && controllerFreq !== 'åƒ…éœ€è¦æ™‚ä½¿ç”¨' && controllerFreq !== '') {
                if (confirm(`æ‚¨æ²’æœ‰è¼¸å…¥é•·æœŸæ§åˆ¶è—¥ç‰©åç¨±ï¼Œä½†é¸æ“‡äº†å¸¸è¦ä½¿ç”¨é »ç‡ã€Œ${controllerFreq}ã€ã€‚ç¢ºå®šè¦å„²å­˜å—ï¼Ÿ`)) {
                     // ç¹¼çºŒ
                } else {
                    return; // çµ‚æ­¢å„²å­˜
                }
            }
            
             // æª¢æŸ¥ç¬¬äºŒçµ„è—¥ç‰©é‚è¼¯
            if (!extraControllerMeds && extraControllerFreq && extraControllerFreq !== '') {
                if (confirm(`æ‚¨æ²’æœ‰è¼¸å…¥é¡å¤–ä¿é¤Šè—¥ç‰©åç¨±ï¼Œä½†é¸æ“‡äº†å¸¸è¦ä½¿ç”¨é »ç‡ã€Œ${extraControllerFreq}ã€ã€‚ç¢ºå®šè¦å„²å­˜å—ï¼Ÿ`)) {
                     // ç¹¼çºŒ
                } else {
                    return; // çµ‚æ­¢å„²å­˜
                }
            }
            
            // è™•ç†æ€¥æ•‘è—¥ç‰©çš„å„²å­˜é‚è¼¯
            let finalRelieverMeds = relieverMeds || DEFAULT_VALUE;
            let finalRelieverFreq = relieverFreq || DEFAULT_VALUE;

            if (relieverMeds === 'åŒä¿é¤Šè—¥ç‰©') {
                 finalRelieverMeds = `åŒä¿é¤Šè—¥ç‰© (${controllerMeds || 'åç¨±æœªè¨˜éŒ„'})`;
            }


            medicationPlan = {
                controllerMeds: controllerMeds || DEFAULT_VALUE,
                controllerFreq: controllerFreq || DEFAULT_VALUE,
                extraControllerMeds: extraControllerMeds || DEFAULT_VALUE, // æ–°å¢
                extraControllerFreq: extraControllerFreq || DEFAULT_VALUE, // æ–°å¢
                relieverMeds: finalRelieverMeds,
                relieverFreq: finalRelieverFreq,
                supportDetails: supportDetails, // å„²å­˜ç´°ç¯€å°è±¡
                updatedAt: Date.now()
            };

            saveDataToLocalStorage('asthma_meds', medicationPlan);
            
            loadMedicationRecord(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡è‰²å’Œé¡¯ç¤º
            
            showMessage('ç”¨è—¥è¨ˆç•«å·²æˆåŠŸå„²å­˜ï¼', 'success');
            updateLastUpdatedTime();
        }

        /**
         * è¼‰å…¥ç•¶å‰è—¥ç‰©è¨ˆç•«
         */
        function loadMedicationRecord() {
            medicationPlan = loadDataFromLocalStorage('asthma_meds', { supportDetails: {} });
            const data = medicationPlan;
            const supportDetails = data.supportDetails || {};
            const defaultMeds = DEFAULT_VALUE;

            // è¼‰å…¥è¼¸å…¥æ¡†å’Œé¸æ“‡æ¡†ä¸¦è¨­å®šé¡è‰² (ä¸»è—¥ç‰©)
            CONTROLLER_MEDS_INPUT.value = data.controllerMeds && data.controllerMeds !== defaultMeds ? data.controllerMeds : '';
            setElementColor(CONTROLLER_MEDS_INPUT, CONTROLLER_MEDS_INPUT.value);
            
            CONTROLLER_FREQ_SELECT.value = data.controllerFreq || '';
            setElementColor(CONTROLLER_FREQ_SELECT, CONTROLLER_FREQ_SELECT.value);
            
            // è¼‰å…¥è¼¸å…¥æ¡†å’Œé¸æ“‡æ¡†ä¸¦è¨­å®šé¡è‰² (é¡å¤–è—¥ç‰©)
            EXTRA_CONTROLLER_MEDS_INPUT.value = data.extraControllerMeds && data.extraControllerMeds !== defaultMeds ? data.extraControllerMeds : '';
            setElementColor(EXTRA_CONTROLLER_MEDS_INPUT, EXTRA_CONTROLLER_MEDS_INPUT.value);
            
            EXTRA_CONTROLLER_FREQ_SELECT.value = data.extraControllerFreq || '';
            setElementColor(EXTRA_CONTROLLER_FREQ_SELECT, EXTRA_CONTROLLER_FREQ_SELECT.value);
            
            // è¼‰å…¥æ€¥æ•‘è—¥ç‰©
            RELIEVER_MEDS_INPUT.value = data.relieverMeds && data.relieverMeds !== defaultMeds ? data.relieverMeds : '';
            setElementColor(RELIEVER_MEDS_INPUT, RELIEVER_MEDS_INPUT.value);
            
            RELIEVER_FREQ_SELECT.value = data.relieverFreq || 'éœ€è¦æ™‚ä½¿ç”¨'; // é è¨­å€¼
            setElementColor(RELIEVER_FREQ_SELECT, RELIEVER_FREQ_SELECT.value);
            
            // --- è¼‰å…¥è¼”åŠ©è—¥ç‰© ---
            const supportSummary = [];
            SUPPORT_MEDS_MAP.forEach(med => {
                const checkbox = document.getElementById(`support-${med.id}`);
                const detailInput = document.getElementById(`support-${med.id}-detail`);
                const savedDetail = supportDetails[med.id] || '';

                if (savedDetail) {
                    checkbox.checked = true;
                    detailInput.disabled = false;
                    detailInput.value = savedDetail === "Checked" ? '' : savedDetail;
                    setElementColor(detailInput, savedDetail);
                    
                    // å»ºç«‹é¡¯ç¤º summary
                    const labelText = med.label;
                    supportSummary.push(savedDetail === "Checked" ? labelText : `${labelText}: ${savedDetail}`);
                } else {
                    checkbox.checked = false;
                    detailInput.disabled = true;
                    detailInput.value = '';
                    setElementColor(detailInput, '');
                }
            });


            // æ›´æ–°é¡¯ç¤ºå€
            CURRENT_CONTROLLER_DISPLAY.textContent = data.controllerMeds || DEFAULT_VALUE;
            CURRENT_FREQ_DISPLAY.textContent = data.controllerFreq || DEFAULT_VALUE;
            CURRENT_EXTRA_CONTROLLER_DISPLAY.textContent = data.extraControllerMeds || DEFAULT_VALUE;
            CURRENT_EXTRA_FREQ_DISPLAY.textContent = data.extraControllerFreq || DEFAULT_VALUE;
            CURRENT_RELIEVER_DISPLAY.textContent = data.relieverMeds || DEFAULT_VALUE;
            CURRENT_SUPPORT_DISPLAY.textContent = supportSummary.join('; ') || DEFAULT_VALUE;
        }
        
        /**
         * å„²å­˜èª˜ç™¼å› å­è³‡è¨Š (é‚è¼¯ä¸è®Š)
         */
        function saveTriggerInfo(e) {
            e.preventDefault();
            
            const selectedTriggers = Array.from(TRIGGER_OPTIONS_CONTAINER.querySelectorAll('input[name="trigger"]:checked'))
                .map(checkbox => checkbox.value);

            const controlAdvice = CONTROL_ADVICE_TEXTAREA.value.trim();
            
            triggerInfo = {
                knownTriggers: selectedTriggers,
                controlAdvice: controlAdvice || DEFAULT_VALUE,
                updatedAt: Date.now()
            };

            saveDataToLocalStorage('asthma_triggers', triggerInfo);
            
            loadTriggerInfo(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡è‰²å’Œé¡¯ç¤º
            
            showMessage('èª˜ç™¼å› å­è³‡è¨Šå·²æˆåŠŸå„²å­˜ï¼', 'success');
            updateLastUpdatedTime();
        }

        /**
         * è¼‰å…¥èª˜ç™¼å› å­è³‡è¨Š
         */
        function loadTriggerInfo() {
            triggerInfo = loadDataFromLocalStorage('asthma_triggers', { knownTriggers: [] });
            const data = triggerInfo;
            
            const selectedTriggers = Array.isArray(data.knownTriggers) ? data.knownTriggers : [];
            TRIGGER_OPTIONS_CONTAINER.querySelectorAll('input[name="trigger"]').forEach(checkbox => {
                checkbox.checked = selectedTriggers.includes(checkbox.value);
            });

            CONTROL_ADVICE_TEXTAREA.value = data.controlAdvice && data.controlAdvice !== DEFAULT_VALUE ? data.controlAdvice : '';
            setElementColor(CONTROL_ADVICE_TEXTAREA, CONTROL_ADVICE_TEXTAREA.value);
            
            CURRENT_TRIGGERS_DISPLAY.textContent = selectedTriggers.join(', ') || DEFAULT_VALUE;
        }


        /**
         * å„²å­˜å€‹äººæœ€ä½³ PEF åŸºæº– (é‚è¼¯ä¸è®Š)
         */
        function savePersonalBest() {
            
            const pbInput = document.getElementById('pb-pef-input');
            const newPB = parseInt(pbInput.value, 10);

            if (isNaN(newPB) || newPB <= 0) {
                showMessage('è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„ PEF æ•¸å€¼ (> 0)ã€‚', 'error');
                return;
            }
            
            const pbData = {
                personalBestPEF: newPB,
                updatedAt: Date.now()
            };

            saveDataToLocalStorage('asthma_pb', pbData);

            personalBestPEF = newPB;
            
            loadPersonalBest(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡è‰²å’Œé¡¯ç¤º
            
            showMessage(`å€‹äººæœ€ä½³ PEF (${newPB}) å·²æˆåŠŸå„²å­˜ï¼`, 'success');
            
            LOG_SECTION.classList.remove('hidden');
            updateActionPlanRanges(newPB);
            loadLogs();
            updateLastUpdatedTime();
        }

        /**
         * è¼‰å…¥å€‹äººæœ€ä½³ PEF åŸºæº– (ä¸¦å°‡å€¼å¡«å…¥è¼¸å…¥æ¡†)
         */
        function loadPersonalBest() {
            const pbData = loadDataFromLocalStorage('asthma_pb');
            personalBestPEF = pbData.personalBestPEF || null;
            const pbInput = document.getElementById('pb-pef-input');


            if (personalBestPEF) {
                pbInput.value = personalBestPEF;
                setElementColor(pbInput, pbInput.value);
                
                PB_VALUE_DISPLAY.textContent = `${personalBestPEF} L/min`;
                LOG_SECTION.classList.remove('hidden');
                updateActionPlanRanges(personalBestPEF);
            } else {
                pbInput.value = '';
                setElementColor(pbInput, '');
                PB_VALUE_DISPLAY.textContent = 'æœªè¨­å®š';
                LOG_SECTION.classList.add('hidden');
            }
        }

        /**
         * å„²å­˜æ¯æ—¥ PEF è¨˜éŒ„ (ACTå¿…å¡«ï¼ŒPEFé¸å¡«)
         */
        document.getElementById('asthma-log-form').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!personalBestPEF) {
                showMessage('éŒ¯èª¤ï¼šè«‹å…ˆåœ¨æ­¥é©Ÿ 2 è¨­å®šæ‚¨çš„å€‹äººæœ€ä½³ PEF åŸºæº–ï¼', 'error');
                return;
            }

            const pefMorning = parseInt(document.getElementById('pef-morning').value, 10);
            const pefEvening = parseInt(document.getElementById('pef-evening').value, 10);
            const symptoms = document.getElementById('symptoms').value.trim();
            const actScore = calculateACTScore();
            
            const pefMorningValid = !isNaN(pefMorning) && pefMorning > 0;
            const pefEveningValid = !isNaN(pefEvening) && pefEvening > 0;
            
            
            // æª¢æŸ¥ ACT æ˜¯å¦å®Œæˆ (ACT å¿…å¡«)
            if (actScore === null) {
                showMessage('éŒ¯èª¤: è«‹å®Œæˆæ‰€æœ‰æ°£å–˜æ§åˆ¶æ¸¬è©¦ (ACT) å‹¾é¸é¡Œï¼', 'error');
                return;
            }

            // PEF è®€æ•¸ç‚ºé¸å¡«ï¼Œåªæª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å€¼ (ä¸éœ€è¦å¼·åˆ¶è¼¸å…¥)
            // ç¢ºå®šæœ€é«˜çš„ PEF å€¼ (å¦‚æœéƒ½æ²’æœ‰ï¼Œå‰‡ç‚º 0)
            const pefHighest = Math.max(pefMorningValid ? pefMorning : 0, pefEveningValid ? pefEvening : 0);
            
            const zoneData = calculateZone(pefHighest, personalBestPEF);
            
            const newLog = {
                pefMorning: pefMorningValid ? pefMorning : null,
                pefEvening: pefEveningValid ? pefEvening : null,
                pefHighest: pefHighest,
                symptoms: symptoms,
                actScore: actScore, 
                personalBestPEF: personalBestPEF, 
                zone: zoneData.zone,
                zonePercentage: zoneData.percentage,
                zoneColor: zoneData.color,
                advice: zoneData.advice,
                timestamp: Date.now() 
            };

            let logs = loadDataFromLocalStorage('asthma_logs', []);
            logs.unshift(newLog);
            saveDataToLocalStorage('asthma_logs', logs);

            showMessage(`è¨˜éŒ„æˆåŠŸï¼ACT åˆ†æ•¸ç‚º ${actScore}/25ã€‚`, 'success');
            
            // æ¸…ç©ºç•¶å‰ PEF/ç—‡ç‹€/ACT è¼¸å…¥ï¼Œæº–å‚™è¨˜éŒ„ä¸‹ä¸€ç­†
            document.getElementById('pef-morning').value = '';
            document.getElementById('pef-evening').value = '';
            document.getElementById('symptoms').value = '';
            
            const form = document.getElementById('asthma-log-form');
            form.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            loadLogs();
            updateLastUpdatedTime();
        });

        /**
         * è¼‰å…¥ä¸¦æ¸²æŸ“æ­·å²è¨˜éŒ„ (é‚è¼¯ä¸è®Š)
         */
        function loadLogs() {
            const emptyMsg = document.getElementById('empty-log-msg');
            const logSelector = LOG_SELECTOR;
            logSelector.innerHTML = '';

            allLogs = loadDataFromLocalStorage('asthma_logs', []); 

            if (allLogs.length === 0) {
                emptyMsg.classList.remove('hidden');
                LOG_VIEWER_CONTROLS.classList.add('hidden');
                DETAILED_LOG_VIEW.classList.add('hidden');
                renderPEFChart(allLogs, personalBestPEF); 
                return;
            }
            emptyMsg.classList.add('hidden');
            LOG_VIEWER_CONTROLS.classList.remove('hidden');
            DETAILED_LOG_VIEW.classList.remove('hidden');


            allLogs.forEach((data, index) => {
                const date = new Date(data.timestamp).toLocaleString('zh-TW', {
                    year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `è¨˜éŒ„ #${allLogs.length - index} (${date}) - æœ€é«˜PEF: ${data.pefHighest}`;
                logSelector.appendChild(option);
            });

            if (allLogs.length > 0) {
                logSelector.value = 0;
                displaySelectedLog(0);
            }

            renderPEFChart(allLogs, personalBestPEF);
        }
        
        /**
         * æ›´æ–°é é¢åº•éƒ¨çš„æœ€å¾Œæ›´æ–°æ™‚é–“ (é‚è¼¯ä¸è®Š)
         */
        function updateLastUpdatedTime() {
            const now = new Date();
            LAST_UPDATED_DISPLAY.textContent = now.toLocaleString('zh-TW', {
                year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }


        /**
         * åŒ¯å‡ºæ‰€æœ‰æ•¸æ“šåˆ° Google è¡¨å–® (åŒ…å«æ‰€æœ‰è—¥ç‰©æ¬„ä½)
         */
        function exportToGoogleForm() {
            if (EXPORT_BUTTON.disabled) {
                showMessage('è«‹å‹¿é€£çºŒé»æ“Šï¼Œè«‹ç¨å€™...', 'info');
                return;
            }
            EXPORT_BUTTON.disabled = true;
            const originalText = EXPORT_BUTTON.textContent;
            EXPORT_BUTTON.textContent = 'åŒ¯å‡ºä¸­... è«‹ç¨å€™';
            
            setTimeout(() => {
                EXPORT_BUTTON.disabled = false;
                EXPORT_BUTTON.textContent = originalText;
            }, 5000); 
            
            if (!userProfile.name || !userProfile.medicalRecordNumber) {
                showMessage('éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ã€Œå€‹äººè³‡è¨Šã€å€å¡Šå¡«å¯«å§“åå’Œç—…æ­·è™Ÿä¸¦å„²å­˜ã€‚', 'error');
                EXPORT_BUTTON.disabled = false;
                EXPORT_BUTTON.textContent = originalText;
                return;
            }

            if (!personalBestPEF) {
                showMessage('éŒ¯èª¤: è«‹å…ˆè¨­å®šå€‹äººæœ€ä½³ PEF åŸºæº–ã€‚', 'error');
                EXPORT_BUTTON.disabled = false;
                EXPORT_BUTTON.textContent = originalText;
                return;
            }
            if (allLogs.length === 0) {
                showMessage('éŒ¯èª¤: æ­·å²è¨˜éŒ„ç‚ºç©ºï¼Œè«‹å…ˆè¨˜éŒ„ PEF è®€æ•¸ã€‚', 'error');
                EXPORT_BUTTON.disabled = false;
                EXPORT_BUTTON.textContent = originalText;
                return;
            }

            const FORM_URL = GOOGLE_FORM_CONFIG.FORM_BASE_URL;
            const ENTRY = GOOGLE_FORM_CONFIG.ENTRY_IDS;
            let params = [];
            
            const logsText = allLogs.map((log, index) => {
                const date = new Date(log.timestamp).toLocaleString('zh-TW');
                const actInfo = log.actScore !== undefined ? `ACT è©•åˆ†: ${log.actScore} / 25\n` : ''; 
                const pefDetails = [];
                if (log.pefMorning) pefDetails.push(`æ—©: ${log.pefMorning}`);
                if (log.pefEvening) pefDetails.push(`æ™š: ${log.pefEvening}`);
                
                return `--- #${allLogs.length - index} ---\n` +
                       `æ—¥æœŸ: ${date}\n` +
                       `æœ€é«˜ PEF è®€æ•¸: ${log.pefHighest} L/min (${log.zonePercentage}%)\n` +
                       `PEF ç´°ç¯€: ${pefDetails.join(', ')}\n` +
                       actInfo + 
                       `è¡Œå‹•å€åŸŸ: ${log.zone}\n` +
                       `å»ºè­°: ${log.advice}\n`;
            }).join('\n');
            
            // æ ¼å¼åŒ–è¼”åŠ©è—¥ç‰©ç´°ç¯€
            const supportMedsExport = SUPPORT_MEDS_MAP.map(med => {
                const savedDetail = medicationPlan.supportDetails[med.id];
                if (savedDetail) {
                    const label = med.label;
                    return savedDetail === "Checked" ? label : `${label}: ${savedDetail}`;
                }
                return null;
            }).filter(item => item !== null).join('; ');


            params.push(`${ENTRY.USER_ID}=${encodeURIComponent('LOCAL_STANDALONE')}`); 
            params.push(`${ENTRY.NAME}=${encodeURIComponent(userProfile.name || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.AGE}=${encodeURIComponent(userProfile.calculatedAge || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.DOB}=${encodeURIComponent(userProfile.dob || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.RECORD_NO}=${encodeURIComponent(userProfile.medicalRecordNumber || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.PHYSICIAN}=${encodeURIComponent(userProfile.attendingPhysician || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.EMERGENCY_CONTACT}=${encodeURIComponent(userProfile.emergencyName || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.EMERGENCY_PHONE}=${encodeURIComponent(userProfile.emergencyPhone || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.PB_PEF}=${encodeURIComponent(personalBestPEF)}`);
            params.push(`${ENTRY.CONTROLLER_MEDS}=${encodeURIComponent(medicationPlan.controllerMeds || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.CONTROLLER_FREQ}=${encodeURIComponent(medicationPlan.controllerFreq || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.EXTRA_CONTROLLER_MEDS}=${encodeURIComponent(medicationPlan.extraControllerMeds || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.EXTRA_CONTROLLER_FREQ}=${encodeURIComponent(medicationPlan.extraControllerFreq || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.RELIEVER_MEDS}=${encodeURIComponent(medicationPlan.relieverMeds || DEFAULT_VALUE)}`);
            params.push(`${ENTRY.RELIEVER_TYPE}=${encodeURIComponent(medicationPlan.relieverFreq || DEFAULT_VALUE)}`); // å‚³è¼¸é »ç‡è€Œéé¡å‹
            params.push(`${ENTRY.SUPPORT_MEDS}=${encodeURIComponent(supportMedsExport || DEFAULT_VALUE)}`); // å‚³è¼¸æ ¼å¼åŒ–çš„è¼”åŠ©è—¥ç‰©
            params.push(`${ENTRY.KNOWN_TRIGGERS}=${encodeURIComponent(Array.isArray(triggerInfo.knownTriggers) ? triggerInfo.knownTriggers.join(', ') : DEFAULT_VALUE)}`); 
            params.push(`${ENTRY.LOG_HISTORY}=${encodeURIComponent(logsText)}`);

            const finalUrl = FORM_URL + params.join('&');
            window.open(finalUrl, '_blank');

            showMessage('æ•¸æ“šå·²åŒ¯å‡ºåˆ° Google è¡¨å–®ã€‚è«‹åœ¨æ–°çš„è¦–çª—ä¸­ç¢ºèªä¸¦æäº¤ã€‚', 'success');
        }


        /**
         * åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
         */
        function initApp() {
            initializeColorControl(); // å„ªå…ˆåˆå§‹åŒ–é¡è‰²æ§åˆ¶
            loadUserProfile();
            loadPersonalBest(); 
            loadMedicationRecord();
            loadTriggerInfo();
            loadLogs();

            updateLastUpdatedTime(); 
            
            PRIVACY_TOGGLE.addEventListener('click', () => {
                const isExpanded = PRIVACY_CONTENT.classList.toggle('expanded');
                TOGGLE_ICON.textContent = isExpanded ? 'â–²' : 'â–¼';
                PRIVACY_TOGGLE.setAttribute('aria-expanded', isExpanded);
            });
            LOG_SELECTOR.addEventListener('change', (e) => {
                displaySelectedLog(e.target.value);
            });
            
            ACT_SCORE_DISPLAY_BLOCK.classList.add('hidden');
        }

        // ç¶å®šäº‹ä»¶ç›£è½å™¨
        document.getElementById('save-pb-btn').addEventListener('click', savePersonalBest);
        MEDICATION_FORM.addEventListener('submit', saveMedicationRecord);
        PROFILE_FORM.addEventListener('submit', saveUserProfile);
        TRIGGER_FORM.addEventListener('submit', saveTriggerInfo); 
        PROFILE_DOB_INPUT.addEventListener('change', (e) => updateCalculatedAgeDisplay(e.target.value));
        EXPORT_BUTTON.addEventListener('click', exportToGoogleForm);

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = initApp;

    </script>
</body>
</html>