<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°£å–˜æ—¥èªŒ V49 - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f2f2f7; color: #1c1c1e; font-size: 15px; }
        .app-card { background-color: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e5e5ea; overflow: hidden; }
        .list-row { padding: 12px 16px; border-bottom: 0.5px solid #e5e5ea; display: flex; flex-direction: column; gap: 4px; }
        input:not([type="checkbox"]), select, textarea { border: 1px solid #d1d1d6 !important; padding: 10px 12px !important; border-radius: 6px !important; font-size: 16px; width: 100%; }
        input:disabled { background-color: #f2f2f7 !important; color: #8e8e93 !important; cursor: not-allowed; border: 1px dashed #d1d1d6 !important; }
        .zone-green { background-color: #34c759; color: white; border-radius: 8px; padding: 16px; }
        .zone-yellow { background-color: #ff9500; color: white; border-radius: 8px; padding: 16px; }
        .zone-red { background-color: #ff3b30; color: white; border-radius: 8px; padding: 16px; }
        #chart-container { width: 100%; height: 320px; padding: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .chart-wrapper { min-width: 100%; height: 260px; }
        .act-question { padding: 12px; border-bottom: 1px solid #f2f2f7; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .collapsible-content.expanded { max-height: 1000px; transition: max-height 0.6s ease-in; }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="app" class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ</h1>
        <h2 class="text-base text-gray-600 mb-6 border-b pb-2 font-medium">ä¸‰è»ç¸½é†«é™¢ èƒ¸è…”å…§ç§‘</h2>

        <form id="profile-form">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 ml-2">A. å€‹äººè³‡è¨Šèˆ‡é†«ç™‚è¯çµ¡</h2>
            <div class="app-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">å§“å (å¿…å¡«)</label><input type="text" id="p-name" required></div>
                    <div><label class="text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="p-dob"></div>
                </div>
                <div class="list-row bg-indigo-50"><p>è¶³æ­²å¹´é½¡: <span id="display-age" class="font-bold text-indigo-800">--</span></p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">ç—…æ­·è™Ÿ (å¿…å¡«)</label><input type="text" id="p-record" required></div>
                    <div><label class="text-sm font-medium text-gray-700">ä¸»æ²»é†«å¸«</label><input type="text" id="p-doc"></div>
                </div>
                <div class="list-row"><label class="text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡é›»è©±</label><input type="tel" id="p-phone"></div>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜å€‹äººè³‡æ–™</button>
        </form>

        <form id="meds-form">
            <h2 class="text-xl font-semibold text-purple-700 mb-3 ml-2">B. è—¥ç‰©è¨ˆç•«</h2>
            <div class="app-card">
                <div class="list-row">
                    <label class="font-bold">é•·æœŸæ§åˆ¶è—¥ç‰© (ä¿é¤Š)</label>
                    <input type="text" id="m-main" list="list-main" placeholder="é¸æ“‡æˆ–è¼¸å…¥è—¥ç‰©">
                    <select id="f-main" class="mt-2"><option value="">é¸æ“‡é »ç‡</option><option value="åƒ…éœ€è¦æ™‚ä½¿ç”¨">åƒ…éœ€è¦æ™‚ä½¿ç”¨</option><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡">æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„äºŒæ¬¡">æ¯æ—¥æ—©æ™šå„äºŒæ¬¡</option></select>
                </div>
                <div class="list-row"><label class="font-bold">é¡å¤–ä¿é¤Šè—¥ç‰©</label><input type="text" id="m-extra" list="list-extra" placeholder="é¸æ“‡æˆ–è¼¸å…¥è—¥ç‰©"><select id="f-extra" class="mt-2"><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option></select></div>
                <div class="list-row"><label class="font-bold">é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘)</label><input type="text" id="m-reliever" list="list-reliever" placeholder="é¸æ“‡æˆ–è¼¸å…¥è—¥ç‰©"><select id="f-reliever" class="mt-2"><option value="éœ€è¦æ™‚ä½¿ç”¨">éœ€è¦æ™‚ä½¿ç”¨</option><option value="ä¾æŒ‡ç¤ºä½¿ç”¨">ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º</option></select></div>
                <div id="check-list" class="list-row space-y-2 bg-gray-50 py-3">
                    <label class="font-bold text-purple-800">å…¶ä»–è¼”åŠ©è—¥ç‰©ï¼š</label>
                    <label class="flex items-center space-x-3 text-sm"><input type="checkbox" class="med-check w-5 h-5" value="c1"><span>èŒ¶é¹¼é¡è—¥ç‰© (å¦‚XANTHIUMï¼ŒTHOIN)</span></label>
                    <label class="flex items-center space-x-3 text-sm"><input type="checkbox" class="med-check w-5 h-5" value="c2"><span>ç™½ä¸‰çƒ¯ç´ å—é«”æ‹®æŠ—åŠ‘ (å¦‚SINGULAIR)</span></label>
                    <label class="flex items-center space-x-3 text-sm"><input type="checkbox" class="med-check w-5 h-5" value="c3"><span>å£æœæ”¯æ°£ç®¡æ“´å¼µåŠ‘ (å¦‚MEPTINï¼ŒLUNGTEC)</span></label>
                </div>
            </div>
            <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜ç”¨è—¥è¨ˆç•«</button>
        </form>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-orange-600 mb-3 ml-2">C. æ°£å–˜æ§åˆ¶æ¸¬é©— (éå»å››é€±) (ACT)</h2>
            <div class="app-card">
                <div id="act-questions">
                    <div class="act-question"><label class="block text-sm mb-1">1. å½±éŸ¿å·¥ä½œ/å­¸æ ¡ç¨‹åº¦ï¼Ÿ</label><select class="act-q"><option value="" selected disabled>-- è«‹é¸æ“‡ --</option><option value="1">1åˆ† (ç¸½æ˜¯)</option><option value="2">2åˆ† (å¤§éƒ¨åˆ†)</option><option value="3">3åˆ† (æœ‰æ™‚)</option><option value="4">4åˆ† (å¾ˆå°‘)</option><option value="5">5åˆ† (å®Œå…¨æ²’)</option></select></div>
                    <div class="act-question"><label class="block text-sm mb-1">2. æ„Ÿè¦ºå‘¼å¸çŸ­ä¿ƒçš„é »ç‡ï¼Ÿ</label><select class="act-q"><option value="" selected disabled>-- è«‹é¸æ“‡ --</option><option value="1">1åˆ† (æ¯å¤©ä¸€æ¬¡+)</option><option value="2">2åˆ† (æ¯å¤©ä¸€æ¬¡)</option><option value="3">3åˆ† (æ¯é€±3-6æ¬¡)</option><option value="4">4åˆ† (æ¯é€±1-2æ¬¡)</option><option value="5">5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                    <div class="act-question"><label class="block text-sm mb-1">3. å› æ°£å–˜è€Œåœ¨åŠå¤œé†’ä¾†ï¼Ÿ</label><select class="act-q"><option value="" selected disabled>-- è«‹é¸æ“‡ --</option><option value="1">1åˆ† (æ¯é€±4æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯é€±2-3æ¬¡)</option><option value="3">3åˆ† (æ¯é€±ä¸€æ¬¡)</option><option value="4">4åˆ† (æ¯é€±å°‘æ–¼ä¸€æ¬¡)</option><option value="5">5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                    <div class="act-question"><label class="block text-sm mb-1">4. ä½¿ç”¨æ€¥æ•‘è—¥ç‰©çš„é »ç‡ï¼Ÿ</label><select class="act-q"><option value="" selected disabled>-- è«‹é¸æ“‡ --</option><option value="1">1åˆ† (æ¯å¤©3æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯å¤©1-2æ¬¡)</option><option value="3">3åˆ† (æ¯é€±2-3æ¬¡)</option><option value="4">4åˆ† (æ¯é€±1æ¬¡ä»¥ä¸‹)</option><option value="5">5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                    <div class="act-question"><label class="block text-sm mb-1">5. æ‚¨è‡ªè¦ºéå»å››é€±æ§åˆ¶ç‹€æ³ï¼Ÿ</label><select class="act-q"><option value="" selected disabled>-- è«‹é¸æ“‡ --</option><option value="1">1åˆ† (ä¸ç†æƒ³)</option><option value="2">2åˆ† (æ™®é€š)</option><option value="3">3åˆ† (é‚„å¯ä»¥)</option><option value="4">4åˆ† (è‰¯å¥½)</option><option value="5">5åˆ† (å®Œå…¨æ§åˆ¶)</option></select></div>
                </div>
                <div class="p-4 bg-orange-50 space-y-1">
                    <div class="flex justify-between items-center"><span class="font-bold">ACT ç¸½åˆ†ï¼š<span id="act-total">--</span></span><span id="act-status" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-400 text-white">å°šæœªå®Œæˆ</span></div>
                    <p id="act-save-time" class="text-xs text-gray-500">ä¸Šæ¬¡å„²å­˜æ™‚é–“: å°šæœªç´€éŒ„</p>
                    <p class="text-xs text-red-600 font-bold">âš ï¸ æé†’ï¼šè‹¥æ‚¨çš„æ°£å–˜ç—‡ç‹€æœ‰è®ŠåŒ–ï¼Œè«‹é‡æ–°å¡«å¯«ä¸¦é»æ“Šä¸‹æ–¹å„²å­˜æŒ‰éˆ•ã€‚</p>
                </div>
            </div>
            <button id="btn-save-act" class="w-full bg-orange-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜ ACT åˆ†æ•¸</button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 ml-2">D. å€‹äººæœ€ä½³ PEF å€¼ (PB)</h2>
            <div class="app-card p-4">
                <p class="mb-1">ç›®å‰åŸºæº–: <span id="display-pb" class="font-bold text-lg text-blue-600">æœªè¨­å®š</span> L/min</p>
                <div class="flex space-x-3"><input type="number" id="input-pb" placeholder="50-800" class="flex-grow"><button id="btn-save-pb" class="bg-blue-600 text-white font-bold px-6 rounded-lg whitespace-nowrap">å„²å­˜åŸºæº–</button></div>
            </div>
        </div>

        <div id="log-input-section" class="mt-8">
            <h2 class="text-xl font-semibold text-green-700 mb-3 ml-2">E. è‡ªæˆ‘ç›£æ¸¬ç´€éŒ„ (æ¯æ—¥è¨˜éŒ„)</h2>
            <form id="log-form" class="app-card p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-medium">æ—©æ™¨ AM</label><input type="number" id="l-am" min="50" max="800" placeholder="L/min"></div>
                    <div><label class="text-sm font-medium">æ™šé–“ PM</label><input type="number" id="l-pm" min="50" max="800" placeholder="L/min"></div>
                </div>
                <textarea id="l-note" placeholder="å‚™è¨»ç—‡ç‹€..." rows="2"></textarea>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md">å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
            </form>
        </div>

        <div id="history-section" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">F. å°–å³°æµé€Ÿ (PEF) è¶¨å‹¢åœ–èˆ‡æ­·å²ç´€éŒ„</h2>
            <div class="app-card"><div id="chart-container"><div class="chart-wrapper" id="chart-wrapper"><canvas id="pef-chart"></canvas></div></div></div>
            <div class="app-card p-4">
                <select id="history-selector" class="mb-4"><option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option></select>
                <div id="history-detail" class="p-4 bg-gray-50 rounded-lg text-sm hidden space-y-3">
                    <div id="detail-text"></div>
                    <button id="btn-delete-log" class="w-full bg-red-100 text-red-600 py-2 rounded font-bold border border-red-200">åˆªé™¤æ­¤ç­†ç´€éŒ„</button>
                </div>
            </div>
            <button id="export-btn" class="w-full bg-pink-600 text-white font-bold py-3 rounded-lg shadow-md mt-4">ä¸€éµåŒ¯å‡ºè‡³é†«é™¢ç«¯è³‡æ–™åº« (åƒ…30æ—¥å…§è³‡æ–™ï¼Œå»ºè­°è‡³å°‘æ¯å€‹æœˆåŒ¯å‡ºä¹™æ¬¡)</button>
        </div>

        <div class="mt-8 mb-10">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">G. æ°£å–˜æƒ¡åŒ–æ‡‰å°æŒ‡å—</h2>
            <div class="space-y-4">
                <div class="zone-green">
                    <h3 class="font-bold text-lg">ğŸŸ¢ ç¶ ç‡ˆå€ â€” æƒ…æ³è‰¯å¥½</h3>
                    <p class="text-sm font-bold border-b border-white/30 pb-2 mb-2">PEF è®€æ•¸: <span id="range-green">è«‹è¨­å®šåŸºæº–</span></p>
                    <p class="text-sm leading-relaxed">å»ºè­°ï¼šç¶­æŒç›®å‰çš„æ°£å–˜æ§åˆ¶è¨ˆç•«ï¼Œå›è¨ºæ™‚å¯èˆ‡é†«å¸«è¨è«–é™éšæ²»ç™‚ã€‚</p>
                </div>
                <div class="zone-yellow">
                    <h3 class="font-bold text-lg">ğŸŸ¡ é»ƒç‡ˆå€ â€” å°å¿ƒæƒ¡åŒ–</h3>
                    <p class="text-sm font-bold border-b border-white/30 pb-2 mb-2">PEF è®€æ•¸: <span id="range-yellow">è«‹è¨­å®šåŸºæº–</span></p>
                    <p class="text-sm leading-relaxed">å»ºè­°ï¼šæ¯éš”20åˆ†é˜å¸æ€¥æ•‘è—¥ç‰©å…©ä¸‹ï¼Œè‹¥20-60åˆ†é˜å¾Œä»æ²’æœ‰æ”¹å–„ï¼Œæ‡‰å„˜é€Ÿè¿”è¨ºã€‚</p>
                </div>
                <div class="zone-red">
                    <h3 class="font-bold text-lg">ğŸ”´ ç´…ç‡ˆå€ â€” åš´é‡ç™¼ä½œï¼</h3>
                    <p class="text-sm font-bold border-b border-white/30 pb-2 mb-2">PEF è®€æ•¸: <span id="range-red">è«‹è¨­å®šåŸºæº–</span></p>
                    <p class="text-sm leading-relaxed font-bold">å»ºè­°ï¼šç«‹å³å¸æ€¥æ•‘è—¥ç‰©4-6ä¸‹ï¼Œç«‹åˆ»å»æ€¥è¨ºã€‚</p>
                </div>
            </div>
        </div>

        <div class="flex space-x-3 mb-10">
            <button onclick="backupData()" class="flex-1 bg-gray-600 text-white py-2 rounded text-xs">å‚™ä»½è³‡æ–™ (JSON)</button>
            <label class="flex-1 bg-gray-600 text-white py-2 rounded text-xs text-center cursor-pointer">åŒ¯å…¥è³‡æ–™ <input type="file" class="hidden" onchange="restoreData(this)"></label>
        </div>

        <div class="mt-8">
            <button id="privacy-toggle" class="w-full text-left text-sm text-gray-500 py-2 border-t flex justify-between">
                <span>éš±ç§æ¬ŠåŠæˆæ¬Šè²æ˜ (é»æ“Šå±•é–‹)</span><span id="toggle-icon">â–¼</span>
            </button>
            <div id="privacy-content" class="collapsible-content text-xs text-gray-600 p-2 leading-relaxed">
                <p>1. æœ¬ç¨‹å¼ç‚ºä¸‰è»ç¸½é†«é™¢èƒ¸è…”å…§ç§‘æä¾›ä¹‹å±…å®¶ç›£æ¸¬å·¥å…·ã€‚æ‚¨çš„å€‹äººè³‡æ–™èˆ‡ç”Ÿç†ç´€éŒ„çš†å„²å­˜åœ¨æ‚¨æ‰‹æ©Ÿçš„ç€è¦½å™¨æœ¬åœ°ç©ºé–“ (LocalStorage)ï¼Œæœ¬é™¢ä¸æœƒåœ¨æœªç¶“æ‚¨çš„æ“ä½œä¸‹ä¸»å‹•æ“·å–æ•¸æ“šã€‚</p>
                <p class="mt-2">2. ç•¶æ‚¨é»é¸ã€Œä¸€éµåŒ¯å‡ºã€åŠŸèƒ½æ™‚ï¼Œç³»çµ±å°‡æœƒå°è£æ‚¨éå» 30 å¤©å…§çš„æ•¸æ“šå‚³é€è‡³æœ¬é™¢é†«ç™‚ç³»çµ±ï¼Œåƒ…ä½œç‚ºè‡¨åºŠè¨ºæ–·åƒè€ƒï¼Œä¸¦å—å€‹è³‡æ³•ä¿è­·ã€‚å»ºè­°æ‚¨å®šæœŸä½¿ç”¨ã€Œå‚™ä»½è³‡æ–™ã€åŠŸèƒ½ä»¥ç¢ºä¿æ›æ©Ÿæ™‚è³‡æ–™èƒ½å®Œæ•´é·ç§»ã€‚</p>
                <p class="mt-2 text-red-500 font-bold">â€» æ³¨æ„ï¼šæ¸…é™¤ç€è¦½å™¨å¿«å–å°‡æœƒå°è‡´è³‡æ–™éºå¤±ã€‚</p>
            </div>
        </div>

        <div class="mt-8 p-4 text-center text-xs text-gray-400">æœ€å¾Œæ›´æ–°ï¼š<span id="last-updated">--</span></div>
    </div>

    <datalist id="list-main">
        <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER"><option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">
        <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER"><option value="è‚ºèˆ’å¦ FOSTER NEXHALER">
        <option value="ä½¿è‚ºæ³° SERETIDE EVOHALER"><option value="ä½¿è‚ºæ³° SERETIDE ACCUHALER">
        <option value="æ½¤å¨ƒ RELVAR ELLIPTA"><option value="ä¿è¡›åº· ALVESCO INHALER">
        <option value="è‚ºæ¨‚å–œ TRELEGY ELLIPTA"><option value="å–˜å¯¶ TRIMBOW MDI INHALER">
        <option value="å¿…è‚ºæš¢ BREZTRI MDI INHALER">
    </datalist>
    <datalist id="list-extra"><option value="é©å–˜æ¨‚ SPIRIVA RESPIMAT (äºŒå£)"><option value="è‹±å…‹è³œ INCRUSE ELLIPTA"></datalist>
    <datalist id="list-reliever"><option value="åŒä¿é¤Šè—¥ç‰©"><option value="å¸å¿…æ“´ SYMBICORT"><option value="è‚ºèˆ’å¦ FOSTER"><option value="å‚™å–˜å…¨ BERODUAL N MDI"><option value="å‚™å‹å–˜ BEROTECL N MDI"><option value="è¬åšèˆ’ VENTOLIN"></datalist>

    <div id="msg" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold hidden" style="z-index: 9999;"></div>

    <script>
        const KEYS = { P: 'asthma_p', PB: 'asthma_pb', M: 'asthma_m', LOGS: 'asthma_logs', CHECK: 'asthma_check', ACT: 'asthma_act_v47' };
        let pefChart = null; let allLogs = [];

        function showMsg(t, s=true) { const b = document.getElementById('msg'); b.textContent = t; b.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold ${s?'bg-green-600':'bg-red-600'}`; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'), 3000); }

        // ç²¾ç¢ºå¹´é½¡è¨ˆç®—ï¼šå¹¾æ­²å¹¾å€‹æœˆ
        function calcAge(dob) {
            if(!dob) return "--";
            const b = new Date(dob);
            const n = new Date();
            let years = n.getFullYear() - b.getFullYear();
            let months = n.getMonth() - b.getMonth();
            if (months < 0 || (months === 0 && n.getDate() < b.getDate())) {
                years--;
                months += 12;
            }
            if (n.getDate() < b.getDate()) {
                months--;
                if (months < 0) {
                    years--;
                    months = 11;
                }
            }
            return `${years} æ­² ${months} å€‹æœˆ`;
        }

        function load() {
            // A. å€‹äººè³‡è¨Š è‡ªå‹•å¸¶å…¥
            const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}');
            if(p.name){
                document.getElementById('p-name').value = p.name || '';
                document.getElementById('p-record').value = p.record || '';
                document.getElementById('p-dob').value = p.dob || '';
                document.getElementById('p-doc').value = p.doc || '';
                document.getElementById('p-phone').value = p.phone || '';
                document.getElementById('display-age').textContent = calcAge(p.dob);
            }
            
            // B, D, ACT è‡ªå‹•å¸¶å…¥ (å…¶é¤˜éƒ¨åˆ†åŒV48)
            const m = JSON.parse(localStorage.getItem(KEYS.M) || '{}');
            if(m.main){ document.getElementById('m-main').value=m.main; document.getElementById('f-main').value=m.fMain; document.getElementById('m-extra').value=m.extra||''; document.getElementById('m-reliever').value=m.reliever||''; }
            const checks = JSON.parse(localStorage.getItem(KEYS.CHECK) || '[]'); document.querySelectorAll('.med-check').forEach(c => c.checked = checks.includes(c.value));
            const pbRaw = localStorage.getItem(KEYS.PB); if(pbRaw){ const pb = JSON.parse(pbRaw); document.getElementById('input-pb').value = pb.personalBestPEF; updatePBUI(pb.personalBestPEF); }
            const actSaved = JSON.parse(localStorage.getItem(KEYS.ACT) || 'null');
            if(actSaved) { document.querySelectorAll('.act-q').forEach((q, i) => q.value = actSaved.values[i]); document.getElementById('act-save-time').textContent = "ä¸Šæ¬¡å„²å­˜ï¼š " + actSaved.time; calculateACT(); }
            allLogs = JSON.parse(localStorage.getItem(KEYS.LOGS) || '[]'); refreshUI();
            const h = new Date().getHours(); document.getElementById('l-am').disabled = h >= 12; document.getElementById('l-pm').disabled = h < 12;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        document.getElementById('privacy-toggle').onclick = () => {
            const content = document.getElementById('privacy-content');
            content.classList.toggle('expanded');
            document.getElementById('toggle-icon').textContent = content.classList.contains('expanded') ? 'â–²' : 'â–¼';
        };

        function calculateACT() {
            let t = 0; let ok = true;
            document.querySelectorAll('.act-q').forEach(q => { if(!q.value) ok = false; else t += parseInt(q.value); });
            const s = document.getElementById('act-status');
            if(!ok) { s.textContent = "å°šæœªå®Œæˆ"; s.className = "px-3 py-1 rounded-full text-xs bg-gray-400 text-white"; return null; }
            document.getElementById('act-total').textContent = t;
            s.textContent = "è©•ä¼°å®Œæˆ"; s.className = "px-3 py-1 rounded-full text-xs bg-green-500 text-white";
            return t;
        }

        document.getElementById('btn-save-act').onclick = () => {
            const t = calculateACT(); if(t === null) { showMsg("è«‹å®Œæˆæ¸¬é©—å†å„²å­˜", false); return; }
            const vals = Array.from(document.querySelectorAll('.act-q')).map(q => q.value);
            const time = new Date().toLocaleString();
            localStorage.setItem(KEYS.ACT, JSON.stringify({ values: vals, time: time }));
            document.getElementById('act-save-time').textContent = "ä¸Šæ¬¡å„²å­˜ï¼š " + time;
            showMsg("ACT çµæœå·²å„²å­˜");
        };

        function refreshUI() {
            const s = document.getElementById('history-selector');
            s.innerHTML = '<option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option>';
            allLogs.sort((a,b)=>b.date-a.date).forEach((l, i) => { const o = document.createElement('option'); o.value = i; o.textContent = `${new Date(l.date).toLocaleString()} (æ—©:${l.am||'-'}/æ™š:${l.pm||'-'})`; s.appendChild(o); });
            const pb = parseInt(document.getElementById('input-pb').value); if(pb) renderChart(pb);
        }

        function renderChart(pb) {
            const container = document.getElementById('chart-container');
            const wrapper = document.getElementById('chart-wrapper');
            const daily = {};
            allLogs.forEach(log => {
                const d = new Date(log.date).toLocaleDateString('zh-TW'); const h = new Date(log.date).getHours();
                if (!daily[d]) daily[d] = { am: null, pm: null };
                if (h < 12 && log.am) daily[d].am = Math.max(daily[d].am || 0, log.am);
                if (h >= 12 && log.pm) daily[d].pm = Math.max(daily[d].pm || 0, log.pm);
            });
            const sorted = Object.keys(daily).sort((a,b)=>new Date(a)-new Date(b));
            const labels = []; const data = []; const colors = [];
            sorted.forEach(d => {
                const dd = d.split('/')[1]+'/'+d.split('/')[2];
                if(daily[d].am){ labels.push(dd+" AM"); data.push(daily[d].am); colors.push('#34c759'); }
                if(daily[d].pm){ labels.push(dd+" PM"); data.push(daily[d].pm); colors.push('#007aff'); }
            });
            wrapper.style.width = Math.max(container.clientWidth, labels.length * 40) + "px";
            if(pefChart) pefChart.destroy();
            const ctx = document.getElementById('pef-chart').getContext('2d');
            const gT = Math.ceil(pb*0.8), rT = Math.ceil(pb*0.5);
            pefChart = new Chart(ctx, {
                type: 'line', data: { labels, datasets: [{ data, borderColor: '#8e8e93', pointBackgroundColor: colors, pointRadius: 5, tension: 0.3, fill: false, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, suggestedMax: pb*1.1 } }, plugins: { legend: { display: false } } },
                plugins: [{ id: 'lines', afterDraw(c) { const {ctx, chartArea:{left, right}, scales:{y}} = c; ctx.save(); ctx.setLineDash([6, 4]); ctx.strokeStyle = 'rgba(52,199,89,0.7)'; ctx.stroke(new Path2D(`M${left} ${y.getPixelForValue(gT)}L${right} ${y.getPixelForValue(gT)}`)); ctx.strokeStyle = 'rgba(255,59,48,0.7)'; ctx.stroke(new Path2D(`M${left} ${y.getPixelForValue(rT)}L${right} ${y.getPixelForValue(rT)}`)); ctx.restore(); } }]
            });
            setTimeout(() => { container.scrollLeft = container.scrollWidth; }, 100);
        }

        function updatePBUI(v) { document.getElementById('display-pb').textContent = v + " L/min"; document.getElementById('range-green').textContent = `${Math.ceil(v*0.8)} ~ ${v} L/min`; document.getElementById('range-yellow').textContent = `${Math.ceil(v*0.5)} ~ ${Math.ceil(v*0.8)-1} L/min`; document.getElementById('range-red').textContent = `ä½æ–¼ ${Math.ceil(v*0.5)} L/min`; }
        function backupData() { const d = {}; for(let k in KEYS) d[k] = localStorage.getItem(KEYS[k]); const blob = new Blob([JSON.stringify(d)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Asthma_Backup.json`; a.click(); }
        function restoreData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); for(let k in d) if(d[k]) localStorage.setItem(k, d[k]); showMsg("åŒ¯å…¥æˆåŠŸï¼"); setTimeout(()=>location.reload(), 500); } catch(err) { showMsg("æ ¼å¼éŒ¯èª¤", false); } }; r.readAsText(f); }

        window.onload = load;
        document.querySelectorAll('.act-q').forEach(q => q.onchange = calculateACT);
        document.getElementById('profile-form').onsubmit = (e) => { 
            e.preventDefault(); 
            const d = { 
                name:document.getElementById('p-name').value, 
                record:document.getElementById('p-record').value, 
                dob:document.getElementById('p-dob').value,
                doc:document.getElementById('p-doc').value,
                phone:document.getElementById('p-phone').value
            }; 
            localStorage.setItem(KEYS.P, JSON.stringify(d)); 
            document.getElementById('display-age').textContent = calcAge(d.dob);
            showMsg("å€‹äººè³‡æ–™å·²å„²å­˜"); 
        };
        document.getElementById('meds-form').onsubmit = (e) => { e.preventDefault(); const checks = Array.from(document.querySelectorAll('.med-check:checked')).map(c => c.value); localStorage.setItem(KEYS.CHECK, JSON.stringify(checks)); localStorage.setItem(KEYS.M, JSON.stringify({ main:document.getElementById('m-main').value, fMain:document.getElementById('f-main').value, extra:document.getElementById('m-extra').value, reliever:document.getElementById('m-reliever').value })); showMsg("è—¥ç‰©è¨ˆç•«å·²å„²å­˜"); };
        document.getElementById('btn-save-pb').onclick = () => { const v = document.getElementById('input-pb').value; if(v<50||v>800) return showMsg("ç¯„åœéŒ¯èª¤", false); localStorage.setItem(KEYS.PB, JSON.stringify({personalBestPEF: v, updatedAt: Date.now()})); updatePBUI(v); refreshUI(); showMsg("åŸºæº–å„²å­˜æˆåŠŸ"); };
        document.getElementById('log-form').onsubmit = (e) => { e.preventDefault(); const am = parseInt(document.getElementById('l-am').value); const pm = parseInt(document.getElementById('l-pm').value); if(!am && !pm) return; allLogs.unshift({ date:Date.now(), am: am||null, pm: pm||null, note:document.getElementById('l-note').value }); localStorage.setItem(KEYS.LOGS, JSON.stringify(allLogs)); location.reload(); };
        document.getElementById('history-selector').onchange = (e) => { const d = document.getElementById('history-detail'); const l = allLogs[e.target.value]; if(!l) return d.classList.add('hidden'); document.getElementById('detail-text').innerHTML = `æ™‚é–“ï¼š${new Date(l.date).toLocaleString()}<br>æ•¸å€¼ï¼šæ—© ${l.am||'-'} / æ™š ${l.pm||'-'}`; d.classList.remove('hidden'); };
        document.getElementById('btn-delete-log').onclick = () => { if(!confirm("ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ")) return; allLogs.splice(document.getElementById('history-selector').value, 1); localStorage.setItem(KEYS.LOGS, JSON.stringify(allLogs)); location.reload(); };
    </script>
</body>
</html>