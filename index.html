<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°£å–˜æ—¥èªŒ V45 - ACT åŒ¯å‡ºå¼·åŒ–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f2f2f7; color: #1c1c1e; font-size: 15px; }
        .app-card { background-color: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e5e5ea; overflow: hidden; }
        .list-row { padding: 12px 16px; border-bottom: 0.5px solid #e5e5ea; display: flex; flex-direction: column; gap: 4px; }
        input:not([type="checkbox"]), select, textarea { border: 1px solid #d1d1d6 !important; padding: 10px 12px !important; border-radius: 6px !important; font-size: 16px; width: 100%; }
        input:disabled { background-color: #f2f2f7 !important; color: #8e8e93 !important; cursor: not-allowed; border: 1px dashed #d1d1d6 !important; }
        .input-field-loaded { color: #9ca3af !important; }
        .input-field-edited { color: #1f2937 !important; font-weight: 500; }
        .zone-green { background-color: #34c759; color: white; border-radius: 8px; padding: 12px; }
        .zone-yellow { background-color: #ff9500; color: white; border-radius: 8px; padding: 12px; }
        .zone-red { background-color: #ff3b30; color: white; border-radius: 8px; padding: 12px; }
        #chart-container { width: 100%; height: 320px; padding: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .chart-wrapper { min-width: 100%; height: 260px; }
        .act-question { padding: 12px; border-bottom: 1px solid #f2f2f7; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .collapsible-content.expanded { max-height: 5000px; transition: max-height 0.6s ease-in; }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="app" class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ</h1>
        <h2 class="text-base text-gray-600 mb-6 border-b pb-2 font-medium">ä¸‰è»ç¸½é†«é™¢ èƒ¸è…”å…§ç§‘</h2>

        <form id="profile-form">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 ml-2">A. å€‹äººè³‡è¨Šèˆ‡é†«ç™‚è¯çµ¡</h2>
            <div class="app-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">å§“å</label><input type="text" id="p-name" required></div>
                    <div><label class="text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="p-dob"></div>
                </div>
                <div class="list-row bg-indigo-50"><p>è¶³æ­²å¹´é½¡: <span id="display-age" class="font-bold text-indigo-800">--</span></p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">ç—…æ­·è™Ÿ</label><input type="text" id="p-record"></div>
                    <div><label class="text-sm font-medium text-gray-700">ä¸»æ²»é†«å¸«</label><input type="text" id="p-doc"></div>
                </div>
                <div class="list-row"><label class="text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡é›»è©±</label><input type="tel" id="p-phone"></div>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜å€‹äººè³‡æ–™</button>
        </form>

        <form id="meds-form">
            <h2 class="text-xl font-semibold text-purple-700 mb-3 ml-2">B. è—¥ç‰©è¨ˆç•«</h2>
            <div class="app-card">
                <div class="list-row"><label class="medication-label-strong">é•·æœŸæ§åˆ¶è—¥ç‰© (ä¿é¤Š)</label><input type="text" id="m-main" list="list-main"><select id="f-main" class="mt-2"><option value="">é¸æ“‡é »ç‡</option><option value="åƒ…éœ€è¦æ™‚ä½¿ç”¨">åƒ…éœ€è¦æ™‚ä½¿ç”¨</option><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡">æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„äºŒæ¬¡">æ¯æ—¥æ—©æ™šå„äºŒæ¬¡</option></select></div>
                <div class="list-row"><label class="medication-label-strong">é¡å¤–ä¿é¤Šè—¥ç‰©</label><input type="text" id="m-extra" list="list-extra"><select id="f-extra" class="mt-2"><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option></select></div>
                <div class="list-row"><label class="medication-label-strong">é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘)</label><input type="text" id="m-reliever" list="list-reliever"><select id="f-reliever" class="mt-2"><option value="éœ€è¦æ™‚ä½¿ç”¨">éœ€è¦æ™‚ä½¿ç”¨</option><option value="ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º">ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º</option></select></div>
                <div id="check-list" class="list-row space-y-2 bg-gray-50 py-3">
                    <label class="medication-label-strong text-purple-800">å…¶ä»–è¼”åŠ©è—¥ç‰©ï¼š</label>
                    <label class="flex items-center space-x-3 text-sm"><input type="checkbox" class="med-check w-5 h-5" value="c1"><span>èŒ¶é¹¼é¡è—¥ç‰© (å¦‚XANTHIUMï¼ŒTHOIN)</span></label>
                    <label class="flex items-center space-x-3 text-sm"><input type="checkbox" class="med-check w-5 h-5" value="c2"><span>ç™½ä¸‰çƒ¯ç´ å—é«”æ‹®æŠ—åŠ‘ (å¦‚SINGULAIR)</span></label>
                    <label class="flex items-center space-x-3 text-sm"><input type="checkbox" class="med-check w-5 h-5" value="c3"><span>å£æœæ”¯æ°£ç®¡æ“´å¼µåŠ‘ (å¦‚MEPTINï¼ŒLUNGTEC)</span></label>
                </div>
            </div>
            <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜ç”¨è—¥è¨ˆç•«</button>
        </form>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-orange-600 mb-3 ml-2">C. æ°£å–˜æ§åˆ¶æ¸¬é©— (éå»å››é€±) (ACT)</h2>
            <div class="app-card">
                <div class="act-question"><label class="block text-sm mb-1">1. å½±éŸ¿å·¥ä½œ/å­¸æ ¡ç¨‹åº¦ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (ç¸½æ˜¯)</option><option value="2">2åˆ† (å¤§éƒ¨åˆ†)</option><option value="3">3åˆ† (æœ‰æ™‚)</option><option value="4">4åˆ† (å¾ˆå°‘)</option><option value="5" selected>5åˆ† (å®Œå…¨æ²’)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">2. å‘¼å¸çŸ­ä¿ƒé »ç‡ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (æ¯å¤©ä¸€æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯å¤©ä¸€æ¬¡)</option><option value="3">3åˆ† (æ¯é€±3-6æ¬¡)</option><option value="4">4åˆ† (æ¯é€±1-2æ¬¡)</option><option value="5" selected>5åˆ† (ç„¡)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">3. åŠå¤œé†’ä¾†æ¬¡æ•¸ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (æ¯é€±4æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯é€±2-3æ¬¡)</option><option value="3">3åˆ† (æ¯é€±ä¸€æ¬¡)</option><option value="4">4åˆ† (æ¯é€±å°‘æ–¼ä¸€æ¬¡)</option><option value="5" selected>5åˆ† (ç„¡)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">4. æ€¥æ•‘è—¥ä½¿ç”¨é »ç‡ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (æ¯å¤©3æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯å¤©1-2æ¬¡)</option><option value="3">3åˆ† (æ¯é€±2-3æ¬¡)</option><option value="4">4åˆ† (æ¯é€±1æ¬¡ä»¥ä¸‹)</option><option value="5" selected>5åˆ† (ç„¡)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">5. æ‚¨è‡ªè¦ºæ§åˆ¶ç‹€æ³ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (å¾ˆä¸ç†æƒ³)</option><option value="2">2åˆ† (æ™®é€š)</option><option value="3">3åˆ† (é‚„å¯ä»¥)</option><option value="4">4åˆ† (è‰¯å¥½)</option><option value="5" selected>5åˆ† (å®Œå…¨æ§åˆ¶)</option></select></div>
                <div class="p-4 bg-orange-50 flex justify-between items-center"><span class="font-bold">ACT ç¸½åˆ†ï¼š<span id="act-total">25</span> åˆ†</span><span id="act-status" class="px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white">å®Œå…¨æ§åˆ¶</span></div>
            </div>
            <button id="btn-save-act" class="w-full bg-orange-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜ ACT åˆ†æ•¸</button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 ml-2">D. å€‹äººæœ€ä½³ PEF å€¼ (PB)</h2>
            <div class="app-card p-4">
                <p class="mb-1">ç›®å‰åŸºæº–: <span id="display-pb" class="font-bold text-lg text-blue-600">æœªè¨­å®š</span> L/min</p>
                <p id="pb-date-info" class="text-xs text-gray-500 mb-3">ä¸Šæ¬¡æ›´æ–°: --</p>
                <div class="flex space-x-3"><input type="number" id="input-pb" placeholder="50-800" class="flex-grow"><button id="btn-save-pb" type="button" class="bg-blue-600 text-white font-bold px-6 rounded-lg whitespace-nowrap">å„²å­˜</button></div>
            </div>
        </div>

        <div id="log-input-section" class="mt-8">
            <h2 class="text-xl font-semibold text-green-700 mb-3 ml-2">E. è‡ªæˆ‘ç›£æ¸¬ç´€éŒ„ (æ¯æ—¥è¨˜éŒ„)</h2>
            <form id="log-form" class="app-card p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-medium">æ—©æ™¨ AM</label><input type="number" id="l-am" min="50" max="800" placeholder="L/min"></div>
                    <div><label class="text-sm font-medium">æ™šé–“ PM</label><input type="number" id="l-pm" min="50" max="800" placeholder="L/min"></div>
                </div>
                <textarea id="l-note" placeholder="å‚™è¨»ç—‡ç‹€..." rows="2"></textarea>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md">å„²å­˜æ™‚æ®µç´€éŒ„</button>
            </form>
        </div>

        <div id="history-section" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">F. å°–å³°æµé€Ÿ (PEF) è¶¨å‹¢åœ–</h2>
            <div class="app-card">
                <div id="chart-container">
                    <div class="chart-wrapper" id="chart-wrapper"><canvas id="pef-chart"></canvas></div>
                </div>
            </div>
            <div class="app-card p-4"><select id="history-selector" class="mb-4"><option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option></select><div id="history-detail" class="p-4 bg-gray-50 rounded-lg text-sm hidden"></div></div>
            <button id="export-btn" class="w-full bg-pink-600 text-white font-bold py-3 rounded-lg shadow-md mt-4 transition-colors">å‚³é€æœ€è¿‘ 30 æ—¥æ•¸æ“šè‡³ä¸‰ç¸½ (å«ACTç´°é …)</button>
        </div>

        <div id="guide-section" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">G. æ°£å–˜æƒ¡åŒ–æ‡‰å°æŒ‡å—</h2>
            <div class="app-card p-4 space-y-4">
                <div class="zone-green"><h3 class="font-bold">ğŸŸ¢ ç¶ ç‡ˆå€ â€” æƒ…æ³è‰¯å¥½</h3><p class="text-sm">PEF è®€æ•¸: <span id="range-green">è«‹å…ˆè¨­å®š PB å€¼</span></p><p class="text-xs mt-1 border-t pt-1 leading-relaxed">å»ºè­°ï¼šç¶­æŒç›®å‰çš„æ°£å–˜æ§åˆ¶è¨ˆç•«ï¼Œå›è¨ºæ™‚å¯èˆ‡é†«å¸«è¨è«–é™éšæ²»ç™‚ã€‚</p></div>
                <div class="zone-yellow"><h3 class="font-bold">ğŸŸ¡ é»ƒç‡ˆå€ â€” å°å¿ƒæƒ¡åŒ–</h3><p class="text-sm">PEF è®€æ•¸: <span id="range-yellow">è«‹å…ˆè¨­å®š PB å€¼</span></p><p class="text-xs mt-1 border-t pt-1 leading-relaxed">å»ºè­°ï¼šæ¯éš”20åˆ†é˜å¸æ€¥æ•‘è—¥ç‰©å…©ä¸‹ï¼Œè‹¥20-60åˆ†é˜å¾Œä»æ²’æœ‰æ”¹å–„ï¼Œæ‡‰å„˜é€Ÿè¿”è¨ºã€‚</p></div>
                <div class="zone-red"><h3 class="font-bold">ğŸ”´ ç´…ç‡ˆå€ â€” åš´é‡ç™¼ä½œï¼</h3><p class="text-sm">PEF è®€æ•¸: <span id="range-red">è«‹å…ˆè¨­å®š PB å€¼</span></p><p class="text-xs mt-1 border-t pt-1 font-bold leading-relaxed">å»ºè­°ï¼šç«‹å³å¸æ€¥æ•‘è—¥ç‰©4-6ä¸‹ï¼Œç«‹åˆ»å»æ€¥è¨ºã€‚</p></div>
            </div>
        </div>

        <div class="mt-8 flex space-x-3">
            <button onclick="backupData()" class="flex-1 bg-gray-600 text-white py-2 rounded text-xs">å‚™ä»½è¨­å®šæª” (JSON)</button>
            <label class="flex-1 bg-gray-600 text-white py-2 rounded text-xs text-center cursor-pointer">é‚„åŸè¨˜éŒ„æª” <input type="file" class="hidden" onchange="restoreData(this)"></label>
        </div>

        <div class="mt-8 p-4 text-center text-xs text-gray-400">æœ€å¾Œæ›´æ–°ï¼š<span id="last-updated">--</span></div>
    </div>

    <datalist id="list-main">
        <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER"><option value="å¸å¿…æ“´ SYMBICORT RAPIHALER"><option value="è‚ºèˆ’å¦ FOSTER MDI INHALER"><option value="è‚ºèˆ’å¦ FOSTER NEXHALER"><option value="ä½¿è‚ºæ³° SERETIDE EVOHALER"><option value="æ½¤å¨ƒ RELVAR ELLIPTA"><option value="ä¿è¡›åº· ALVESCO INHALER"><option value="è‚ºæ¨‚å–œ TRELEGY ELLIPTA"><option value="å–˜å¯¶ TRIMBOW MDI INHALER"><option value="å¿…è‚ºæš¢ BREZTRI MDI INHALER">
    </datalist>
    <datalist id="list-extra"><option value="é©å–˜æ¨‚ SPIRIVA RESPIMAT (äºŒå£)"><option value="è‹±å…‹è³œ INCRUSE ELLIPTA"></datalist>
    <datalist id="list-reliever"><option value="åŒä¿é¤Šè—¥ç‰©"><option value="å¸å¿…æ“´ TURBUHALER"><option value="è‚ºèˆ’å¦ MDI INHALER"><option value="å‚™å–˜å…¨ BERODUAL N"><option value="å‚™å‹å–˜ BEROTECL"></datalist>

    <div id="msg" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold hidden" style="z-index: 9999;"></div>

    <script>
        const KEYS = { P: 'asthma_p', PB: 'asthma_pb', M: 'asthma_m', LOGS: 'asthma_logs', ACT: 'asthma_act', CHECK: 'asthma_check' };
        const FORM_CFG = { ACTION_URL: 'https://docs.google.com/forms/d/e/æ‚¨çš„ID/formResponse', IDS: { NAME: 'entry.1', RECORD: 'entry.2', PB: 'entry.3', ACT: 'entry.4', LOGS: 'entry.5', MEDS: 'entry.6' } };
        let pefChart = null; let allLogs = [];

        function showMsg(t, s=true) { const b = document.getElementById('msg'); b.textContent = t; b.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold ${s?'bg-green-600':'bg-red-600'}`; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'), 3000); }

        function calcAge(dob) { if(!dob) return "--"; const b = new Date(dob); const n = new Date(); let a = n.getFullYear()-b.getFullYear(); const m = n.getMonth()-b.getMonth(); if(m<0||(m===0&&n.getDate()<b.getDate())) a--; return a + " æ­²"; }

        function getCleanPB() { const r = localStorage.getItem(KEYS.PB); if(!r) return null; try { const p = JSON.parse(r); return p.personalBestPEF ? parseInt(p.personalBestPEF) : null; } catch(e) { return parseInt(r) || null; } }

        function updateRanges(pb) {
            const v = parseInt(pb); if(!v) return;
            document.getElementById('display-pb').textContent = v + " L/min";
            document.getElementById('range-green').textContent = `${Math.ceil(v*0.8)} ~ ${v} L/min`;
            document.getElementById('range-yellow').textContent = `${Math.ceil(v*0.5)} ~ ${Math.ceil(v*0.8)-1} L/min`;
            document.getElementById('range-red').textContent = `ä½æ–¼ ${Math.ceil(v*0.5)} L/min`;
            const raw = JSON.parse(localStorage.getItem(KEYS.PB) || '{}');
            const info = document.getElementById('pb-date-info');
            if(raw.updatedAt) {
                const last = new Date(raw.updatedAt); info.textContent = "ä¸Šæ¬¡æ›´æ–°: " + last.toLocaleDateString();
                if(Date.now() - raw.updatedAt > 180*24*60*60*1000) { info.className = "text-xs font-bold text-red-600"; info.textContent += " (å»ºè­°é‡æ–°æª¢æ¸¬)"; }
            }
            renderChart(v);
        }

        function renderChart(pb) {
            const ctxEl = document.getElementById('pef-chart'); if(!ctxEl) return;
            const container = document.getElementById('chart-container');
            const wrapper = document.getElementById('chart-wrapper');
            const daily = {};
            allLogs.forEach(log => {
                const d = new Date(log.date || log.timestamp).toLocaleDateString('zh-TW'); const h = new Date(log.date || log.timestamp).getHours();
                if (!daily[d]) daily[d] = { am: null, pm: null };
                if (h < 12 && log.am) daily[d].am = Math.max(daily[d].am || 0, log.am);
                if (h >= 12 && log.pm) daily[d].pm = Math.max(daily[d].pm || 0, log.pm);
            });
            const sortedKeys = Object.keys(daily).sort((a,b) => new Date(a) - new Date(b));
            const labels = []; const data = []; const colors = [];
            sortedKeys.forEach(d => {
                const dd = d.split('/')[1] + '/' + d.split('/')[2];
                if (daily[d].am) { labels.push(dd + " AM"); data.push(daily[d].am); colors.push('#34c759'); }
                if (daily[d].pm) { labels.push(dd + " PM"); data.push(daily[d].pm); colors.push('#007aff'); }
            });
            const calculatedWidth = Math.max(container.clientWidth, labels.length * 35);
            wrapper.style.width = calculatedWidth + "px";
            if (pefChart) pefChart.destroy();
            const gT = Math.ceil(pb * 0.8), rT = Math.ceil(pb * 0.5);
            pefChart = new Chart(ctxEl.getContext('2d'), {
                type: 'line', data: { labels: labels, datasets: [{ label: 'PEF è¶¨å‹¢', data: data, borderColor: '#8e8e93', borderWidth: 2, pointBackgroundColor: colors, pointRadius: 5, tension: 0.3, fill: false, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, suggestedMax: pb * 1.1 } } },
                plugins: [{ id: 'lines', afterDraw(c) { const {ctx, chartArea:{left, right}, scales:{y}} = c; ctx.save(); ctx.setLineDash([6, 4]); const gy = y.getPixelForValue(gT); ctx.strokeStyle = 'rgba(52,199,89,0.7)'; ctx.stroke(new Path2D(`M${left} ${gy}L${right} ${gy}`)); const ry = y.getPixelForValue(rT); ctx.strokeStyle = 'rgba(255,59,48,0.7)'; ctx.stroke(new Path2D(`M${left} ${ry}L${right} ${ry}`)); ctx.restore(); } }]
            });
            setTimeout(() => { container.scrollLeft = container.scrollWidth; }, 100);
        }

        // ä¿®æ”¹å¾Œçš„åŒ¯å‡ºé‚è¼¯ï¼šåŒ…å«ç´°é …
        document.getElementById('export-btn').onclick = async function() {
            const btn = this; if (btn.disabled) return;
            btn.disabled = true; btn.textContent = 'å‚³é€ä¸­...'; btn.classList.replace('bg-pink-600', 'bg-gray-400');
            try {
                const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}'), m = JSON.parse(localStorage.getItem(KEYS.M) || '{}');
                const pb = getCleanPB() || '';
                
                // è®€å– ACT äº”å€‹ç´°é …èˆ‡ç¸½åˆ†
                const actQs = Array.from(document.querySelectorAll('.act-q')).map((q, i) => `Q${i+1}:${q.value}`).join(', ');
                const actTotal = document.getElementById('act-total').textContent;
                const actFullData = `${actQs} | ç¸½åˆ†:${actTotal}`;

                const filteredLogs = allLogs.filter(l => (l.date || l.timestamp) >= (Date.now() - 2592000000));
                const lTxt = filteredLogs.map(l => `${new Date(l.date||l.timestamp).toLocaleString()}: æ—©${l.am||'-'}/æ™š${l.pm||'-'} å‚™è¨»:${l.note||''}`).join('\n');
                
                const formData = new FormData();
                formData.append(FORM_CFG.IDS.NAME, p.name || '');
                formData.append(FORM_CFG.IDS.RECORD, p.record || '');
                formData.append(FORM_CFG.IDS.PB, pb);
                formData.append(FORM_CFG.IDS.ACT, actFullData); // å‚³é€å®Œæ•´ç´°é …
                formData.append(FORM_CFG.IDS.LOGS, lTxt);
                formData.append(FORM_CFG.IDS.MEDS, `æ§è—¥:${m.main}, è¼”åŠ©:${JSON.parse(localStorage.getItem(KEYS.CHECK)||'[]').join(',')}`);

                await fetch(FORM_CFG.ACTION_URL, { method: 'POST', mode: 'no-cors', body: formData });
                showMsg("æœ€è¿‘ 30 æ—¥æ•¸æ“šå·²æˆåŠŸå‚³é€è‡³ä¸‰ç¸½", true);
            } catch (err) { showMsg("å‚³é€å¤±æ•—", false); }
            setTimeout(() => { btn.disabled = false; btn.textContent = 'å‚³é€æœ€è¿‘ 30 æ—¥æ•¸æ“šè‡³ä¸‰ç¸½'; btn.classList.replace('bg-gray-400', 'bg-pink-600'); }, 5000);
        };

        function backupData() { const d = {}; for(let k in KEYS) d[k] = localStorage.getItem(KEYS[k]); const blob = new Blob([JSON.stringify(d)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Asthma_V45_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
        function restoreData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { try { const d = JSON.parse(e.target.result); for(let k in d) if(d[k]) localStorage.setItem(k, d[k]); showMsg("é‚„åŸæˆåŠŸï¼Œåˆ·æ–°ä¸­..."); setTimeout(()=>location.reload(), 1500); } catch(err) { showMsg("ç„¡æ•ˆæª”æ¡ˆ", false); } }; r.readAsText(f); }

        function calculateACT() { 
            let t = 0; document.querySelectorAll('.act-q').forEach(q => t += parseInt(q.value)); 
            document.getElementById('act-total').textContent = t; const s = document.getElementById('act-status');
            if (t === 25) { s.textContent = "å®Œå…¨æ§åˆ¶"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white"; }
            else if (t >= 20) { s.textContent = "æ§åˆ¶è‰¯å¥½"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-blue-500 text-white"; }
            else if (t >= 16) { s.textContent = "æ§åˆ¶ä¸ä½³"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-orange-500 text-white"; }
            else { s.textContent = "æ§åˆ¶æ¥µå·®"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white"; }
            return t; 
        }

        function load() {
            const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}');
            if(p.name){ document.getElementById('p-name').value=p.name; document.getElementById('p-dob').value=p.dob || ''; document.getElementById('display-age').textContent = calcAge(p.dob); document.getElementById('p-record').value=p.record || ''; document.getElementById('p-doc').value=p.doc || ''; document.getElementById('p-phone').value=p.phone || ''; }
            const pb = getCleanPB(); if(pb) { document.getElementById('input-pb').value = pb; updateRanges(pb); }
            const m = JSON.parse(localStorage.getItem(KEYS.M) || '{}');
            if(m.main) { document.getElementById('m-main').value=m.main; document.getElementById('f-main').value=m.fMain; document.getElementById('m-extra').value=m.extra; document.getElementById('f-extra').value=m.fExtra; document.getElementById('m-reliever').value=m.reliever; document.getElementById('f-reliever').value=m.fReliever; }
            const checks = JSON.parse(localStorage.getItem(KEYS.CHECK) || '[]'); document.querySelectorAll('.med-check').forEach((c) => c.checked = checks.includes(c.value));
            allLogs = JSON.parse(localStorage.getItem(KEYS.LOGS) || '[]');
            if(allLogs.length > 0) {
                const s = document.getElementById('history-selector'); s.innerHTML = '<option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option>';
                allLogs.forEach((l, i) => { const o = document.createElement('option'); o.value = i; o.textContent = `${new Date(l.date || l.timestamp).toLocaleString()} (æ—©:${l.am||'-'}/æ™š:${l.pm||'-'})`; s.appendChild(o); });
                if(pb) renderChart(pb);
            }
            const h = new Date().getHours(); document.getElementById('l-am').disabled = h >= 12; document.getElementById('l-pm').disabled = h < 12;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        window.onload = load;
        document.querySelectorAll('.act-q').forEach(q => q.onchange = calculateACT);
        document.getElementById('profile-form').onsubmit = (e) => { e.preventDefault(); const d = { name:document.getElementById('p-name').value, dob:document.getElementById('p-dob').value, record:document.getElementById('p-record').value, doc:document.getElementById('p-doc').value, phone:document.getElementById('p-phone').value }; localStorage.setItem(KEYS.P, JSON.stringify(d)); document.getElementById('display-age').textContent = calcAge(d.dob); showMsg("å„²å­˜æˆåŠŸ"); };
        document.getElementById('btn-save-pb').onclick = () => { const v = document.getElementById('input-pb').value; if(v<50||v>800) return showMsg("ç¯„åœ50-800", false); localStorage.setItem(KEYS.PB, JSON.stringify({personalBestPEF: v, updatedAt: Date.now()})); updateRanges(v); showMsg("å„²å­˜æˆåŠŸ"); };
        document.getElementById('meds-form').onsubmit = (e) => { e.preventDefault(); const d = { main:document.getElementById('m-main').value, fMain:document.getElementById('f-main').value, extra:document.getElementById('m-extra').value, fExtra:document.getElementById('f-extra').value, reliever:document.getElementById('m-reliever').value, fReliever:document.getElementById('f-reliever').value }; localStorage.setItem(KEYS.M, JSON.stringify(d)); const checks = Array.from(document.querySelectorAll('.med-check:checked')).map(c => c.value); localStorage.setItem(KEYS.CHECK, JSON.stringify(checks)); showMsg("å„²å­˜æˆåŠŸ"); };
        document.getElementById('log-form').onsubmit = (e) => { e.preventDefault(); const am = parseInt(document.getElementById('l-am').value); const pm = parseInt(document.getElementById('l-pm').value); if((am && (am<50||am>800)) || (pm && (pm<50||pm>800))) return showMsg("ç¯„åœ50-800", false); allLogs.unshift({ date:Date.now(), am: am||null, pm: pm||null, note:document.getElementById('l-note').value }); localStorage.setItem(KEYS.LOGS, JSON.stringify(allLogs)); location.reload(); };
        document.getElementById('history-selector').onchange = (e) => { const d = document.getElementById('history-detail'); const l = allLogs[e.target.value]; if(!l) { d.classList.add('hidden'); return; } d.innerHTML = `<p><strong>æ™‚é–“ï¼š</strong>${new Date(l.date || l.timestamp).toLocaleString()}</p><p><strong>æ—©æ™¨ï¼š</strong>${l.am||'--'} L/min</p><p><strong>æ™šé–“ï¼š</strong>${l.pm||'--'} L/min</p><p><strong>å‚™è¨»ï¼š</strong>${l.note || 'ç„¡'}</p>`; d.classList.remove('hidden'); };
    </script>
</body>
</html>