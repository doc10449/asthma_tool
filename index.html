<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°£å–˜æ—¥èªŒ V28 - ç©©å®šåŒ¯å‡ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f2f2f7; color: #1c1c1e; font-size: 15px; }
        .app-card { background-color: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e5e5ea; overflow: hidden; }
        .list-row { padding: 12px 16px; border-bottom: 0.5px solid #e5e5ea; display: flex; flex-direction: column; gap: 4px; }
        .list-row:last-child { border-bottom: none; }
        input:not([type="checkbox"]), select, textarea { border: 1px solid #d1d1d6 !important; padding: 10px 12px !important; background-color: white !important; border-radius: 6px !important; font-size: 16px; width: 100%; }
        .medication-label-strong { font-weight: 600; color: #1c1c1e; display: block; margin-bottom: 4px; }
        .input-field-loaded { color: #9ca3af !important; font-weight: 400; }
        .input-field-edited { color: #1f2937 !important; font-weight: 500; }
        .zone-green { background-color: #34c759; color: white; border-radius: 8px; padding: 12px; }
        .zone-yellow { background-color: #ff9500; color: white; border-radius: 8px; padding: 12px; }
        .zone-red { background-color: #ff3b30; color: white; border-radius: 8px; padding: 12px; }
        #chart-container { width: 100%; height: 300px; padding: 10px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .collapsible-content.expanded { max-height: 5000px; transition: max-height 0.6s ease-in; }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="app" class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ</h1>
        <h2 class="text-base text-gray-600 mb-6 border-b pb-2 font-medium">ä¸‰è»ç¸½é†«é™¢ èƒ¸è…”å…§ç§‘</h2>

        <form id="profile-form">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 ml-2">I. å€‹äººè³‡è¨Šèˆ‡é†«ç™‚è¯çµ¡</h2>
            <div class="app-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">å§“å</label><input type="text" id="p-name" required></div>
                    <div><label class="text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="p-dob"></div>
                </div>
                <div class="list-row bg-indigo-50"><p>é ä¼°å¹´é½¡: <span id="display-age" class="font-bold text-indigo-800">--</span></p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">ç—…æ­·è™Ÿ</label><input type="text" id="p-record"></div>
                    <div><label class="text-sm font-medium text-gray-700">ä¸»æ²»é†«å¸«</label><input type="text" id="p-doc"></div>
                </div>
                <div class="list-row">
                    <label class="text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡é›»è©±</label>
                    <input type="tel" id="p-phone">
                </div>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜å€‹äººè³‡æ–™</button>
        </form>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 ml-2">II. å€‹äººæœ€ä½³ PEF å€¼ (PB)</h2>
            <div class="app-card p-4">
                <p class="mb-3">ç›®å‰åŸºæº–: <span id="display-pb" class="font-bold text-lg text-blue-600">æœªè¨­å®š</span> L/min</p>
                <div class="flex space-x-3">
                    <input type="number" id="input-pb" placeholder="è¼¸å…¥ PB å€¼" class="flex-grow">
                    <button id="btn-save-pb" type="button" class="bg-blue-600 text-white font-bold px-6 rounded-lg whitespace-nowrap">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div id="guide-section" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">III. æ°£å–˜æƒ¡åŒ–æ‡‰å°æŒ‡å— ğŸš¨</h2>
            <div class="app-card p-4 space-y-4">
                <div class="zone-green">
                    <h3 class="font-bold">ğŸŸ¢ ç¶ ç‡ˆå€ â€” æƒ…æ³è‰¯å¥½</h3>
                    <p class="text-sm">PEF è®€æ•¸: <span id="range-green">è«‹å…ˆè¨­å®š PB å€¼</span></p>
                </div>
                <div class="zone-yellow">
                    <h3 class="font-bold">ğŸŸ¡ é»ƒç‡ˆå€ â€” å°å¿ƒæƒ¡åŒ–</h3>
                    <p class="text-sm">PEF è®€æ•¸: <span id="range-yellow">è«‹å…ˆè¨­å®š PB å€¼</span></p>
                </div>
                <div class="zone-red">
                    <h3 class="font-bold">ğŸ”´ ç´…ç‡ˆå€ â€” åš´é‡ç™¼ä½œï¼</h3>
                    <p class="text-sm">PEF è®€æ•¸: <span id="range-red">ä½æ–¼ PB çš„ 50%</span></p>
                </div>
            </div>
        </div>

        <form id="meds-form" class="mt-8">
            <h2 class="text-xl font-semibold text-purple-700 mb-3 ml-2">IV. è—¥ç‰©è¨ˆç•«</h2>
            <div class="app-card">
                <div class="list-row">
                    <label class="medication-label-strong">é•·æœŸæ§åˆ¶è—¥ç‰© (ä¿é¤Š)</label>
                    <input type="text" id="m-main" list="list-main">
                    <select id="f-main" class="mt-2">
                        <option value="">é¸æ“‡é »ç‡</option>
                        <option value="åƒ…éœ€è¦æ™‚ä½¿ç”¨">åƒ…éœ€è¦æ™‚ä½¿ç”¨</option><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option>
                        <option value="æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡">æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„äºŒæ¬¡">æ¯æ—¥æ—©æ™šå„äºŒæ¬¡</option>
                    </select>
                </div>
                <div class="list-row">
                    <label class="medication-label-strong">é¡å¤–ä¿é¤Šè—¥ç‰©</label>
                    <input type="text" id="m-extra" list="list-extra">
                    <select id="f-extra" class="mt-2"><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option></select>
                </div>
                <div class="list-row">
                    <label class="medication-label-strong">é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘)</label>
                    <input type="text" id="m-reliever" list="list-reliever">
                    <select id="f-reliever" class="mt-2">
                        <option value="éœ€è¦æ™‚ä½¿ç”¨">éœ€è¦æ™‚ä½¿ç”¨</option><option value="ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º">ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-md">å„²å­˜ç”¨è—¥è¨ˆç•«</button>
        </form>

        <div id="log-input-section" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">VI. è‡ªæˆ‘ç›£æ¸¬ç´€éŒ„ (æ¯æ—¥è¨˜éŒ„)</h2>
            <form id="log-form" class="app-card p-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-medium">æ—©æ™¨ PEF</label><input type="number" id="l-am" placeholder="L/min"></div>
                    <div><label class="text-sm font-medium">æ™šé–“ PEF</label><input type="number" id="l-pm" placeholder="L/min"></div>
                </div>
                <textarea id="l-note" placeholder="å‚™è¨»ç—‡ç‹€..." rows="2"></textarea>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md">å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
            </form>
        </div>

        <div id="history-section" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">VII. PEF è¶¨å‹¢åœ–èˆ‡æ­·å²ç´€éŒ„</h2>
            <div class="app-card"><div id="chart-container"><canvas id="pef-chart"></canvas></div></div>
            <div class="app-card p-4">
                <select id="history-selector" class="mb-4"><option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option></select>
                <div id="history-detail" class="p-4 bg-gray-50 rounded-lg text-sm hidden"></div>
            </div>
            <button id="export-btn" class="w-full bg-pink-600 text-white font-bold py-3 rounded-lg shadow-md mt-4">åŒ¯å‡ºæ•¸æ“šåˆ° Google è¡¨å–®</button>
        </div>

        <div class="mt-10">
            <button id="privacy-toggle" class="w-full text-left text-sm text-gray-500 py-2 border-t flex justify-between">
                <span>éš±ç§æ¬ŠåŠæˆæ¬Šè²æ˜ (é»æ“Šå±•é–‹)</span>
                <span id="toggle-icon">â–¼</span>
            </button>
            <div id="privacy-content" class="collapsible-content text-xs text-gray-600 p-2 leading-relaxed">
                <p>1. æœ¬ç¨‹å¼ç‚ºä¸‰è»ç¸½é†«é™¢èƒ¸è…”å…§ç§‘æä¾›ä¹‹å–®æ©Ÿå·¥å…·ï¼Œæ‰€æœ‰è³‡æ–™çš†å„²å­˜æ–¼æ‚¨ç›®å‰çš„ç€è¦½å™¨æœ¬åœ°ç©ºé–“ (LocalStorage)ã€‚</p>
                <p class="text-red-600 font-bold mt-1">2. è­¦å‘Šï¼šè‹¥æ‚¨æ¸…é™¤ç€è¦½å™¨å¿«å–æˆ–æ›´æ›æ‰‹æ©Ÿï¼Œè³‡æ–™å°‡æœƒéºå¤±ã€‚</p>
                <p class="mt-1">3. é»æ“Šã€ŒåŒ¯å‡ºæ•¸æ“šã€æœƒé å¡« Google è¡¨å–®ï¼Œéœ€ç”±æ‚¨é»æ“Šæäº¤å¾Œè³‡æ–™æ‰æœƒå‚³è¼¸äºˆæœ¬é™¢é†«ç™‚åœ˜éšŠã€‚</p>
            </div>
        </div>

        <div class="mt-8 p-4 text-center text-xs text-gray-400">æœ€å¾Œæ›´æ–°ï¼š<span id="last-updated">--</span></div>
    </div>

    <datalist id="list-main">
        <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER"><option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">
        <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER"><option value="è‚ºèˆ’å¦ FOSTER NEXHALER">
        <option value="æ½¤å¨ƒ RELVAR ELLIPTA"><option value="ä¿è¡›åº· ALVESCO INHALER"><option value="è‚ºæ¨‚å–œ TRELEGY ELLIPTA">
    </datalist>
    <datalist id="list-extra">
        <option value="é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)"><option value="è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA">
    </datalist>
    <datalist id="list-reliever">
        <option value="åŒä¿é¤Šè—¥ç‰©"><option value="å¸å¿…æ“´ SYMBICORT TURBUHALER"><option value="å¸å¿…æ“´ SYMBICORT RAPIHALER">
        <option value="è‚ºèˆ’å¦ FOSTER MDI INHALER"><option value="è‚ºèˆ’å¦ FOSTER NEXHALER"><option value="å‚™å–˜å…¨ BERODUAL N MDI"><option value="å‚™å‹å–˜ BEROTECL N MDI">
    </datalist>

    <div id="msg" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold hidden" style="z-index: 9999;"></div>

    <script>
        // *************** Google Form é…ç½® ***************
        const GOOGLE_FORM_CONFIG = {
            FORM_BASE_URL: 'https://docs.google.com/forms/d/e/YOUR_FORM_ID/formResponse?', 
            ENTRY_IDS: { NAME: 'entry.1', RECORD: 'entry.2', PB: 'entry.3', MEDS: 'entry.4', LOGS: 'entry.5' }
        };

        const KEYS = { P: 'asthma_p', PB: 'asthma_pb', M: 'asthma_m', LOGS: 'asthma_logs' };
        const M_FREQ = { "å¸å¿…æ“´ SYMBICORT TURBUHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "å¸å¿…æ“´ SYMBICORT RAPIHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "è‚ºèˆ’å¦ FOSTER MDI INHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "è‚ºèˆ’å¦ FOSTER NEXHALER": "æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡", "æ½¤å¨ƒ RELVAR ELLIPTA": "æ¯æ—¥ä¸€æ¬¡", "ä¿è¡›åº· ALVESCO INHALER": "æ¯æ—¥ä¸€æ¬¡", "è‚ºæ¨‚å–œ TRELEGY ELLIPTA": "æ¯æ—¥ä¸€æ¬¡" };
        
        let pefChart = null;
        let allLogs = [];

        function showMsg(t, s=true) {
            const b = document.getElementById('msg');
            b.textContent = t; b.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold ${s?'bg-green-600':'bg-red-600'}`;
            b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'), 3000);
        }

        function parsePBValue(raw) {
            if (!raw) return null;
            try { const parsed = JSON.parse(raw); return (typeof parsed === 'object') ? parseInt(parsed.personalBestPEF) : parseInt(parsed); } 
            catch(e) { return parseInt(raw); }
        }

        function updateRanges(pb) {
            if(!pb || isNaN(pb)) return;
            document.getElementById('display-pb').textContent = pb;
            document.getElementById('range-green').textContent = `${Math.ceil(pb*0.8)} ~ ${pb} L/min`;
            document.getElementById('range-yellow').textContent = `${Math.ceil(pb*0.5)} ~ ${Math.ceil(pb*0.8)-1} L/min`;
            document.getElementById('range-red').textContent = `ä½æ–¼ ${Math.ceil(pb*0.5)} L/min`;
            document.getElementById('log-input-section').classList.remove('hidden');
            document.getElementById('history-section').classList.remove('hidden');
            renderChart(pb);
        }

        function renderChart(pb) {
            const ctx = document.getElementById('pef-chart');
            if (!ctx) return;
            const dataLogs = [...allLogs].reverse();
            if (pefChart) pefChart.destroy();
            pefChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: dataLogs.map(l => new Date(l.date).toLocaleDateString('zh-TW', {month:'short', day:'numeric'})),
                    datasets: [
                        { label: 'æ—©æ™¨', data: dataLogs.map(l => l.am || null), borderColor: '#34c759', tension: 0.3, spanGaps: true },
                        { label: 'æ™šé–“', data: dataLogs.map(l => l.pm || null), borderColor: '#007aff', tension: 0.3, spanGaps: true }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { suggestedMax: pb * 1.1 } } }
            });
        }

        function load() {
            const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}');
            if(p.name){
                document.getElementById('p-name').value=p.name; document.getElementById('p-dob').value=p.dob;
                document.getElementById('p-record').value=p.record; document.getElementById('p-doc').value=p.doc;
                document.getElementById('p-phone').value=p.phone;
                document.querySelectorAll('#profile-form input').forEach(el => el.value && (el.className='input-field-loaded'));
                if(p.dob){ document.getElementById('display-age').textContent = (new Date().getFullYear()-new Date(p.dob).getFullYear())+" æ­²"; }
            } else { document.getElementById('p-phone').value = '0287923311#10121'; }

            const pb = parsePBValue(localStorage.getItem(KEYS.PB));
            if(pb) { document.getElementById('input-pb').value=pb; updateRanges(pb); }

            const m = JSON.parse(localStorage.getItem(KEYS.M) || '{}');
            if(m.main){
                const map={'m-main':m.main,'f-main':m.fMain,'m-extra':m.extra,'f-extra':m.fExtra,'m-reliever':m.reliever,'f-reliever':m.fReliever};
                for(let id in map){ const el=document.getElementById(id); el && map[id] && (el.value=map[id], el.className='input-field-loaded'); }
            }
            allLogs = JSON.parse(localStorage.getItem(KEYS.LOGS) || '[]');
            if(allLogs.length > 0) { 
                const s = document.getElementById('history-selector');
                s.innerHTML = '<option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option>';
                allLogs.forEach((l, i) => { const o = document.createElement('option'); o.value = i; o.textContent = `${new Date(l.date).toLocaleString()} (æœ€é«˜: ${Math.max(l.am||0, l.pm||0)})`; s.appendChild(o); });
            }
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        document.getElementById('profile-form').onsubmit = (e) => {
            e.preventDefault();
            const d = { name:document.getElementById('p-name').value, dob:document.getElementById('p-dob').value, record:document.getElementById('p-record').value, doc:document.getElementById('p-doc').value, phone:document.getElementById('p-phone').value };
            localStorage.setItem(KEYS.P, JSON.stringify(d)); showMsg("å€‹äººè³‡æ–™å·²å„²å­˜");
        };

        document.getElementById('btn-save-pb').onclick = () => {
            const v = document.getElementById('input-pb').value;
            if(!v || v<=0) return showMsg("ç„¡æ•ˆæ•¸å€¼", false);
            localStorage.setItem(KEYS.PB, JSON.stringify({personalBestPEF: v, updatedAt: Date.now()}));
            updateRanges(parseInt(v)); showMsg("åŸºæº–å€¼å·²å„²å­˜");
        };

        document.getElementById('meds-form').onsubmit = (e) => {
            e.preventDefault();
            const d = { main:document.getElementById('m-main').value, fMain:document.getElementById('f-main').value, extra:document.getElementById('m-extra').value, fExtra:document.getElementById('f-extra').value, reliever:document.getElementById('m-reliever').value, fReliever:document.getElementById('f-reliever').value };
            localStorage.setItem(KEYS.M, JSON.stringify(d)); showMsg("ç”¨è—¥è¨ˆç•«å·²å„²å­˜");
        };

        document.getElementById('log-form').onsubmit = (e) => {
            e.preventDefault();
            const am = parseInt(document.getElementById('l-am').value), pm = parseInt(document.getElementById('l-pm').value);
            if(isNaN(am) && isNaN(pm)) return showMsg("è«‹è¼¸å…¥æ•¸å€¼", false);
            allLogs.unshift({ date:Date.now(), am, pm, note:document.getElementById('l-note').value });
            localStorage.setItem(KEYS.LOGS, JSON.stringify(allLogs));
            renderChart(parsePBValue(localStorage.getItem(KEYS.PB)));
            location.reload(); // ç°¡æ˜“åˆ·æ–°é¸å–®
        };

        document.getElementById('export-btn').onclick = () => {
            const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}');
            const m = JSON.parse(localStorage.getItem(KEYS.M) || '{}');
            const logsTxt = allLogs.map(l => `${new Date(l.date).toLocaleString()}: æ—©${l.am||'--'}/æ™š${l.pm||'--'}`).join('\n');
            const params = new URLSearchParams({
                [GOOGLE_FORM_CONFIG.ENTRY_IDS.NAME]: p.name || '',
                [GOOGLE_FORM_CONFIG.ENTRY_IDS.RECORD]: p.record || '',
                [GOOGLE_FORM_CONFIG.ENTRY_IDS.PB]: parsePBValue(localStorage.getItem(KEYS.PB)) || '',
                [GOOGLE_FORM_CONFIG.ENTRY_IDS.MEDS]: `ä¸»è—¥:${m.main} / é¡å¤–:${m.extra}`,
                [GOOGLE_FORM_CONFIG.ENTRY_IDS.LOGS]: logsTxt
            });
            window.open(GOOGLE_FORM_CONFIG.FORM_BASE_URL + params.toString(), '_blank');
        };

        document.getElementById('privacy-toggle').onclick = () => {
            document.getElementById('privacy-content').classList.toggle('expanded');
            document.getElementById('toggle-icon').textContent = document.getElementById('privacy-content').classList.contains('expanded') ? 'â–²' : 'â–¼';
        };

        window.onload = () => {
            load();
            const setupMeds = (id, fid, dict) => {
                const el=document.getElementById(id), f=document.getElementById(fid);
                el.onchange = () => { el.className='input-field-edited'; if(dict[el.value]){ f.value=dict[el.value]; f.className='input-field-edited'; } };
                el.onkeydown = (e) => { if(e.key==='Backspace' && el.value.length>0){ el.value=''; e.preventDefault(); el.className='input-field-edited'; } };
            };
            setupMeds('m-main', 'f-main', M_FREQ);
            setupMeds('m-extra', 'f-extra', {"é©å–˜æ¨‚èˆ’æ²›å™´ SPIRIVA RESPIMAT (æ¯æ¬¡äºŒå£)":"æ¯æ—¥ä¸€æ¬¡", "è‹±å…‹è³œæ˜“åˆ©é” INCRUSE ELLIPTA":"æ¯æ—¥ä¸€æ¬¡"});
            document.querySelectorAll('input, select, textarea').forEach(el => el.onfocus = () => el.className = 'input-field-edited');
        };
    </script>
</body>
</html>