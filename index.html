<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°£å–˜æ—¥èªŒ V40 - æ™‚æ®µå¼•å°ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f2f2f7; color: #1c1c1e; font-size: 15px; }
        .app-card { background-color: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid #e5e5ea; overflow: hidden; }
        .list-row { padding: 12px 16px; border-bottom: 0.5px solid #e5e5ea; display: flex; flex-direction: column; gap: 4px; }
        input:not([type="checkbox"]), select, textarea { border: 1px solid #d1d1d6 !important; padding: 10px 12px !important; background-color: white !important; border-radius: 6px !important; font-size: 16px; width: 100%; }
        input:disabled { background-color: #f2f2f7 !important; color: #8e8e93 !important; cursor: not-allowed; border: 1px dashed #d1d1d6 !important; }
        .input-field-loaded { color: #9ca3af !important; }
        .input-field-edited { color: #1f2937 !important; font-weight: 500; }
        .zone-green { background-color: #34c759; color: white; border-radius: 8px; padding: 12px; }
        .zone-yellow { background-color: #ff9500; color: white; border-radius: 8px; padding: 12px; }
        .zone-red { background-color: #ff3b30; color: white; border-radius: 8px; padding: 12px; }
        #chart-container { width: 100%; height: 320px; padding: 10px; }
        .act-question { padding: 12px; border-bottom: 1px solid #f2f2f7; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .collapsible-content.expanded { max-height: 5000px; transition: max-height 0.6s ease-in; }
    </style>
</head>
<body class="p-4 sm:p-6">
    <div id="app" class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">å±…å®¶æ°£å–˜è¡Œå‹•æ–¹æ¡ˆæ—¥èªŒ</h1>
        <h2 class="text-base text-gray-600 mb-6 border-b pb-2 font-medium">ä¸‰è»ç¸½é†«é™¢ èƒ¸è…”å…§ç§‘</h2>

        <form id="profile-form">
            <h2 class="text-xl font-semibold text-indigo-700 mb-3 ml-2">A. å€‹äººè³‡è¨Šèˆ‡é†«ç™‚è¯çµ¡</h2>
            <div class="app-card">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">å§“å</label><input type="text" id="p-name" required></div>
                    <div><label class="text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="p-dob"></div>
                </div>
                <div class="list-row bg-indigo-50"><p>é ä¼°å¹´é½¡: <span id="display-age" class="font-bold text-indigo-800">--</span></p></div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 list-row">
                    <div><label class="text-sm font-medium text-gray-700">ç—…æ­·è™Ÿ</label><input type="text" id="p-record"></div>
                    <div><label class="text-sm font-medium text-gray-700">ä¸»æ²»é†«å¸«</label><input type="text" id="p-doc"></div>
                </div>
                <div class="list-row"><label class="text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡é›»è©±</label><input type="tel" id="p-phone"></div>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜å€‹äººè³‡æ–™</button>
        </form>

        <form id="meds-form">
            <h2 class="text-xl font-semibold text-purple-700 mb-3 ml-2">B. è—¥ç‰©è¨ˆç•«</h2>
            <div class="app-card">
                <div class="list-row"><label class="medication-label-strong">é•·æœŸæ§åˆ¶è—¥ç‰© (ä¿é¤Š)</label><input type="text" id="m-main" list="list-main"><select id="f-main" class="mt-2"><option value="">é¸æ“‡é »ç‡</option><option value="åƒ…éœ€è¦æ™‚ä½¿ç”¨">åƒ…éœ€è¦æ™‚ä½¿ç”¨</option><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡">æ¯æ—¥æ—©æ™šå„ä¸€æ¬¡</option><option value="æ¯æ—¥æ—©æ™šå„äºŒæ¬¡">æ¯æ—¥æ—©æ™šå„äºŒæ¬¡</option></select></div>
                <div class="list-row"><label class="medication-label-strong">é¡å¤–ä¿é¤Šè—¥ç‰©</label><input type="text" id="m-extra" list="list-extra"><select id="f-extra" class="mt-2"><option value="æ¯æ—¥ä¸€æ¬¡">æ¯æ—¥ä¸€æ¬¡</option></select></div>
                <div class="list-row"><label class="medication-label-strong">é€Ÿæ•ˆç·©è§£è—¥ç‰© (æ€¥æ•‘)</label><input type="text" id="m-reliever" list="list-reliever"><select id="f-reliever" class="mt-2"><option value="éœ€è¦æ™‚ä½¿ç”¨">éœ€è¦æ™‚ä½¿ç”¨</option><option value="ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º">ä¾ä¸»æ²»é†«å¸«æŒ‡ç¤º</option></select></div>
            </div>
            <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜ç”¨è—¥è¨ˆç•«</button>
        </form>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-orange-600 mb-3 ml-2">C. æ°£å–˜æ§åˆ¶æ¸¬é©— (éå»å››é€±) (ACT)</h2>
            <div class="app-card">
                <div class="act-question"><label class="block text-sm mb-1">1. åœ¨è·å ´æˆ–å­¸æ ¡å—æ°£å–˜å½±éŸ¿å·¥ä½œçš„ç¨‹åº¦ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (ç¸½æ˜¯)</option><option value="2">2åˆ† (å¤§éƒ¨åˆ†æ™‚é–“)</option><option value="3">3åˆ† (æœ‰æ™‚å€™)</option><option value="4">4åˆ† (å¾ˆå°‘)</option><option value="5" selected>5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">2. æ„Ÿè¦ºå‘¼å¸çŸ­ä¿ƒï¼ˆå–˜ä¸éæ°£ï¼‰çš„é »ç‡ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (æ¯å¤©å¤šæ–¼ä¸€æ¬¡)</option><option value="2">2åˆ† (æ¯å¤©ä¸€æ¬¡)</option><option value="3">3åˆ† (æ¯é€± 3-6 æ¬¡)</option><option value="4">4åˆ† (æ¯é€± 1-2 æ¬¡)</option><option value="5" selected>5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">3. å› æ°£å–˜ç—‡ç‹€è€Œåœ¨åŠå¤œé†’ä¾†æˆ–æ—©ä¸Šè¼ƒæ—©é†’ä¾†ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (æ¯é€± 4 æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯é€± 2-3 æ¬¡)</option><option value="3">3åˆ† (æ¯é€±ä¸€æ¬¡)</option><option value="4">4åˆ† (æ¯é€±å°‘æ–¼ä¸€æ¬¡)</option><option value="5" selected>5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">4. ä½¿ç”¨é€Ÿæ•ˆç·©è§£å¸å…¥åŠ‘ï¼ˆæ€¥æ•‘è—¥ï¼‰çš„é »ç‡ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (æ¯å¤© 3 æ¬¡ä»¥ä¸Š)</option><option value="2">2åˆ† (æ¯å¤© 1-2 æ¬¡)</option><option value="3">3åˆ† (æ¯é€± 2-3 æ¬¡)</option><option value="4">4åˆ† (æ¯é€± 1 æ¬¡ä»¥ä¸‹)</option><option value="5" selected>5åˆ† (å®Œå…¨æ²’æœ‰)</option></select></div>
                <div class="act-question"><label class="block text-sm mb-1">5. æ‚¨è‡ªè¦ºéå»å››é€±æ°£å–˜æ§åˆ¶çš„ç‹€æ³ï¼Ÿ</label><select class="act-q"><option value="1">1åˆ† (å¾ˆä¸ç†æƒ³)</option><option value="2">2åˆ† (æ™®é€š)</option><option value="3">3åˆ† (é‚„å¯ä»¥)</option><option value="4">4åˆ† (è‰¯å¥½)</option><option value="5" selected>5åˆ† (å®Œå…¨æ§åˆ¶)</option></select></div>
                <div class="p-4 bg-orange-50 flex justify-between items-center"><span class="font-bold">ACT ç¸½åˆ†ï¼š<span id="act-total">25</span> åˆ†</span><span id="act-status" class="px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white">å®Œå…¨æ§åˆ¶</span></div>
            </div>
            <button id="btn-save-act" class="w-full bg-orange-600 text-white font-bold py-3 rounded-lg shadow-md mb-8">å„²å­˜ ACT åˆ†æ•¸</button>
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 ml-2">D. å€‹äººæœ€ä½³ PEF å€¼ (PB)</h2>
            <div class="app-card p-4">
                <p class="mb-3">ç›®å‰åŸºæº–: <span id="display-pb" class="font-bold text-lg text-blue-600">æœªè¨­å®š</span> L/min</p>
                <div class="flex space-x-3"><input type="number" id="input-pb" placeholder="è¼¸å…¥ PB å€¼" class="flex-grow"><button id="btn-save-pb" type="button" class="bg-blue-600 text-white font-bold px-6 rounded-lg whitespace-nowrap">å„²å­˜</button></div>
            </div>
        </div>

        <div id="log-input-section" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-green-700 mb-3 ml-2">E. è‡ªæˆ‘ç›£æ¸¬ç´€éŒ„ (æ¯æ—¥è¨˜éŒ„)</h2>
            <form id="log-form" class="app-card p-4 space-y-4">
                <div class="bg-blue-50 p-2 rounded text-xs text-blue-800 mb-2">ğŸ’¡ ç³»çµ±å·²ä¾ç›®å‰æ™‚é–“å¼•å°æ‚¨è¼¸å…¥å°æ‡‰æ™‚æ®µã€‚</div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm font-medium">æ—©æ™¨ PEF (AM)</label><input type="number" id="l-am" placeholder="L/min"></div>
                    <div><label class="text-sm font-medium">æ™šé–“ PEF (PM)</label><input type="number" id="l-pm" placeholder="L/min"></div>
                </div>
                <textarea id="l-note" placeholder="å‚™è¨»ç—‡ç‹€..." rows="2"></textarea>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-md">å„²å­˜æ™‚æ®µç´€éŒ„</button>
            </form>
        </div>

        <div id="history-section" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">F. å°–å³°æµé€Ÿ (PEF) è¶¨å‹¢åœ–èˆ‡æ­·å²ç´€éŒ„</h2>
            <div class="app-card"><div id="chart-container"><canvas id="pef-chart"></canvas></div></div>
            <div class="app-card p-4"><select id="history-selector" class="mb-4"><option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option></select><div id="history-detail" class="p-4 bg-gray-50 rounded-lg text-sm hidden"></div></div>
            <button id="export-btn" class="w-full bg-pink-600 text-white font-bold py-3 rounded-lg shadow-md mt-4 transition-colors">å‚³é€æœ€è¿‘ 30 æ—¥æ•¸æ“šè‡³ä¸‰ç¸½</button>
        </div>

        <div id="guide-section" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-3 ml-2">G. æ°£å–˜æƒ¡åŒ–æ‡‰å°æŒ‡å—</h2>
            <div class="app-card p-4 space-y-4">
                <div class="zone-green"><h3 class="font-bold">ğŸŸ¢ ç¶ ç‡ˆå€ â€” æƒ…æ³è‰¯å¥½</h3><p class="text-sm">PEF è®€æ•¸: <span id="range-green">è«‹å…ˆè¨­å®š PB å€¼</span></p><p class="text-xs mt-1 border-t pt-1">å»ºè­°ï¼šæƒ…æ³è‰¯å¥½ï¼Œå¯è€ƒæ…®é™éšæ²»ç™‚ã€‚</p></div>
                <div class="zone-yellow"><h3 class="font-bold">ğŸŸ¡ é»ƒç‡ˆå€ â€” å°å¿ƒæƒ¡åŒ–</h3><p class="text-sm">PEF è®€æ•¸: <span id="range-yellow">è«‹å…ˆè¨­å®š PB å€¼</span></p><p class="text-xs mt-1 border-t pt-1">å»ºè­°ï¼šè¦–ç—‡ç‹€é©æ™‚ä½¿ç”¨æ€¥æ•‘è—¥ç‰©ã€‚</p></div>
                <div class="zone-red"><h3 class="font-bold">ğŸ”´ ç´…ç‡ˆå€ â€” åš´é‡ç™¼ä½œï¼</h3><p class="text-sm">PEF è®€æ•¸: <span id="range-red">è«‹å…ˆè¨­å®š PB å€¼</span></p><p class="text-xs mt-1 border-t pt-1 font-bold">å»ºè­°ï¼šè«‹å„˜é€Ÿå›è¨ºæˆ–æ›æ€¥è¨ºã€‚</p></div>
            </div>
        </div>

        <div class="mt-10">
            <button id="privacy-toggle" class="w-full text-left text-sm text-gray-500 py-2 border-t flex justify-between"><span>éš±ç§æ¬ŠåŠæˆæ¬Šè²æ˜ (é»æ“Šå±•é–‹)</span><span id="toggle-icon">â–¼</span></button>
            <div id="privacy-content" class="collapsible-content text-xs text-gray-600 p-2 leading-relaxed">
                <p>1. æœ¬ç¨‹å¼ç‚ºä¸‰è»ç¸½é†«é™¢èƒ¸è…”å…§ç§‘æä¾›ä¹‹å–®æ©Ÿå·¥å…·ï¼Œæ‰€æœ‰è³‡æ–™çš†å„²å­˜æ–¼æ‚¨ç›®å‰çš„ç€è¦½å™¨æœ¬åœ°ç©ºé–“ (LocalStorage)ã€‚<span class="text-red-600 font-bold">è­¦å‘Šï¼šè‹¥æ‚¨æ¸…é™¤ç€è¦½å™¨å¿«å–æˆ–æ›´æ›æ‰‹æ©Ÿï¼Œè³‡æ–™å°‡æœƒéºå¤±ã€‚</span></p>
                <p class="mt-2">2. åŒ¯å‡ºåŠŸèƒ½åƒ…æœƒæŠ“å–éå» 30 å¤©å…§ä¹‹ç›£æ¸¬æ•¸æ“šé€²è¡Œå‚³è¼¸ï¼Œä»¥ä¿è­·æ•ˆèƒ½èˆ‡éš±ç§ï¼Œå»ºè­°è‡³å°‘æ¯æœˆå‚³è¼¸ä¸€æ¬¡ã€‚</p>
            </div>
        </div>

        <div class="mt-8 p-4 text-center text-xs text-gray-400">æœ€å¾Œæ›´æ–°ï¼š<span id="last-updated">--</span></div>
    </div>

    <datalist id="list-main">
        <option value="å¸å¿…æ“´ SYMBICORT TURBUHALER"><option value="å¸å¿…æ“´ SYMBICORT RAPIHALER"><option value="è‚ºèˆ’å¦ FOSTER MDI INHALER"><option value="è‚ºèˆ’å¦ FOSTER NEXHALER"><option value="æ½¤å¨ƒ RELVAR ELLIPTA"><option value="ä¿è¡›åº· ALVESCO INHALER"><option value="è‚ºæ¨‚å–œ TRELEGY ELLIPTA">
    </datalist>

    <div id="msg" class="fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold hidden" style="z-index: 9999;"></div>

    <script>
        const KEYS = { P: 'asthma_p', PB: 'asthma_pb', M: 'asthma_m', LOGS: 'asthma_logs', ACT: 'asthma_act' };
        const FORM_CFG = { ACTION_URL: 'https://docs.google.com/forms/d/e/YOUR_ID/formResponse', IDS: { NAME: 'entry.1', RECORD: 'entry.2', DOC: 'entry.3', PHONE: 'entry.4', PB: 'entry.5', MEDS: 'entry.6', LOGS: 'entry.7', ACT: 'entry.8' } };
        let pefChart = null; let allLogs = [];

        function showMsg(t, s=true) { const b = document.getElementById('msg'); b.textContent = t; b.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white font-bold ${s?'bg-green-600':'bg-red-600'}`; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'), 3000); }

        // æ™‚é–“å¼•å°é‚è¼¯æ ¸å¿ƒ
        function setupTimeGuidedInputs() {
            const now = new Date();
            const hour = now.getHours();
            const amInput = document.getElementById('l-am');
            const pmInput = document.getElementById('l-pm');

            if (hour < 12) {
                amInput.disabled = false;
                pmInput.disabled = true;
                pmInput.value = ""; // æ¸…ç©ºä¸å¯è¼¸å…¥çš„æ¬„ä½
            } else {
                amInput.disabled = true;
                pmInput.disabled = false;
                amInput.value = "";
            }
        }

        function getCleanPB() { const raw = localStorage.getItem(KEYS.PB); if (!raw) return null; try { const p = JSON.parse(raw); return (typeof p === 'object') ? parseInt(p.personalBestPEF) : parseInt(p); } catch(e) { return parseInt(raw) || null; } }

        function updateRanges(pb) {
            const val = parseInt(pb); if(!val || isNaN(val)) return;
            document.getElementById('display-pb').textContent = val + " L/min";
            document.getElementById('range-green').textContent = `${Math.ceil(val*0.8)} ~ ${val} L/min`;
            document.getElementById('range-yellow').textContent = `${Math.ceil(val*0.5)} ~ ${Math.ceil(val*0.8)-1} L/min`;
            document.getElementById('range-red').textContent = `ä½æ–¼ ${Math.ceil(val*0.5)} L/min`;
            document.getElementById('log-input-section').classList.remove('hidden');
            document.getElementById('history-section').classList.remove('hidden');
            renderChart(val);
        }

        function renderChart(pb) {
            const ctxEl = document.getElementById('pef-chart'); if (!ctxEl) return;
            const daily = {};
            allLogs.forEach(log => {
                const dKey = new Date(log.date || log.timestamp).toLocaleDateString('zh-TW');
                const isAM = new Date(log.date || log.timestamp).getHours() < 12;
                if (!daily[dKey]) daily[dKey] = { am: null, pm: null };
                const av = log.am || log.pefMorning; const pv = log.pm || log.pefEvening;
                if (isAM && av) daily[dKey].am = Math.max(daily[dKey].am || 0, av);
                if (!isAM && pv) daily[dKey].pm = Math.max(daily[dKey].pm || 0, pv);
            });
            const sorted = Object.keys(daily).sort((a,b) => new Date(a) - new Date(b));
            const labels = []; const data = []; const colors = [];
            sorted.forEach(d => {
                const dd = d.split('/')[1] + '/' + d.split('/')[2];
                if (daily[d].am !== null) { labels.push(dd + " AM"); data.push(daily[d].am); colors.push('#34c759'); }
                if (daily[d].pm !== null) { labels.push(dd + " PM"); data.push(daily[d].pm); colors.push('#007aff'); }
            });
            if (pefChart) pefChart.destroy();
            const gT = Math.ceil(pb * 0.8), rT = Math.ceil(pb * 0.5);
            pefChart = new Chart(ctxEl.getContext('2d'), {
                type: 'line', data: { labels: labels, datasets: [{ label: 'PEF è¶¨å‹¢', data: data, borderColor: '#8e8e93', borderWidth: 2, pointBackgroundColor: colors, pointRadius: 5, tension: 0.3, fill: false, spanGaps: true }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, suggestedMax: pb * 1.1, title: { display: true, text: 'PEF (L/min)' } } } },
                plugins: [{ id: 'lines', afterDraw(chart) { const {ctx, chartArea: {left, right}, scales: {y}} = chart; ctx.save(); ctx.setLineDash([6, 4]); ctx.lineWidth = 2; const gy = y.getPixelForValue(gT); ctx.strokeStyle = 'rgba(52, 199, 89, 0.7)'; ctx.beginPath(); ctx.moveTo(left, gy); ctx.lineTo(right, gy); ctx.stroke(); ctx.fillStyle = '#34c759'; ctx.fillText(`ç¶ ç•Œ: ${gT}`, left+5, gy-5); const ry = y.getPixelForValue(rT); ctx.strokeStyle = 'rgba(255, 59, 48, 0.7)'; ctx.beginPath(); ctx.moveTo(left, ry); ctx.lineTo(right, ry); ctx.stroke(); ctx.fillStyle = '#ff3b30'; ctx.fillText(`ç´…ç•Œ: ${rT}`, left+5, ry-5); ctx.restore(); } }]
            });
        }

        function calculateACT() {
            let total = 0; document.querySelectorAll('.act-q').forEach(q => total += parseInt(q.value));
            document.getElementById('act-total').textContent = total; const s = document.getElementById('act-status');
            if (total === 25) { s.textContent = "å®Œå…¨æ§åˆ¶"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white"; }
            else if (total >= 20) { s.textContent = "æ§åˆ¶è‰¯å¥½"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-blue-500 text-white"; }
            else { s.textContent = "æ§åˆ¶ä¸ä½³"; s.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white"; }
            return total;
        }

        document.querySelectorAll('.act-q').forEach(q => q.onchange = calculateACT);
        document.getElementById('btn-save-act').onclick = () => { localStorage.setItem(KEYS.ACT, calculateACT()); showMsg("ACT åˆ†æ•¸å·²å„²å­˜"); };

        document.getElementById('export-btn').onclick = async function() {
            const btn = this; if (btn.disabled) return; btn.disabled = true; btn.textContent = 'å‚³é€ä¸­...'; btn.classList.replace('bg-pink-600', 'bg-gray-400');
            try {
                const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}'), m = JSON.parse(localStorage.getItem(KEYS.M) || '{}'), act = localStorage.getItem(KEYS.ACT) || 'æœªæ¸¬é©—';
                const filteredLogs = allLogs.filter(l => (l.date || l.timestamp) >= (Date.now() - 2592000000));
                const lTxt = filteredLogs.map(l => `${new Date(l.date||l.timestamp).toLocaleString()}: æ—©${l.am||'-'}/æ™š${l.pm||'-'}`).join('\n');
                const formData = new FormData();
                formData.append(FORM_CFG.IDS.NAME, p.name || ''); formData.append(FORM_CFG.IDS.RECORD, p.record || '');
                formData.append(FORM_CFG.IDS.PB, getCleanPB() || ''); formData.append(FORM_CFG.IDS.ACT, act); formData.append(FORM_CFG.IDS.LOGS, lTxt);
                await fetch(FORM_CFG.ACTION_URL, { method: 'POST', mode: 'no-cors', body: formData }); showMsg("æ•¸æ“šå·²å‚³é€è‡³ä¸‰ç¸½", true);
            } catch (err) { showMsg("å‚³é€å¤±æ•—", false); }
            setTimeout(() => { btn.disabled = false; btn.textContent = 'å‚³é€æœ€è¿‘ 30 æ—¥æ•¸æ“šè‡³ä¸‰ç¸½'; btn.classList.replace('bg-gray-400', 'bg-pink-600'); }, 5000);
        };

        function load() {
            const p = JSON.parse(localStorage.getItem(KEYS.P) || '{}');
            if(p.name){ document.getElementById('p-name').value=p.name; document.getElementById('p-dob').value=p.dob || ''; document.getElementById('p-record').value=p.record || ''; document.getElementById('p-doc').value=p.doc || ''; document.getElementById('p-phone').value=p.phone || '0287923311#10121'; if(p.dob) document.getElementById('display-age').textContent = (new Date().getFullYear()-new Date(p.dob).getFullYear())+" æ­²"; }
            const pb = getCleanPB(); if(pb) { document.getElementById('input-pb').value = pb; updateRanges(pb); }
            const m = JSON.parse(localStorage.getItem(KEYS.M) || '{}');
            if(m.main){ const map={'m-main':m.main,'f-main':m.fMain,'m-extra':m.extra,'f-extra':m.fExtra,'m-reliever':m.reliever,'f-reliever':m.fReliever}; for(let id in map){ const el=document.getElementById(id); if(el && map[id]) el.value=map[id]; }}
            allLogs = JSON.parse(localStorage.getItem(KEYS.LOGS) || '[]');
            if(allLogs.length > 0) { const s = document.getElementById('history-selector'); s.innerHTML = '<option value="">-- æŸ¥çœ‹æ­·å²ç´€éŒ„ --</option>'; allLogs.forEach((l, i) => { const o = document.createElement('option'); o.value = i; o.textContent = `${new Date(l.date || l.timestamp).toLocaleString()} (æ—©:${l.am||'-'}/æ™š:${l.pm||'-'})`; s.appendChild(o); }); if(pb) renderChart(pb); }
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            setupTimeGuidedInputs(); // åˆå§‹åŒ–æ™‚é–“å¼•å°
        }

        document.getElementById('profile-form').onsubmit = (e) => { e.preventDefault(); const d = { name:document.getElementById('p-name').value, dob:document.getElementById('p-dob').value, record:document.getElementById('p-record').value, doc:document.getElementById('p-doc').value, phone:document.getElementById('p-phone').value }; localStorage.setItem(KEYS.P, JSON.stringify(d)); showMsg("å€‹äººè³‡æ–™å„²å­˜æˆåŠŸ"); };
        document.getElementById('btn-save-pb').onclick = () => { const v = document.getElementById('input-pb').value; if(!v || v<=0) return showMsg("ç„¡æ•ˆæ•¸å€¼", false); localStorage.setItem(KEYS.PB, JSON.stringify({personalBestPEF: v, updatedAt: Date.now()})); updateRanges(parseInt(v)); showMsg("åŸºæº–å€¼å·²å„²å­˜"); };
        document.getElementById('meds-form').onsubmit = (e) => { e.preventDefault(); const d = { main:document.getElementById('m-main').value, fMain:document.getElementById('f-main').value, extra:document.getElementById('m-extra').value, fExtra:document.getElementById('f-extra').value, reliever:document.getElementById('m-reliever').value, fReliever:document.getElementById('f-reliever').value }; localStorage.setItem(KEYS.M, JSON.stringify(d)); showMsg("ç”¨è—¥è¨ˆç•«å„²å­˜æˆåŠŸ"); };
        document.getElementById('log-form').onsubmit = (e) => { e.preventDefault(); const am = parseInt(document.getElementById('l-am').value), pm = parseInt(document.getElementById('l-pm').value); if(isNaN(am) && isNaN(pm)) return showMsg("è«‹è¼¸å…¥æ•¸å€¼", false); allLogs.unshift({ date:Date.now(), am: isNaN(am)?null:am, pm: isNaN(pm)?null:pm, note:document.getElementById('l-note').value }); localStorage.setItem(KEYS.LOGS, JSON.stringify(allLogs)); location.reload(); };
        document.getElementById('history-selector').onchange = (e) => { const d = document.getElementById('history-detail'); const l = allLogs[e.target.value]; if(!l) { d.classList.add('hidden'); return; } d.innerHTML = `<p><strong>æ™‚é–“ï¼š</strong>${new Date(l.date || l.timestamp).toLocaleString()}</p><p><strong>æ—©æ™¨ï¼š</strong>${l.am||'--'} L/min</p><p><strong>æ™šé–“ï¼š</strong>${l.pm||'--'} L/min</p><p><strong>å‚™è¨»ï¼š</strong>${l.note || 'ç„¡'}</p>`; d.classList.remove('hidden'); };
        document.getElementById('privacy-toggle').onclick = () => { document.getElementById('privacy-content').classList.toggle('expanded'); document.getElementById('toggle-icon').textContent = document.getElementById('privacy-content').classList.contains('expanded') ? 'â–²' : 'â–¼'; };

        window.onload = load;
    </script>
</body>
</html>